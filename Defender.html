<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Defender Idle - Patch 8.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

        body { font-family: 'Rajdhani', sans-serif; background-color: #0f172a; color: white; overflow: hidden; touch-action: none; user-select: none; transition: background-color 2s ease; }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; pointer-events: none; z-index: 10; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #1e293b; } ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        .btn-upgrade:active { transform: scale(0.98); }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px #3b82f6; } 50% { box-shadow: 0 0 25px #60a5fa; } }
        .evolution-notify { animation: pulse-glow 2s infinite; }
        @keyframes damage-flash { 0% { background-color: rgba(239, 68, 68, 0); } 10% { background-color: rgba(239, 68, 68, 0.3); } 100% { background-color: rgba(239, 68, 68, 0); } }
        .damage-effect { animation: damage-flash 0.2s ease-out; }
        .cooldown-overlay { transition: height 0.1s linear; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        @keyframes float-up { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        .loot-popup { animation: float-up 2s forwards; }
        @keyframes skill-ready { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); transform: scale(1); } 50% { box-shadow: 0 0 20px 10px rgba(255, 255, 255, 0); transform: scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); transform: scale(1); } }
        .skill-ready-anim { animation: skill-ready 0.5s ease-out; border-color: #fff !important; }
        .tab-btn { position: relative; padding: 0.25rem 0.75rem; font-size: 0.875rem; font-weight: 700; border-top-left-radius: 0.25rem; border-top-right-radius: 0.25rem; border-bottom-width: 2px; border-color: transparent; color: #94a3b8; background-color: transparent; transition: all 0.2s; }
        .tab-btn:hover { color: white; }
        .tab-btn.active { color: #60a5fa; border-color: #3b82f6; background-color: #1e293b; }
        .tab-notify::after { content: ''; position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background-color: #fbbf24; border-radius: 50%; box-shadow: 0 0 5px #fbbf24; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .black-hole-visual { animation: spin 1s linear infinite; }
        @keyframes laser-fade { 0% { opacity: 1; width: 4px; } 100% { opacity: 0; width: 0px; } }
        .orbital-laser { position: absolute; background: #fff; box-shadow: 0 0 10px #60a5fa, 0 0 20px #3b82f6; animation: laser-fade 0.5s forwards; transform-origin: top center; pointer-events: none; z-index: 5; }
        .dark-matter-text { text-shadow: 0 0 5px #a855f7, 0 0 10px #000; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row">

    <div class="fixed top-0 left-0 w-full h-1 bg-slate-900 z-50 pointer-events-none"><div id="ui-xp-bar" class="h-full bg-cyan-500 shadow-[0_0_10px_#06b6d4] transition-all duration-300" style="width: 0%"></div></div>

    <div class="relative flex-grow h-2/3 md:h-full md:w-3/4 bg-slate-900 overflow-hidden" id="game-container">
        <div id="stars-bg" class="absolute inset-0 z-0 opacity-50 pointer-events-none"></div>
        <div id="damage-overlay" class="absolute inset-0 pointer-events-none z-10"></div>
        <div id="fx-container" class="absolute inset-0 pointer-events-none z-10"></div>
        <canvas id="gameCanvas" class="block w-full h-full cursor-crosshair z-10 relative"></canvas>
        
        <div class="absolute top-4 left-4 flex flex-col gap-1 pointer-events-none select-none z-20">
            <div class="text-[10px] text-cyan-400 font-bold uppercase tracking-widest">Niveau <span id="ui-level">1</span></div>
            <div class="flex items-center gap-4">
                <div class="text-4xl font-bold text-yellow-400 drop-shadow-lg">Or: <span id="ui-gold">0</span></div>
                <button id="btn-pause" onclick="game.togglePause()" class="pointer-events-auto bg-slate-700/80 hover:bg-slate-600 text-white font-bold py-1 px-3 rounded border border-slate-500 backdrop-blur-sm transition text-sm">‚è∏Ô∏è</button>
                <button id="btn-speed" onclick="game.toggleSpeed()" class="pointer-events-auto bg-blue-600/80 hover:bg-blue-500 text-white font-bold py-1 px-3 rounded border border-blue-400 backdrop-blur-sm transition flex items-center gap-1 text-sm"><span>‚è©</span> <span id="ui-speed">x1</span></button>
                <button id="btn-sound" onclick="game.sound.toggle()" class="pointer-events-auto bg-slate-700/80 hover:bg-slate-600 text-white font-bold py-1 px-2 rounded border border-slate-500 backdrop-blur-sm transition text-sm">üîä</button>
            </div>
            <div class="flex items-center gap-2 text-2xl font-bold drop-shadow-lg">
                <span class="text-blue-400">Vague: <span id="ui-wave">1</span></span>
                <button onclick="game.rushWave()" class="pointer-events-auto bg-red-600/80 hover:bg-red-500 text-white text-xs font-bold py-1 px-2 rounded border border-red-400 backdrop-blur-sm transition flex items-center gap-1" title="Appeler la vague suivante (+25% Or)"><span>üî•</span> <span>RUSH</span></button>
                <span class="text-purple-400 text-xl flex items-center gap-1 ml-4"><span>üîÆ</span> <span id="ui-ether-hud">0</span></span>
            </div>
            <div class="text-xl text-slate-300 font-bold flex items-center gap-2">Ennemis: <span id="ui-enemies">0</span><span id="ui-dark-matter" class="hidden text-sm text-purple-300 font-normal ml-2 dark-matter-text">üåë <span id="ui-dm-amount">0</span></span></div>
            <div id="ui-tier-display" class="hidden text-purple-400 font-bold tracking-widest uppercase text-sm mt-1 animate-pulse">√âvolution Tier <span id="ui-tier">1</span></div>
            <div class="flex gap-2 text-lg mt-1 flex-wrap pointer-events-auto">
                <button onclick="document.getElementById('relic-modal').classList.remove('hidden')" class="flex items-center gap-1 text-yellow-500 hover:text-yellow-300 transition font-bold bg-black/40 px-2 py-1 rounded border border-yellow-700">üéí <span id="ui-relic-count">0</span></button>
                <button onclick="document.getElementById('mastery-modal').classList.remove('hidden')" class="flex items-center gap-1 text-cyan-400 hover:text-cyan-300 transition font-bold bg-black/40 px-2 py-1 rounded border border-cyan-700">üéì <span id="ui-mastery-pts">0</span></button>
                <button onclick="document.getElementById('challenges-modal').classList.remove('hidden')" class="flex items-center gap-1 text-red-500 hover:text-red-400 transition font-bold bg-black/40 px-2 py-1 rounded border border-red-700">üíÄ D√©fis</button>
                <button onclick="document.getElementById('achieve-modal').classList.remove('hidden')" class="flex items-center gap-1 text-green-400 hover:text-green-300 transition font-bold bg-black/40 px-2 py-1 rounded border border-green-700">üèÜ</button>
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="text-slate-400 hover:text-white transition bg-black/40 px-2 py-1 rounded border border-slate-600">‚öôÔ∏è</button>
                <button id="btn-dev-menu" onclick="document.getElementById('dev-modal').classList.remove('hidden')" class="hidden text-red-500 hover:text-red-400 transition bg-black/40 px-2 py-1 rounded border border-red-900 font-bold">DEV</button>
            </div>
            <div id="buff-container" class="flex gap-2 mt-1"></div>
            <div id="active-challenge-hud" class="hidden bg-red-900/60 border border-red-500 text-red-200 text-xs px-2 py-1 rounded mt-2 font-bold animate-pulse">D√âFI ACTIF : <span id="challenge-name-hud">NOM</span></div>
        </div>

        <div class="absolute top-4 right-4 flex flex-col items-end gap-2 pointer-events-auto z-20">
            <div class="flex gap-2 mb-2">
                <button onclick="document.getElementById('relic-modal').classList.remove('hidden')" class="bg-slate-800/80 hover:bg-slate-700 text-yellow-500 border border-yellow-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px]"><span class="text-xl">üéí</span><span class="text-[10px] font-bold" id="ui-relic-count">0</span></button>
                <button onclick="document.getElementById('codex-modal').classList.remove('hidden')" class="bg-slate-800/80 hover:bg-slate-700 text-blue-400 border border-blue-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px]"><span class="text-xl">üìñ</span><span class="text-[10px] font-bold">Codex</span></button>
                <button onclick="document.getElementById('mastery-modal').classList.remove('hidden')" class="bg-slate-800/80 hover:bg-slate-700 text-cyan-400 border border-cyan-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px]"><span class="text-xl">üéì</span><span class="text-[10px] font-bold" id="ui-mastery-pts">0</span></button>
                <button onclick="document.getElementById('challenges-modal').classList.remove('hidden')" class="bg-slate-800/80 hover:bg-slate-700 text-red-500 border border-red-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px]"><span class="text-xl">üíÄ</span><span class="text-[10px] font-bold">D√©fis</span></button>
                <button onclick="document.getElementById('achieve-modal').classList.remove('hidden')" class="bg-slate-800/80 hover:bg-slate-700 text-green-400 border border-green-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px]"><span class="text-xl">üèÜ</span><span class="text-[10px] font-bold">Succ√®s</span></button>
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="bg-slate-800/80 hover:bg-slate-700 text-slate-400 border border-slate-600/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px]"><span class="text-xl">‚öôÔ∏è</span><span class="text-[10px] font-bold">Opt.</span></button>
            </div>
            <div id="auto-controls" class="hidden bg-slate-900/80 p-3 rounded-lg border border-slate-700 backdrop-blur-sm w-full">
                <div class="flex items-center justify-between gap-3 mb-2"><span class="text-[10px] font-bold text-slate-400 tracking-wider">AUTO RETRY</span><div class="relative inline-block w-8 align-middle select-none"><input type="checkbox" name="toggle" id="toggle-retry" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300"/><label for="toggle-retry" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label></div></div>
                <div id="auto-buy-container" class="hidden flex items-center justify-between gap-3 opacity-50"><span class="text-[10px] font-bold text-slate-400 tracking-wider">AUTO BUY</span><div class="relative inline-block w-8 align-middle select-none"><input type="checkbox" name="toggle" id="toggle-buy" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300" disabled/><label for="toggle-buy" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label></div></div>
                <div id="auto-status" class="text-[10px] text-green-400 font-mono text-center mt-1 hidden">IA ACTIVE</div>
            </div>
        </div>

        <div id="tutorial-overlay" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-900/90 border-2 border-blue-400 p-6 rounded-xl text-center shadow-2xl z-50 pointer-events-auto max-w-sm"><h2 class="text-2xl font-bold text-white mb-2" id="tuto-title">Bienvenue !</h2><p class="text-blue-100 text-sm mb-4" id="tuto-text">D√©fendez le ch√¢teau.</p><div id="tuto-arrow" class="absolute hidden text-4xl text-yellow-400 tutorial-arrow">‚¨ÖÔ∏è</div><button onclick="game.tutorial.next()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded">Compris</button></div>

        <div class="absolute bottom-16 left-1/2 -translate-x-1/2 flex gap-6 pointer-events-auto z-20">
            <div id="skill-overdrive" onclick="game.activateSkill('overdrive')" class="relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-blue-500 transition shadow-lg group overflow-hidden"><div class="absolute inset-0 flex items-center justify-center text-3xl">‚ö°</div><div class="absolute top-1 right-1 text-[10px] font-bold text-slate-500">Q</div><div id="cd-overdrive" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0"></div><div class="absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-blue-500 pointer-events-none whitespace-nowrap"><strong class="text-blue-400">Surcharge</strong><br>Vitesse x3 pendant 5s.</div></div>
            <div id="skill-nuke" onclick="game.activateSkill('nuke')" class="relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-red-500 transition shadow-lg group overflow-hidden"><div class="absolute inset-0 flex items-center justify-center text-3xl">‚òÑÔ∏è</div><div class="absolute top-1 right-1 text-[10px] font-bold text-slate-500">W</div><div id="cd-nuke" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0"></div><div class="absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-red-500 pointer-events-none whitespace-nowrap"><strong class="text-red-400">M√©t√©ore</strong><br>D√©g√¢ts massifs de zone.</div></div>
            <div id="skill-blackhole" onclick="game.activateSkill('blackhole')" class="relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-purple-500 transition shadow-lg group overflow-hidden"><div class="absolute inset-0 flex items-center justify-center text-3xl">üåÄ</div><div class="absolute top-1 right-1 text-[10px] font-bold text-slate-500">E</div><div id="cd-blackhole" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0"></div><div class="absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-purple-500 pointer-events-none whitespace-nowrap"><strong class="text-purple-400">Trou Noir</strong><br>Aspire et broie les ennemis.</div></div>
        </div>

        <div class="absolute bottom-4 left-4 right-4 md:left-auto md:right-auto md:w-1/2 md:translate-x-1/2 md:left-1/4 flex flex-col gap-1 pointer-events-none z-20">
            <div class="h-2 bg-slate-800 rounded-full border border-slate-600 overflow-hidden relative"><div id="ui-shield-bar" class="h-full bg-blue-400 shadow-[0_0_5px_#60a5fa]" style="width: 0%;"></div></div>
            <div class="h-4 bg-slate-800 rounded-full border border-slate-600 overflow-hidden relative"><div id="ui-health-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500" style="width: 100%;"></div><div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow">PV: <span id="ui-hp-text">100/100</span></div></div>
        </div>

        <!-- Popups -->
        <div id="evo-notification" class="hidden absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-purple-900/90 border-2 border-purple-500 p-6 rounded-xl text-center shadow-[0_0_50px_rgba(168,85,247,0.5)] z-30 evolution-notify pointer-events-none"><h2 class="text-3xl font-bold text-white mb-2">√âVOLUTION !</h2><p class="text-purple-200">Tier Sup√©rieur Atteint</p></div>
        <div id="boss-notification" class="hidden absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-900/90 border-2 border-red-500 p-6 rounded-xl text-center shadow-[0_0_50px_rgba(220,38,38,0.5)] z-30 animate-pulse pointer-events-none"><h2 class="text-4xl font-bold text-red-500 mb-2">‚ö†Ô∏è BOSS ‚ö†Ô∏è</h2><p class="text-red-200">Pr√©parez vos d√©fenses !</p></div>
        <div id="loot-container" class="absolute inset-0 pointer-events-none z-30 overflow-hidden"></div>

        <!-- MODALS -->
        <div id="relic-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4"><div class="w-full max-w-2xl bg-slate-800 border border-yellow-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl"><h2 class="text-2xl text-yellow-400 font-bold uppercase">Collection</h2><button onclick="document.getElementById('relic-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button></div><div id="relic-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto"></div></div></div>
        <div id="codex-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4"><div class="w-full max-w-2xl bg-slate-800 border border-blue-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl"><h2 class="text-2xl text-blue-400 font-bold uppercase">Codex</h2><button onclick="document.getElementById('codex-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button></div><div id="codex-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto"></div></div></div>
        <div id="challenges-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4"><div class="w-full max-w-2xl bg-slate-800 border border-red-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl"><h2 class="text-2xl text-red-500 font-bold uppercase">Mode Hardcore</h2><button onclick="document.getElementById('challenges-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button></div><div class="p-4 overflow-y-auto"><div class="mb-4 bg-purple-900/30 p-3 rounded border border-purple-800 text-center"><div class="text-sm text-purple-300">Mati√®re Noire</div><div class="text-2xl font-bold text-white">üåë <span id="dm-total-display">0</span></div></div><div class="mb-6"><h3 class="text-lg font-bold text-purple-400 mb-2">Recherches Interdites</h3><div id="dm-shop-grid" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div></div><h3 class="text-lg font-bold text-red-400 mb-2">D√©fis Disponibles</h3><div id="challenges-list" class="space-y-2"></div><div class="mt-4 text-center"><button onclick="game.challenges.cancelChallenge()" id="btn-cancel-challenge" class="hidden px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded">Abandonner le d√©fi</button></div></div></div></div>
        <div id="mastery-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4"><div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl"><h2 class="text-2xl text-cyan-400 font-bold uppercase">Ma√Ætrise</h2><button onclick="document.getElementById('mastery-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button></div><div class="p-4"><div class="text-center mb-4 text-white">Points : <span id="mastery-pts-display" class="text-cyan-400 font-bold text-xl">0</span></div><div id="mastery-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div></div></div>
        <div id="achieve-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4"><div class="w-full max-w-2xl bg-slate-800 border border-green-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]"><div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl"><h2 class="text-2xl text-green-400 font-bold uppercase">Succ√®s</h2><button onclick="document.getElementById('achieve-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button></div><div class="p-4 overflow-y-auto"><div class="grid grid-cols-2 gap-2 mb-6 text-sm text-slate-300 font-mono bg-black/20 p-2 rounded"><div>Ennemis: <span id="stat-kills" class="text-white">0</span></div><div>Boss: <span id="stat-bosses" class="text-white">0</span></div><div>Or: <span id="stat-gold" class="text-white">0</span></div><div>Vague: <span id="stat-wave" class="text-white">0</span></div></div><div id="achieve-list" class="space-y-2"></div></div></div></div>
        <div id="settings-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm"><div class="bg-slate-800 border border-slate-500 p-8 rounded-2xl max-w-md w-full shadow-2xl"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl text-white font-bold">Param√®tres</h2><button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button></div><div class="space-y-4"><div class="flex items-center justify-between bg-slate-900 p-3 rounded"><span class="text-sm font-bold text-slate-300">Afficher D√©g√¢ts</span><div class="relative inline-block w-10 align-middle select-none"><input type="checkbox" id="toggle-damage" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300"/><label for="toggle-damage" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label></div></div><div class="flex items-center justify-between bg-slate-900 p-3 rounded"><span class="text-sm font-bold text-slate-300">Afficher Port√©e</span><div class="relative inline-block w-10 align-middle select-none"><input type="checkbox" id="toggle-range" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300"/><label for="toggle-range" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label></div></div><div><label class="block text-xs text-slate-400 mb-1">Sauvegarde</label><textarea id="save-string" class="w-full h-24 bg-black/50 border border-slate-600 rounded p-2 text-xs text-slate-300 break-all" readonly></textarea></div><div class="flex gap-2"><button onclick="game.exportSave()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-bold">COPIER</button><button onclick="game.importSave()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded text-sm font-bold">IMPORTER</button></div><hr class="border-slate-700 my-4"><button onclick="if(confirm('Tout effacer ?')) { localStorage.removeItem(CONFIG.saveKey); location.reload(); }" class="w-full bg-red-900 hover:bg-red-700 text-red-200 py-2 rounded text-sm font-bold border border-red-700">RESET</button></div></div></div>
        
        <div id="dev-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm"><div class="bg-red-950 border border-red-600 p-8 rounded-2xl max-w-md text-center shadow-2xl"><h2 class="text-3xl text-red-500 font-bold mb-4">MODE D√âVELOPPEUR</h2><div class="grid grid-cols-2 gap-4"><button onclick="game.dev.addGold(1000000)" class="px-4 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded shadow">+1M OR üí∞</button><button onclick="game.dev.addEther(10000)" class="px-4 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded shadow">+10k ETHER üîÆ</button><button onclick="game.dev.skipWaves(10)" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow">+10 VAGUES ‚è©</button><button onclick="game.dev.resetCooldowns()" class="px-4 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded shadow">CD RESET ‚ö°</button><button onclick="game.castle.heal(99999999)" class="px-4 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow">HEAL ‚ù§Ô∏è</button><button onclick="document.getElementById('dev-modal').classList.add('hidden')" class="col-span-2 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded mt-4">FERMER</button></div></div></div>
        <div id="offline-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm"><div class="bg-slate-800 border border-yellow-500 p-8 rounded-2xl max-w-md text-center shadow-2xl"><h2 class="text-3xl text-yellow-400 font-bold mb-4">Retour</h2><p class="text-slate-300 mb-6">Gain Hors-Ligne</p><div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-6"><div class="text-4xl font-bold text-white">+<span id="offline-gold">0</span> üí∞</div></div><button onclick="document.getElementById('offline-modal').classList.add('hidden')" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg transition">R√©cup√©rer</button></div></div>

        <div id="game-over-screen" class="hidden absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-40 backdrop-blur-md overflow-y-auto py-10">
            <div class="w-full max-w-2xl px-4 flex flex-col items-center">
                <h1 class="text-5xl font-bold text-red-500 mb-2 uppercase">D√©faite</h1>
                <p class="text-xl text-slate-300 mb-4">Vague : <span id="go-wave" class="text-white font-bold">0</span></p>
                <div id="auto-retry-timer" class="text-yellow-400 font-mono text-lg mb-4 hidden">Auto-Retry : <span id="retry-countdown">3</span>s...</div>
                <div class="flex gap-4 mb-8 w-full justify-center">
                    <div class="bg-purple-900/30 border border-purple-500/50 p-4 rounded-xl flex items-center gap-4 flex-1 justify-center"><span class="text-4xl">üîÆ</span><div><div class="text-sm text-purple-300 uppercase">Ether</div><div class="text-3xl font-bold text-white">+<span id="go-ether-gain">0</span></div></div></div>
                    <div id="go-dm-gain-box" class="hidden bg-black/60 border border-purple-900 p-4 rounded-xl flex items-center gap-4 flex-1 justify-center"><span class="text-4xl">üåë</span><div><div class="text-sm text-purple-300 uppercase">Mati√®re</div><div class="text-3xl font-bold text-white">+<span id="go-dm-gain">0</span></div></div></div>
                </div>
                <div class="w-full bg-slate-800 rounded-xl border border-slate-700 p-6 shadow-2xl mb-8">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4"><h2 class="text-2xl font-bold text-purple-400 uppercase">Boutique Ancestrale</h2><div class="text-xl font-bold text-white bg-purple-900/50 px-3 py-1 rounded">Ether: <span id="shop-ether-total">0</span> üîÆ</div></div>
                    <div id="meta-upgrade-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <button onclick="game.manualRestart()" class="px-12 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow transition text-2xl transform hover:scale-105">COMBATTRE</button>
            </div>
        </div>

        <div class="scanlines"></div>
    </div>

    <!-- Panneau d'Am√©liorations -->
    <div class="h-1/3 md:h-full md:w-1/4 bg-slate-800 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col shadow-2xl z-20">
        <div class="p-4 bg-slate-900 border-b border-slate-700 shadow-md">
            <h2 class="text-xl font-bold text-blue-400 uppercase tracking-wider text-center mb-2">Laboratoire</h2>
            <div class="flex gap-1 justify-center">
                <button id="tab-0" onclick="game.switchTab(0)" class="tab-btn active">Attaque</button>
                <button id="tab-1" onclick="game.switchTab(1)" class="tab-btn">D√©fense</button>
                <button id="tab-2" onclick="game.switchTab(2)" class="tab-btn">Tech</button>
            </div>
            <!-- Bulk Buy Toggle -->
            <div class="flex justify-end mt-2">
                 <button id="btn-bulk-buy" onclick="game.toggleBulk()" class="text-xs font-bold bg-slate-800 px-2 py-1 rounded border border-slate-600 hover:border-white transition">ACHAT: x1</button>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto p-2 space-y-2" id="upgrade-list"></div>
        <div id="lab-footer" onclick="game.triggerDevSecret()" class="p-2 text-center text-xs text-slate-500 bg-slate-900 cursor-pointer select-none">Cliquez sur les Runes au sol pour les bonus !</div>
    </div>

<script>
/** CONFIG & HELPERS **/
const CONFIG = { baseEnemySpeed: 0.8, baseEnemyHp: 10, enemySpawnRate: 1500, saveKey: 'defenderIdleSave_Patch81_v1', evolutionInterval: 10, evolutionMultiplier: 1.5 };
const MathUtils = { lerp: (a, b, t) => a + (b - a) * t, dist: (x1, y1, x2, y2) => Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2), randomRange: (min, max) => Math.random() * (max - min) + min };
function formatNumber(num) {
    if (num >= 1e18) return (num / 1e18).toFixed(2) + 'Qi';
    if (num >= 1e15) return (num / 1e15).toFixed(2) + 'Qa';
    if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
    if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
    if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
    if (num >= 1e3) return (num / 1e3).toFixed(1) + 'k';
    return Math.floor(num).toString();
}

const SOUND_DB = { shoot: { type: 'square', freq: 400, decay: 0.1, vol: 0.1 }, hit: { type: 'sawtooth', freq: 100, decay: 0.1, vol: 0.1 }, coin: { type: 'sine', freq: 800, decay: 0.2, vol: 0.05, slide: true }, levelup: { type: 'triangle', freq: 600, decay: 0.5, vol: 0.2, melody: true }, gameover: { type: 'sawtooth', freq: 150, decay: 1.0, vol: 0.3, slideDown: true } };
const CHALLENGES = [ { id: 'noregen', name: 'Sang Froid', desc: 'R√©g√©n√©ration d√©sactiv√©e.', diff: 2 }, { id: 'speed', name: 'Blitzkrieg', desc: 'Ennemis +100% Vitesse.', diff: 3 }, { id: 'glass', name: 'Mur de Verre', desc: 'PV Max r√©duits de 90%.', diff: 4 }, { id: 'horde', name: 'La Horde', desc: 'Ennemis x3.', diff: 5 } ];
const DARK_MATTER_UPGRADES = [ { id: 'berserk', name: 'Berserk', desc: '+1% D√©g√¢ts / 1% PV perdus', max: 1, cost: 5 }, { id: 'siphon', name: 'Siphon d\'√Çme', desc: 'Chance d\'Ether sur ennemis normaux', max: 5, cost: 10 }, { id: 'overlord', name: 'Suzerain', desc: 'Drone attaque 2x plus vite', max: 3, cost: 8 } ];
const RELIC_DB = [ { id: 'dmg_boost', name: 'Lame du Roi', icon: 'üó°Ô∏è', desc: '+20% D√©g√¢ts globaux', effect: (g) => g.relicMults.damage += 0.2 }, { id: 'gold_boost', name: 'Pi√®ce Maudite', icon: 'ü™ô', desc: '+25% Gain d\'or', effect: (g) => g.relicMults.gold += 0.25 }, { id: 'speed_boost', name: 'Bottes de Vent', icon: 'üí®', desc: '+15% Vitesse de tir', effect: (g) => g.relicMults.speed += 0.15 }, { id: 'crit_boost', name: '≈íil de Faucon', icon: 'üëÅÔ∏è', desc: '+10% Chance critique', effect: (g) => g.relicMults.critChance += 10 }, { id: 'hp_boost', name: 'C≈ìur de Titan', icon: '‚ù§Ô∏è', desc: '+30% PV Max', effect: (g) => g.relicMults.health += 0.3 }, { id: 'skill_cd', name: 'Sablier Ancien', icon: '‚è≥', desc: '-10% Temps de recharge', effect: (g) => g.relicMults.cooldown += 0.1 } ];
const ACHIEVEMENTS_DB = [ { id: 'kill_100', name: 'Chasseur', desc: 'Tuer 100 ennemis', cond: (s) => s.kills >= 100, reward: 5 }, { id: 'kill_1000', name: 'Exterminateur', desc: 'Tuer 1000 ennemis', cond: (s) => s.kills >= 1000, reward: 25 }, { id: 'kill_5000', name: 'L√©gende', desc: 'Tuer 5000 ennemis', cond: (s) => s.kills >= 5000, reward: 100 }, { id: 'boss_5', name: 'Tueur de Rois', desc: 'Vaincre 5 Boss', cond: (s) => s.bosses >= 5, reward: 15 }, { id: 'boss_50', name: 'D√©icide', desc: 'Vaincre 50 Boss', cond: (s) => s.bosses >= 50, reward: 100 }, { id: 'wave_20', name: 'Survivant', desc: 'Atteindre la vague 20', cond: (s) => s.maxWave >= 20, reward: 10 }, { id: 'wave_50', name: 'V√©t√©ran', desc: 'Atteindre la vague 50', cond: (s) => s.maxWave >= 50, reward: 50 }, { id: 'gold_10k', name: 'Riche', desc: 'Gagner 10k Or (Total)', cond: (s) => s.totalGold >= 10000, reward: 20 } ];
const ENEMY_TYPES = { 
    NORMAL: { color: 'hsl(0, 70%, 60%)', hpMult: 1, speedMult: 1, scale: 1, name: 'Normal', desc: 'Ennemi de base.' }, 
    SPEEDY: { color: '#fbbf24', hpMult: 0.6, speedMult: 1.8, scale: 0.8, name: 'Speedy', desc: 'Rapide mais fragile.' }, 
    TANK: { color: '#64748b', hpMult: 2.5, speedMult: 0.6, scale: 1.4, name: 'Tank', desc: 'Lent et tr√®s r√©sistant.' }, 
    BOSS: { color: '#ef4444', hpMult: 20, speedMult: 0.4, scale: 2.5, name: 'BOSS', desc: 'Le chef de la vague.' }, 
    HEALER: { color: '#4ade80', hpMult: 1.5, speedMult: 0.7, scale: 1.1, name: 'Healer', desc: 'Soigne les alli√©s proches.' }, 
    SPLITTER: { color: '#a855f7', hpMult: 1.2, speedMult: 0.8, scale: 1.3, name: 'Splitter', desc: 'Se divise en 2 √† la mort.' }, 
    MINI: { color: '#d8b4fe', hpMult: 0.4, speedMult: 1.2, scale: 0.6, name: 'Rejeton', desc: 'Issu d\'un Splitter.' }, 
    THIEF: { color: '#94a3b8', hpMult: 0.8, speedMult: 2.5, scale: 0.9, name: 'Pillard', desc: 'Vole votre or et s\'enfuit.' }, 
    PHANTOM: { color: '#ffffff', hpMult: 0.8, speedMult: 1.0, scale: 1.0, name: 'Fant√¥me', desc: 'Se t√©l√©porte vers l\'avant.' } 
};
const RUNE_TYPES = [ { id: 'rage', name: 'Rage', color: '#ef4444', icon: 'üî•', duration: 10000, desc: 'Vitesse x2' }, { id: 'midas', name: 'Midas', color: '#fbbf24', icon: 'üí∞', duration: 10000, desc: 'Or x5' }, { id: 'heal', name: 'Soin', color: '#4ade80', icon: 'üíö', duration: 0, desc: '+25% PV', instant: true } ];

class SoundManager {
    constructor() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); this.muted = false; this.masterGain = this.ctx.createGain(); this.masterGain.connect(this.ctx.destination); }
    play(id) { if(this.muted || !this.ctx) return; const s = SOUND_DB[id]; if(!s) return; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.type = s.type; osc.frequency.setValueAtTime(s.freq, this.ctx.currentTime); if(s.slide) osc.frequency.exponentialRampToValueAtTime(s.freq * 2, this.ctx.currentTime + s.decay); if(s.slideDown) osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + s.decay); gain.gain.setValueAtTime(s.vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + s.decay); osc.connect(gain); gain.connect(this.masterGain); osc.start(); osc.stop(this.ctx.currentTime + s.decay); if(s.melody) { setTimeout(() => { const osc2 = this.ctx.createOscillator(); const gain2 = this.ctx.createGain(); osc2.frequency.setValueAtTime(s.freq * 1.5, this.ctx.currentTime); gain2.gain.setValueAtTime(s.vol, this.ctx.currentTime); gain2.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + s.decay); osc2.connect(gain2); gain2.connect(this.masterGain); osc2.start(); osc2.stop(this.ctx.currentTime + s.decay); }, 150); } }
    toggle() { this.muted = !this.muted; const btn = document.getElementById('btn-sound'); if(btn) btn.innerText = this.muted ? 'üîá' : 'üîä'; if(!this.muted && this.ctx.state === 'suspended') this.ctx.resume(); }
}
class TutorialManager {
    constructor() { this.step = 0; }
    check(gold) {
        const overlay = document.getElementById('tutorial-overlay'); if(!overlay) return;
        const title = document.getElementById('tuto-title'); const text = document.getElementById('tuto-text'); const arrow = document.getElementById('tuto-arrow');
        if (this.step === 0) { overlay.classList.remove('hidden'); title.innerText = "Bienvenue !"; text.innerText = "D√©fendez le ch√¢teau contre les vagues ennemies."; arrow.classList.add('hidden'); } 
        else if (this.step === 1 && gold >= 10) { overlay.classList.remove('hidden'); overlay.style.top = '60%'; overlay.style.left = '80%'; title.innerText = "Am√©lioration"; text.innerText = "Achetez 'D√©g√¢ts' pour survivre."; arrow.classList.remove('hidden'); arrow.style.transform = 'rotate(90deg)'; arrow.style.right = '-40px'; }
    }
    next() { this.step++; document.getElementById('tutorial-overlay').classList.add('hidden'); }
}
class FloatingText { constructor(x, y, text, color, size = 20) { this.x = x; this.y = y; this.text = text; this.color = color; this.size = size; this.life = 1.0; this.vy = -1; } update(dt) { this.y += this.vy * (dt / 16); this.life -= 0.02 * (dt / 16); } draw(ctx) { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color; ctx.font = `bold ${this.size}px Rajdhani`; ctx.fillText(this.text, this.x, this.y); ctx.globalAlpha = 1.0; } }
class Particle { constructor(x, y, color) { this.x = x; this.y = y; this.color = color; const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 3 + 1; this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed; this.life = 1.0; this.decay = Math.random() * 0.03 + 0.02; } update(dt) { const timeScale = dt / 16; this.x += this.vx * timeScale; this.y += this.vy * timeScale; this.life -= this.decay * timeScale; } draw(ctx) { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0; } }
class Rune { constructor(x, y) { this.x = x; this.y = y; this.type = RUNE_TYPES[Math.floor(Math.random() * RUNE_TYPES.length)]; this.life = 10000; this.scale = 1; this.scaleDir = 1; } update(dt) { this.life -= dt; this.scale += 0.01 * this.scaleDir; if(this.scale > 1.2 || this.scale < 0.8) this.scaleDir *= -1; if(game.drone && game.drone.canCollect) { const d = MathUtils.dist(this.x, this.y, game.drone.x, game.drone.y); if(d < 100) { this.x = MathUtils.lerp(this.x, game.drone.x, 0.1); this.y = MathUtils.lerp(this.y, game.drone.y, 0.1); if(d < 20) { game.activateRune(this); this.life = 0; } } } } draw(ctx) { ctx.save(); ctx.translate(this.x, this.y); ctx.scale(this.scale, this.scale); ctx.fillStyle = this.type.color; ctx.shadowColor = this.type.color; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#fff'; ctx.font = '16px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(this.type.icon, 0, 0); ctx.restore(); } }
class Projectile { constructor(x, y, target, damage, speed, color, tier, isMulti, isCrit, isSuperCrit, effects, props) { this.x = x; this.y = y; this.target = target; this.damage = damage; this.speed = speed; this.color = color; this.active = true; this.tier = tier; this.isMulti = isMulti; this.isCrit = isCrit; this.isSuperCrit = isSuperCrit; this.effects = effects || {}; this.bounceCount = (props && props.bounce) || 0; this.blastRadius = (props && props.blast) || 0; this.leech = (props && props.leech) || 0; this.stasisChance = (props && props.stasis) || 0; } update(dt) { if (!this.target || this.target.hp <= 0) { if(this.bounceCount <= 0 && this.blastRadius <= 0) { this.active = false; return; } } if(this.target && this.target.hp > 0) { const angle = Math.atan2(this.target.y - this.y, this.target.x - this.x); const moveStep = this.speed * (dt / 16); this.x += Math.cos(angle) * moveStep; this.y += Math.sin(angle) * moveStep; if (MathUtils.dist(this.x, this.y, this.target.x, this.target.y) < this.target.radius + 15) this.hit(this.target); } else this.active = false; } hit(target) { target.takeDamage(this.damage, this.isCrit, this.isSuperCrit); if (this.effects.ice) target.applyStatus('ice', 0.6, 2000); if (this.effects.poison) target.applyStatus('poison', this.damage * 0.2, 3000); if (this.stasisChance > 0 && Math.random() < this.stasisChance) target.applyStatus('stasis', 0, 2000); if (this.leech > 0 && target.hp <= 0) game.castle.heal(this.leech); if (this.blastRadius > 0) this.explode(); if (this.bounceCount > 0) this.bounce(target); else if (this.blastRadius <= 0) this.active = false; if(this.bounceCount <= 0) this.active = false; if(game.particles.length < 50) for(let i=0; i<3; i++) game.particles.push(new Particle(this.x, this.y, this.color)); } explode() { game.enemies.forEach(e => { if (e.hp > 0 && MathUtils.dist(this.x, this.y, e.x, e.y) < this.blastRadius) e.takeDamage(this.damage * 0.5, false, false, true); }); const ripple = new Particle(this.x, this.y, 'rgba(255,200,0,0.5)'); ripple.draw = function(ctx) { ctx.strokeStyle = this.color; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(this.x, this.y, (1 - this.life) * 50, 0, Math.PI*2); ctx.stroke(); }; game.particles.push(ripple); } bounce(lastTarget) { let nearest = null; let minDist = 250; for (const e of game.enemies) { if (e !== lastTarget && e.hp > 0) { const d = MathUtils.dist(this.x, this.y, e.x, e.y); if (d < minDist) { minDist = d; nearest = e; } } } if (nearest) { this.bounceCount--; this.target = nearest; const line = new Particle(this.x, this.y, this.color); line.tx = nearest.x; line.ty = nearest.y; line.life = 0.5; line.draw = function(ctx) { ctx.globalAlpha = this.life; ctx.strokeStyle = this.color; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.tx, this.ty); ctx.stroke(); }; game.particles.push(line); } else this.bounceCount = 0; } draw(ctx) { ctx.fillStyle = this.color; ctx.beginPath(); const size = this.isSuperCrit ? 10 : (this.isCrit ? 8 : (this.isMulti ? 3 : 5)); if (this.tier >= 3) { ctx.moveTo(this.x, this.y - size); ctx.lineTo(this.x + size, this.y); ctx.lineTo(this.x, this.y + size); ctx.lineTo(this.x - size, this.y); } else ctx.arc(this.x, this.y, size, 0, Math.PI * 2); ctx.closePath(); ctx.fill(); ctx.shadowBlur = this.isSuperCrit ? 20 : (this.isCrit ? 15 : 10); ctx.shadowColor = this.color; ctx.fill(); ctx.shadowBlur = 0; } }

class Turret { 
    constructor(id, offsetIndex, total, type = 'NORMAL') { 
        this.id = id; this.offsetIndex = offsetIndex; this.total = total; this.type = type;
        this.x = 0; this.y = 0; this.lastShotTime = 0; 
        this.damageMultiplier = 0.25; this.rangeMult = 1.0; this.fireRateMult = 1.0; 
        if(type === 'ARTILLERY') { this.damageMultiplier = 0.8; this.fireRateMult = 0.3; this.rangeMult = 1.5; } 
        if(type === 'ROCKET') { this.damageMultiplier = 0.5; this.fireRateMult = 0.5; this.rangeMult = 1.2; } 
        if(type === 'TESLA') { this.damageMultiplier = 0.2; this.fireRateMult = 1.5; this.rangeMult = 0.8; } 
    } 
    update(dt, gameTime) { 
        const slots = [{x: -40, y: -60}, {x: 40, y: -60}, {x: -40, y: 60}, {x: 40, y: 60}]; 
        let pos; 
        if(this.type === 'ARTILLERY') { this.x = game.castle.x; this.y = game.castle.y - 70; } 
        else if(this.type === 'ROCKET') { this.x = game.castle.x - 50; this.y = game.castle.y; } 
        else if(this.type === 'TESLA') { this.x = game.castle.x + 50; this.y = game.castle.y; } 
        else {
            if(this.id < 4) { pos = slots[this.id]; this.x = game.castle.x + pos.x; this.y = game.castle.y + pos.y; } 
            else { const orbitSpeed = 0.001; const angle = (gameTime * orbitSpeed) + (this.id * (Math.PI/2)); const orbitRadius = 100; this.x = game.castle.x + Math.cos(angle) * orbitRadius; this.y = game.castle.y + Math.sin(angle) * orbitRadius; } 
        }

        const baseFireRate = game.skills.isActive('overdrive') || game.activeBuffs['rage'] > 0 ? game.currentFireRate / 3 : game.currentFireRate; 
        const fireInterval = baseFireRate / this.fireRateMult; 
        if (gameTime - this.lastShotTime > fireInterval) { const range = game.currentRange * this.rangeMult; const target = game.findTarget(this.x, this.y, range); if (target) { this.shoot(target); this.lastShotTime = gameTime; } } 
    } 
    shoot(target) { 
        const dmg = Math.max(1, Math.floor(game.currentDamage * this.damageMultiplier)); 
        let speed = 15; let color = '#a5b4fc'; let props = {...game.currentProps}; 
        if(this.type === 'ARTILLERY') { speed = 8; color = '#fca5a5'; props.blast = 100; } 
        if(this.type === 'ROCKET') { speed = 12; color = '#fdba74'; } 
        if(this.type === 'TESLA') { speed = 25; color = '#67e8f9'; props.bounce = (props.bounce || 0) + 3; } 
        game.projectiles.push(new Projectile(this.x, this.y, target, dmg, speed, color, 1, false, false, false, game.currentEffects, props)); 
    } 
    draw(ctx) { 
        ctx.save(); ctx.translate(this.x, this.y); 
        const target = game.findTarget(this.x, this.y, game.currentRange * this.rangeMult); 
        if (target) ctx.rotate(Math.atan2(target.y - this.y, target.x - this.x)); 
        if(this.type === 'ARTILLERY') { ctx.fillStyle = '#7f1d1d'; ctx.fillRect(0, -8, 24, 16); } 
        else if(this.type === 'ROCKET') { ctx.fillStyle = '#c2410c'; ctx.fillRect(0, -6, 20, 12); } 
        else if(this.type === 'TESLA') { ctx.fillStyle = '#0e7490'; ctx.fillRect(0, -4, 15, 8); ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.strokeStyle = '#67e8f9'; ctx.stroke(); } 
        else { ctx.fillStyle = '#6366f1'; ctx.fillRect(0, -6, 20, 12); } 
        ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fillStyle = '#312e81'; ctx.fill(); ctx.restore(); 
    } 
}

class Drone { constructor() { this.angle = 0; this.radius = 60; this.x = 0; this.y = 0; this.lastShotTime = 0; this.canCollect = false; this.fireRate = 500; this.damage = 10; } update(dt, gameTime) { this.angle += 0.02 * (dt/16); this.x = 100 + Math.cos(this.angle) * this.radius; this.y = game.height/2 + Math.sin(this.angle) * this.radius; const speedBoost = game.stats.mastery['drone_spd'] ? (1 + game.stats.mastery['drone_spd'] * 0.1) : 1; const overlord = game.challenges.dmTech['overlord'] ? 2 : 1; if(gameTime - this.lastShotTime > (this.fireRate / (speedBoost * overlord))) { const target = game.findTarget(this.x, this.y, 400); if(target) { const dmg = Math.max(1, Math.floor(game.currentDamage * 0.1)); game.projectiles.push(new Projectile(this.x, this.y, target, dmg, 20, '#06b6d4', 1)); game.sound.play('shoot'); this.lastShotTime = gameTime; } } } draw(ctx) { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle * 2); ctx.fillStyle = '#06b6d4'; ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(-5, 5); ctx.lineTo(-5, -5); ctx.fill(); ctx.shadowColor = '#06b6d4'; ctx.shadowBlur = 10; ctx.beginPath(); ctx.arc(0,0,3,0,Math.PI*2); ctx.fill(); ctx.restore(); } }
class Enemy {
    constructor(wave, typeKey = 'NORMAL', x, y) { this.type = ENEMY_TYPES[typeKey]; this.typeKey = typeKey; this.radius = 12 * this.type.scale; this.isElite = Math.random() < 0.05; this.x = x || game.width + 50; this.y = y || MathUtils.randomRange(game.height * 0.2, game.height * 0.8); const diffMult = 1 + (wave * 0.20); const hpMod = game.activeChallenge && game.activeChallenge.id === 'glass' ? 0.1 : 1; const speedMod = game.activeChallenge && game.activeChallenge.id === 'speed' ? 2 : 1; this.maxHp = Math.floor(CONFIG.baseEnemyHp * diffMult * this.type.hpMult * (this.isElite ? 5 : 1)); this.hp = this.maxHp; this.baseSpeed = CONFIG.baseEnemySpeed * (1 + wave * 0.03) * this.type.speedMult * speedMod; this.damage = (5 + Math.floor(wave * 0.8)) * (typeKey === 'BOSS' ? 5 : 1); const baseGold = Math.max(1, Math.floor(2 * (1 + wave * 0.12))); const goldMult = game.metaUpgrades.getEffectValue('goldMult') * (1 + (game.relicMults.gold || 0)); this.goldValue = Math.floor(baseGold * goldMult * (typeKey === 'BOSS' ? 10 : (typeKey === 'TANK' ? 2 : 1)) * (this.isElite ? 10 : 1)); if(game.activeBuffs['midas'] > 0) this.goldValue *= 5; this.color = typeKey === 'NORMAL' ? `hsl(${(wave * 15) % 360}, 70%, 60%)` : this.type.color; this.status = { iceTimer: 0, poisonTimer: 0, poisonDmg: 0, stasisTimer: 0 }; this.state = 'APPROACH'; this.teleportTimer = 0; this.thermalShockCooldown = 0; }
    applyStatus(type, power, duration) { if (type === 'ice') this.status.iceTimer = duration; if (type === 'poison') { this.status.poisonTimer = duration; this.status.poisonDmg = power; } if (type === 'stasis') this.status.stasisTimer = duration; }
    update(dt) { 
        if (game.skills.isActive('blackhole')) { const cx = game.width * 0.7; const cy = game.height / 2; const dist = MathUtils.dist(this.x, this.y, cx, cy); if (dist > 20) { this.x = MathUtils.lerp(this.x, cx, 0.05); this.y = MathUtils.lerp(this.y, cy, 0.05); } this.takeDamage(game.currentDamage * 0.1 * (dt/16), false, false, true); return; } 
        if (this.status.stasisTimer > 0) { this.status.stasisTimer -= dt * 16; return; }
        if (this.status.iceTimer > 0 && this.status.poisonTimer > 0 && this.thermalShockCooldown <= 0) { this.takeDamage(game.currentDamage * 2, true, false, false); game.floatingTexts.push(new FloatingText(this.x, this.y - 40, "CHOC THERMIQUE!", "#f97316", 24)); this.thermalShockCooldown = 1000; } if(this.thermalShockCooldown > 0) this.thermalShockCooldown -= dt;
        let currentSpeed = this.baseSpeed;
        if (this.status.iceTimer > 0) { this.status.iceTimer -= dt * 16; currentSpeed *= 0.6; } 
        if (this.status.poisonTimer > 0) { this.status.poisonTimer -= dt * 16; const tickDmg = (this.status.poisonDmg / 60) * (dt / 16); this.takeDamage(tickDmg, false, false, true); } 
        
        const targetX = game.castle.x; const targetY = game.height / 2; const dist = MathUtils.dist(this.x, this.y, targetX, targetY);
        if (dist > 80) { const angle = Math.atan2(targetY - this.y, targetX - this.x); const moveStep = currentSpeed * (dt / 16); this.x += Math.cos(angle) * moveStep; this.y += Math.sin(angle) * moveStep; } else { game.castle.takeDamage((this.damage * 0.05) * (dt / 16)); }
        if (this.typeKey === 'PHANTOM') { this.teleportTimer += dt; if(this.teleportTimer > 2000) { this.x -= 100; game.particles.push(new Particle(this.x + 100, this.y, '#fff')); this.teleportTimer = 0; } } 
        if(this.typeKey === 'THIEF') { if(this.state === 'APPROACH') { if(dist <= 90) { this.state = 'FLEE'; const stolen = Math.floor(game.gold * 0.1); game.gold -= stolen; game.floatingTexts.push(new FloatingText(this.x, this.y - 30, `-${stolen} üí∞`, '#ef4444', 20)); } } else if(this.state === 'FLEE') { this.x += currentSpeed * 1.5 * (dt/16); if(this.x > game.width + 100) this.hp = 0; } return; }
        if (this.typeKey === 'HEALER') { if (Math.random() < 0.05) { game.enemies.forEach(e => { if (e !== this && e.hp < e.maxHp && MathUtils.dist(this.x, this.y, e.x, e.y) < 150) { e.hp = Math.min(e.maxHp, e.hp + (e.maxHp * 0.05)); const beam = new Particle(this.x, this.y, '#4ade80'); beam.tx = e.x; beam.ty = e.y; beam.life = 0.5; beam.draw = function(ctx) { ctx.globalAlpha = this.life; ctx.strokeStyle = '#4ade80'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.tx, this.ty); ctx.stroke(); }; game.particles.push(beam); } }); } }
    }
    takeDamage(amount, isCrit, isSuperCrit, silent = false) { if(game.challenges.dmTech['berserk']) { const missingHpPct = 1 - (game.castle.hp / game.castle.maxHp); if(missingHpPct > 0) amount *= (1 + missingHpPct); } this.hp -= amount; if (!silent && game.settings.showDamageText) game.floatingTexts.push(new FloatingText(this.x, this.y - 20, formatNumber(amount), isSuperCrit ? '#d946ef' : (isCrit ? '#ef4444' : '#fff'), isSuperCrit ? 40 : (isCrit ? 30 : 20))); if(!silent) game.sound.play('hit'); if (this.hp <= 0) { if(this.state !== 'FLEE' || this.hp <= 0) game.addGold(this.goldValue + (game.isRushBonus ? Math.floor(this.goldValue * 0.25) : 0)); game.stats.registerKill(this.typeKey === 'BOSS', this.x, this.y); game.stats.registerEnemySeen(this.typeKey); if(game.challenges.dmTech['siphon'] && this.typeKey !== 'BOSS' && Math.random() < 0.01) game.ether++; if (this.typeKey === 'SPLITTER') { game.enemies.push(new Enemy(game.wave, 'MINI', this.x, this.y - 10)); game.enemies.push(new Enemy(game.wave, 'MINI', this.x, this.y + 10)); } if (Math.random() < 0.05) game.runes.push(new Rune(this.x, this.y)); if (!silent && game.settings.showDamageText) game.floatingTexts.push(new FloatingText(this.x, this.y - 40, `+${formatNumber(this.goldValue)}`, '#fbbf24', 16)); game.sound.play('coin'); if(this.typeKey === 'BOSS') { for(let i=0; i<20; i++) game.particles.push(new Particle(this.x, this.y, '#ef4444')); game.tryDropRelic(); } else if(game.particles.length < 50) { for(let i=0; i<3; i++) game.particles.push(new Particle(this.x, this.y, this.color)); } } }
    draw(ctx) { ctx.save(); ctx.translate(this.x, this.y); const angle = Math.atan2(game.height/2 - this.y, game.castle.x - this.x); ctx.rotate(angle); ctx.fillStyle = this.status.stasisTimer > 0 ? '#1e40af' : (this.status.iceTimer > 0 ? '#38bdf8' : (this.status.poisonTimer > 0 ? '#4ade80' : (this.typeKey === 'THIEF' ? '#94a3b8' : (this.typeKey === 'PHANTOM' ? '#fff' : this.color)))); ctx.beginPath(); if (this.typeKey === 'PHANTOM') { ctx.globalAlpha = 0.6; ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0; } else if (this.type.scale > 2) { ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke(); ctx.fill(); } else if (this.type.scale > 1.2) { ctx.fillRect(-this.radius, -this.radius, this.radius*2, this.radius*2); } else { ctx.moveTo(this.radius, 0); ctx.lineTo(-this.radius, -this.radius); ctx.lineTo(-this.radius, this.radius); ctx.fill(); } if (this.isElite) { ctx.shadowBlur = 10; ctx.shadowColor = '#facc15'; ctx.strokeStyle = '#facc15'; ctx.lineWidth = 2; ctx.stroke(); ctx.shadowBlur = 0; } ctx.restore(); const hpPercent = Math.max(0, this.hp / this.maxHp); ctx.fillStyle = 'red'; ctx.fillRect(this.x - 10, this.y - 20 - (this.radius), 20, 4); ctx.fillStyle = '#4ade80'; ctx.fillRect(this.x - 10, this.y - 20 - (this.radius), 20 * hpPercent, 4); }
}

class Castle {
    constructor() { this.x = 100; this.y = 0; this.baseMaxHp = 100; this.maxHp = 100; this.hp = 100; this.regen = 0; this.tier = 1; this.shield = 0; this.maxShield = 0; this.shieldRegenTimer = 0; this.width = 80; this.height = 100; this.radius = 60; this.armor = 0; }
    update(dt) { if (game.activeChallenge && game.activeChallenge.id === 'noregen') { } else if (this.hp < this.maxHp && this.hp > 0) { this.hp += (this.regen / 60) * (dt / 16); if (this.hp > this.maxHp) this.hp = this.maxHp; } if(this.maxShield > 0) { if(this.shieldRegenTimer > 0) this.shieldRegenTimer -= dt; else if(this.shield < this.maxShield) this.shield += (this.maxShield * 0.05) * (dt / 16); if(this.shield > this.maxShield) this.shield = this.maxShield; } }
    heal(amount) { if (game.activeChallenge && game.activeChallenge.id === 'noregen') return; this.hp = Math.min(this.maxHp, this.hp + amount); }
    takeDamage(amount) { amount = amount * (1 - this.armor); if(this.shield > 0) { if(this.shield >= amount) { this.shield -= amount; amount = 0; } else { amount -= this.shield; this.shield = 0; } this.shieldRegenTimer = 3000; } if(amount > 0) { this.hp -= amount; document.getElementById('damage-overlay').classList.add('damage-effect'); setTimeout(() => document.getElementById('damage-overlay').classList.remove('damage-effect'), 200); if (this.hp <= 0) { this.hp = 0; game.gameOver(); } } }
    draw(ctx, width, height) { this.y = height / 2; if(game.settings.showRange) { ctx.beginPath(); ctx.arc(this.x, this.y, game.currentRange, 0, Math.PI*2); ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)'; ctx.setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]); } ctx.save(); ctx.fillStyle = '#1e293b'; ctx.fillRect(this.x - 40, this.y - 60, 80, 120); ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 3; ctx.strokeRect(this.x - 40, this.y - 60, 80, 120); const slots = [{x: -40, y: -60}, {x: 40, y: -60}, {x: -40, y: 60}, {x: 40, y: 60}]; slots.forEach(s => { ctx.beginPath(); ctx.arc(this.x + s.x, this.y + s.y, 5, 0, Math.PI*2); ctx.fillStyle = '#0f172a'; ctx.fill(); ctx.stroke(); }); ctx.translate(this.x, this.y); const target = game.findTarget(this.x, this.y, game.currentRange); if (target) ctx.rotate(Math.atan2(target.y - this.y, target.x - this.x)); if(this.shield > 0) { ctx.shadowBlur = 10; ctx.shadowColor = '#60a5fa'; ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(0, 0, 70, 0, Math.PI*2); ctx.stroke(); ctx.shadowBlur = 0; } if (this.tier === 1) { ctx.fillStyle = '#60a5fa'; ctx.fillRect(0, -10, 30, 20); ctx.beginPath(); ctx.arc(0, 0, 25, 0, Math.PI*2); ctx.fillStyle = '#2563eb'; ctx.fill(); } else if (this.tier === 2) { ctx.fillStyle = '#a855f7'; ctx.fillRect(0, -12, 35, 24); ctx.fillStyle = '#7e22ce'; ctx.fillRect(-25, -25, 50, 50); ctx.strokeStyle = '#d8b4fe'; ctx.lineWidth = 2; ctx.strokeRect(-20, -20, 40, 40); } else if (this.tier === 3) { ctx.fillStyle = '#f43f5e'; ctx.fillRect(0, -8, 45, 16); ctx.fillStyle = '#be123c'; ctx.beginPath(); for (let i = 0; i < 6; i++) ctx.lineTo(30 * Math.cos(i * Math.PI / 3), 30 * Math.sin(i * Math.PI / 3)); ctx.closePath(); ctx.fill(); ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.fill(); } else { const hue = (Date.now() / 20) % 360; ctx.fillStyle = `hsl(${hue}, 80%, 60%)`; ctx.fillRect(0, -10, 50, 20); ctx.fillStyle = '#fff'; ctx.shadowColor = `hsl(${hue}, 80%, 60%)`; ctx.shadowBlur = 20; ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; } ctx.restore(); }
}

class SkillManager {
    constructor() { this.skills = { overdrive: { duration: 5000, cooldown: 30000, activeTime: 0, cdTime: 0 }, nuke: { duration: 0, cooldown: 60000, activeTime: 0, cdTime: 0 }, blackhole: { duration: 4000, cooldown: 45000, activeTime: 0, cdTime: 0 } }; }
    activate(id) { if (!window.game || game.isGameOver) return; const s = this.skills[id]; const maxCd = s.cooldown * (1 - (game.relicMults.cooldown || 0)); if (s.cdTime <= 0) { s.activeTime = s.duration; s.cdTime = maxCd; if (id === 'nuke') { game.enemies.forEach(e => { if (e.typeKey !== 'BOSS') e.takeDamage(e.maxHp * 20, false, false, true); else e.takeDamage(game.currentDamage * 50, false, false, true); }); document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 500); } } }
    isActive(id) { return this.skills[id].activeTime > 0; }
    update(dt) { for (let key in this.skills) { const s = this.skills[key]; if (s.activeTime > 0) s.activeTime -= dt; if (s.cdTime > 0) { s.cdTime -= dt; if(s.cdTime <= 0) { const el = document.getElementById('skill-' + key); if(el) { el.classList.add('skill-ready-anim'); setTimeout(() => el.classList.remove('skill-ready-anim'), 500); } } } const btn = document.getElementById(`cd-${key}`); const maxCd = s.cooldown * (1 - (game.relicMults.cooldown || 0)); if (btn) btn.style.height = `${Math.max(0, s.cdTime / maxCd) * 100}%`; } }
}

class MetaUpgradeManager {
    constructor() { this.upgrades = [ { id: 'startGold', name: 'H√©ritage', desc: 'Or initial.', baseCost: 1, costMult: 1.5, level: 0, maxLevel: 20, getEffect: (lvl) => lvl * 50, format: (v) => `+${v} Or`, icon: 'üí∞' }, { id: 'goldMult', name: 'Avarice', desc: 'Gain d\'or.', baseCost: 5, costMult: 2, level: 0, maxLevel: 10, getEffect: (lvl) => 1 + (lvl * 0.1), format: (v) => `x${v.toFixed(1)}`, icon: 'ü§ë' }, { id: 'damageMult', name: 'Puissance Ancienne', desc: 'D√©g√¢ts de base.', baseCost: 3, costMult: 1.8, level: 0, maxLevel: 50, getEffect: (lvl) => 1 + (lvl * 0.1), format: (v) => `x${v.toFixed(1)}`, icon: 'üí™' }, { id: 'healthMult', name: 'Architecture', desc: 'PV max.', baseCost: 2, costMult: 1.5, level: 0, maxLevel: 50, getEffect: (lvl) => 1 + (lvl * 0.1), format: (v) => `x${v.toFixed(1)}`, icon: 'üè∞' }, { id: 'unlockAuto', name: 'Protocole Ph√©nix', desc: 'Auto-Retry.', baseCost: 10, costMult: 100, level: 0, maxLevel: 1, getEffect: (lvl) => lvl > 0, format: (v) => v ? 'ON' : 'OFF', icon: 'üîÑ' }, { id: 'unlockAI', name: 'IA de Gestion', desc: 'Auto-Upgrade.', baseCost: 25, costMult: 100, level: 0, maxLevel: 1, getEffect: (lvl) => lvl > 0, format: (v) => v ? 'ON' : 'OFF', icon: 'ü§ñ' }, { id: 'unlockDrone', name: 'Drone Sentinelle', desc: 'Active le compagnon.', baseCost: 50, costMult: 100, level: 0, maxLevel: 1, getEffect: (lvl) => lvl > 0, format: (v) => v ? 'ON' : 'OFF', icon: 'üõ∏' } ]; }
    getCost(u) { return Math.floor(u.baseCost * Math.pow(u.costMult, u.level)); }
    getEffectValue(id) { const u = this.upgrades.find(up => up.id === id); return u ? u.getEffect(u.level) : 0; }
    buy(id) { if (!window.game) return; const u = this.upgrades.find(up => up.id === id); if (!u || (u.maxLevel && u.level >= u.maxLevel)) return; const cost = this.getCost(u); if (game.ether >= cost) { game.ether -= cost; u.level++; game.save(); this.render(); game.updateEtherUI(); game.updateAutomationUI(); game.updateDroneStatus(); } }
    render() { const container = document.getElementById('meta-upgrade-list'); if (!container) return; container.innerHTML = ''; this.upgrades.forEach(u => { const cost = this.getCost(u); const isMaxed = u.maxLevel && u.level >= u.maxLevel; const canAfford = game.ether >= cost && !isMaxed; const div = document.createElement('div'); div.className = `p-4 rounded-xl border flex justify-between items-center transition-all ${isMaxed ? 'bg-slate-700 border-slate-600 opacity-75' : canAfford ? 'bg-purple-900/40 border-purple-500 hover:bg-purple-800/60 cursor-pointer active:scale-95' : 'bg-slate-800 border-slate-700 opacity-50 cursor-not-allowed'}`; if (canAfford) div.onclick = () => this.buy(u.id); div.innerHTML = `<div class="flex items-center gap-3"><div class="text-3xl">${u.icon}</div><div><div class="font-bold text-white">${u.name} ${isMaxed ? '<span class="text-xs text-yellow-400">MAX</span>' : ''}</div><div class="text-xs text-purple-200">${u.desc}</div></div></div><div class="text-right">${!isMaxed ? `<div class="text-purple-300 font-bold font-mono text-xl">${cost} üîÆ</div>` : ''}<div class="text-xs text-slate-500">Lvl ${u.level}</div></div>`; container.appendChild(div); }); }
}

class UpgradeManager {
    constructor() {
        this.upgrades = [
            { id: 'damage', name: 'D√©g√¢ts', description: 'D√©g√¢ts par tir.', category: 0, baseCost: 10, costMult: 1.5, level: 1, getValue: (lvl) => Math.floor(7 * Math.pow(1.2, lvl - 1)), format: (v) => formatNumber(v), icon: '‚öîÔ∏è' },
            { id: 'speed', name: 'Cadence', description: 'Vitesse de tir.', category: 0, baseCost: 25, costMult: 1.6, level: 1, getValue: (lvl) => 1000 * Math.pow(0.88, lvl - 1), format: (v) => (1000/v).toFixed(1) + '/s', icon: '‚ö°' },
            { id: 'crit', name: 'Critique', description: 'Chance et D√©g√¢ts.', category: 0, baseCost: 100, costMult: 1.8, level: 0, getValue: (lvl) => ({chance: Math.min(150, lvl*2), mult: 2 + (lvl*0.1)}), format: (v) => `${v.chance}% / x${v.mult.toFixed(1)}`, icon: 'üí•' },
            { id: 'range', name: 'Port√©e', description: 'Distance de tir.', category: 0, baseCost: 30, costMult: 1.5, level: 1, getValue: (lvl) => 300 + (lvl * 60), format: (v) => v + 'px', icon: 'üéØ' },
            { id: 'multishot', name: 'Multicoup', description: 'Double tir.', category: 0, baseCost: 200, costMult: 2.2, level: 0, getValue: (lvl) => Math.min(60, lvl * 6), format: (v) => v + '%', icon: 'üèπ' },
            { id: 'health', name: 'Sant√©', description: 'PV de la base.', category: 1, baseCost: 15, costMult: 1.4, level: 1, getValue: (lvl) => Math.floor(100 * Math.pow(1.25, lvl - 1)), format: (v) => formatNumber(v), icon: '‚ù§Ô∏è' },
            { id: 'regen', name: 'R√©g√©n√©ration', description: 'Soin passif.', category: 1, baseCost: 50, costMult: 1.8, level: 0, getValue: (lvl) => lvl === 0 ? 0 : Math.floor(2 * Math.pow(1.4, lvl - 1)), format: (v) => v + '/s', icon: 'üîß' },
            { id: 'leech', name: 'Vampirisme', description: 'Soin par kill.', category: 1, baseCost: 2000, costMult: 2.5, level: 0, getValue: (lvl) => lvl * 2, format: (v) => `+${v} PV`, icon: 'ü©∏' },
            { id: 'shield', name: 'Bouclier Plasma', description: 'Protection rechargeable.', category: 1, baseCost: 1500, costMult: 1.6, level: 0, getValue: (lvl) => lvl * 50, format: (v) => formatNumber(v) + ' SP', icon: 'üõ°Ô∏è' },
            { id: 'armor', name: 'Placage', description: 'R√©duit les d√©g√¢ts re√ßus.', category: 1, baseCost: 3000, costMult: 2.0, level: 0, maxLevel: 50, getValue: (lvl) => Math.min(0.75, lvl * 0.015), format: (v) => '-' + (v*100).toFixed(1) + '%', icon: 'üß±' },
            { id: 'turret', name: 'Renforts', description: 'Tourelles auto.', category: 2, baseCost: 500, costMult: 3.5, level: 0, maxLevel: 4, getValue: (lvl) => lvl, format: (v) => v + ' Unit√©s', icon: 'üî´' },
            { id: 'artillery', name: 'Artillerie', description: 'Tourelle Explosive.', category: 2, baseCost: 8000, costMult: 3.0, level: 0, maxLevel: 1, getValue: (lvl) => lvl, format: (v) => v ? '<span class="text-green-400">ACTIF</span>' : '<span class="text-red-400">INACTIF</span>', icon: 'üí£' },
            { id: 'rocket', name: 'Silo Roquette', description: 'Missiles guid√©s.', category: 2, baseCost: 12000, costMult: 3.0, level: 0, maxLevel: 1, getValue: (lvl) => lvl, format: (v) => v ? '<span class="text-green-400">ACTIF</span>' : '<span class="text-red-400">INACTIF</span>', icon: 'üöÄ' },
            { id: 'tesla', name: 'Bobine Tesla', description: '√âclairs en cha√Æne.', category: 2, baseCost: 15000, costMult: 3.0, level: 0, maxLevel: 1, getValue: (lvl) => lvl, format: (v) => v ? '<span class="text-green-400">ACTIF</span>' : '<span class="text-red-400">INACTIF</span>', icon: '‚ö°' },
            { id: 'orbital', name: 'Frappe Orbitale', description: 'Laser automatique.', category: 2, baseCost: 5000, costMult: 2.0, level: 0, maxLevel: 10, getValue: (lvl) => lvl > 0 ? (5000 - lvl * 300) : 0, format: (v) => v > 0 ? (v/1000).toFixed(1) + 's' : '<span class="text-red-400">INACTIF</span>', icon: 'üõ∞Ô∏è' },
            { id: 'ice', name: 'Cryo', description: 'Ralentissement.', category: 2, baseCost: 1000, costMult: 2.5, level: 0, maxLevel: 1, getValue: (lvl) => lvl > 0, format: (v) => v ? '<span class="text-cyan-400">ACTIF</span>' : '<span class="text-red-400">INACTIF</span>', icon: '‚ùÑÔ∏è' },
            { id: 'poison', name: 'Toxine', description: 'D√©g√¢ts dur√©e.', category: 2, baseCost: 1200, costMult: 2.5, level: 0, maxLevel: 1, getValue: (lvl) => lvl > 0, format: (v) => v ? '<span class="text-green-400">ACTIF</span>' : '<span class="text-red-400">INACTIF</span>', icon: '‚ò†Ô∏è' },
            { id: 'stasis', name: 'Chrono-Stasis', description: 'Fige les ennemis.', category: 2, baseCost: 3000, costMult: 2.5, level: 0, maxLevel: 5, getValue: (lvl) => lvl * 5, format: (v) => v + '%', icon: '‚è≥' },
            { id: 'bounce', name: 'Ricochet', description: 'Rebonds.', category: 2, baseCost: 2500, costMult: 3.0, level: 0, maxLevel: 3, getValue: (lvl) => lvl, format: (v) => v + ' Rebonds', icon: '‚§¥Ô∏è' },
            { id: 'blast', name: 'Explosion', description: 'Rayon d\'explosion.', category: 2, baseCost: 3000, costMult: 3.0, level: 0, maxLevel: 5, getValue: (lvl) => lvl * 30, format: (v) => v + 'px', icon: 'üí£' }
        ];
    }
    getCost(upgrade) { return Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, upgrade.level)); }
    buy(id, silent = false) { if (!window.game) return false; const u = this.upgrades.find(u => u.id === id); if(u.maxLevel && u.level >= u.maxLevel) return false; 
    if(game.buyMode === 'MAX') {
        let count = 0; let totalCost = 0; let currentLvl = u.level;
        while(true) {
            let nextCost = Math.floor(u.baseCost * Math.pow(u.costMult, currentLvl + count));
            if(game.gold < totalCost + nextCost) break;
            if(u.maxLevel && currentLvl + count >= u.maxLevel) break;
            totalCost += nextCost; count++; if(count > 1000) break;
        }
        if(count > 0) {
            game.gold -= totalCost; u.level += count;
            game.updateStats(); if(!silent) this.render(game.activeTab); game.save(); game.tutorial.check(game.gold); return true;
        }
    } else {
        const cost = this.getCost(u); if (game.gold >= cost) { game.gold -= cost; u.level++; game.updateStats(); if(!silent) this.render(game.activeTab); game.save(); game.tutorial.check(game.gold); return true; } 
    }
    return false; }
    render(activeTab) { 
        const container = document.getElementById('upgrade-list'); if (!container || typeof game === 'undefined') return; container.innerHTML = ''; 
        const filtered = this.upgrades.filter(u => u.category === activeTab); 
        [0, 1, 2].forEach(catId => {
            const hasAffordable = this.upgrades.some(u => u.category === catId && game.gold >= this.getCost(u) && (!u.maxLevel || u.level < u.maxLevel));
            const tabBtn = document.getElementById(`tab-${catId}`);
            if(tabBtn) { if(hasAffordable) tabBtn.classList.add('tab-notify'); else tabBtn.classList.remove('tab-notify'); }
        });
        document.getElementById('btn-bulk-buy').innerText = `ACHAT: ${game.buyMode}`;

        filtered.forEach(u => { 
            let cost = this.getCost(u); 
            if(game.buyMode === 'MAX') {
                 let count = 0; let totalCost = 0; let currentLvl = u.level;
                 while(true) {
                    let nextCost = Math.floor(u.baseCost * Math.pow(u.costMult, currentLvl + count));
                    if(game.gold < totalCost + nextCost && count > 0) break; 
                    if(game.gold < nextCost && count === 0) { totalCost = nextCost; break; }
                    if(u.maxLevel && currentLvl + count >= u.maxLevel) break;
                    totalCost += nextCost; count++; if(count > 1000) break;
                 }
                 cost = totalCost;
            }

            const isMaxed = u.maxLevel && u.level >= u.maxLevel; const canAfford = game.gold >= cost && !isMaxed; 
            const tm = Math.pow(CONFIG.evolutionMultiplier, game.castle.tier - 1); const mdm = game.metaUpgrades.getEffectValue('damageMult') * (1 + (game.relicMults.damage || 0)); const mhm = game.metaUpgrades.getEffectValue('healthMult') * (1 + (game.relicMults.health || 0)); 
            
            let val = u.getValue(u.level); 
            let next = u.getValue(u.level + 1); 
            
            if (u.id === 'damage') { val = Math.floor(val*tm*mdm); next = Math.floor(next*tm*mdm); } 
            else if (u.id === 'health') { val = Math.floor(val*tm*mhm); next = Math.floor(next*tm*mhm); } 
            else if (u.id === 'regen') { val = (val*tm).toFixed(1); next = (next*tm).toFixed(1); } 

            const div = document.createElement('div'); 
            div.className = `p-3 rounded-lg border-2 transition-all cursor-pointer select-none group ${isMaxed ? 'bg-slate-700 border-slate-600 opacity-75' : canAfford ? 'bg-slate-800 border-blue-600 hover:bg-slate-700 active:scale-95' : 'bg-slate-900 border-slate-700 opacity-60 cursor-not-allowed'}`; 
            if (!isMaxed) div.onclick = () => { if(canAfford) this.buy(u.id); }; 
            div.innerHTML = `<div class="flex justify-between items-start mb-1"><div class="flex items-center gap-2"><span class="text-2xl">${u.icon}</span><div><div class="font-bold text-white leading-tight">${u.name} ${isMaxed ? '<span class="text-xs text-yellow-400">MAX</span>' : ''}</div><div class="text-xs text-blue-300">Niv ${u.level}</div></div></div><div class="text-right">${!isMaxed ? `<div class="text-yellow-400 font-bold font-mono">${formatNumber(cost)}</div>` : ''}</div></div><div class="flex justify-between items-center text-xs font-mono bg-black/30 p-1 rounded"><span class="text-slate-300">${u.format(val)}</span><span class="text-slate-500">‚ûú</span><span class="text-green-400 font-bold">${u.format(next)}</span></div>`; 
            container.appendChild(div); 
        }); 
        if(filtered.length === 0) container.innerHTML = '<div class="text-slate-500 text-center py-4">Rien √† voir ici...</div>'; 
    }
}

class StatsManager {
    constructor() { this.kills = 0; this.bosses = 0; this.totalGold = 0; this.maxWave = 0; this.unlockedAchievements = []; this.xp = 0; this.level = 1; this.masteryPoints = 0; this.mastery = { crit_dmg: 0, ether_gain: 0, drone_spd: 0, gold_drop: 0 }; this.seenEnemies = []; }
    registerKill(isBoss, x, y) { this.kills++; if(isBoss) this.bosses++; const gain = isBoss ? 50 : 5; this.xp += gain; if(this.xp >= this.getNextLevelXp()) { this.xp -= this.getNextLevelXp(); this.level++; this.masteryPoints++; game.floatingTexts.push(new FloatingText(100, game.height/2 - 50, "NIVEAU SUP√âRIEUR !", "#22d3ee", 30)); } this.checkAchievements(); }
    getNextLevelXp() { return this.level * 200; }
    registerGold(amount) { this.totalGold += amount; this.checkAchievements(); }
    registerWave(wave) { if(wave > this.maxWave) this.maxWave = wave; this.checkAchievements(); }
    registerEnemySeen(typeKey) { if(!this.seenEnemies.includes(typeKey)) { this.seenEnemies.push(typeKey); } }
    checkAchievements() { ACHIEVEMENTS_DB.forEach(ach => { if (!this.unlockedAchievements.includes(ach.id) && ach.cond(this)) { this.unlockedAchievements.push(ach.id); game.ether += ach.reward; game.save(); game.updateEtherUI(); this.showPopup(ach); } }); }
    showPopup(ach) { const div = document.createElement('div'); div.className = 'absolute top-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white font-bold p-3 rounded-xl border-2 border-white shadow-2xl z-50 loot-popup flex items-center gap-2'; div.innerHTML = `<span class="text-2xl">üèÜ</span> <div><div class="text-sm">SUCC√àS D√âBLOQU√â</div><div class="text-lg leading-none">${ach.name}</div><div class="text-xs text-green-200">+${ach.reward} Ether</div></div>`; document.getElementById('loot-container').appendChild(div); setTimeout(() => div.remove(), 3000); }
    render() { 
        const list = document.getElementById('achieve-list'); list.innerHTML = ''; ACHIEVEMENTS_DB.forEach(ach => { const unlocked = this.unlockedAchievements.includes(ach.id); const div = document.createElement('div'); div.className = `p-2 rounded border flex justify-between items-center ${unlocked ? 'bg-green-900/50 border-green-500' : 'bg-slate-800 border-slate-700 opacity-60'}`; div.innerHTML = `<div><div class="font-bold ${unlocked ? 'text-white' : 'text-slate-400'}">${ach.name}</div><div class="text-xs text-slate-400">${ach.desc}</div></div><div class="text-xs font-mono ${unlocked ? 'text-green-300' : 'text-slate-500'}">${unlocked ? '‚úì' : `+${ach.reward}üîÆ`}</div>`; list.appendChild(div); }); 
        const mGrid = document.getElementById('mastery-grid'); mGrid.innerHTML = ''; document.getElementById('mastery-pts-display').innerText = this.masteryPoints; const masteries = [ { id: 'crit_dmg', name: 'Impact Critique', desc: '+10% D√©g√¢ts Critiques', max: 50 }, { id: 'ether_gain', name: 'Sagesse Antique', desc: '+5% Gain Ether', max: 20 }, { id: 'drone_spd', name: 'Turbor√©acteurs', desc: '+10% Vitesse Drone', max: 10 }, { id: 'gold_drop', name: 'Alchimie', desc: '+5% Or', max: 100 } ]; masteries.forEach(m => { const lvl = this.mastery[m.id] || 0; const div = document.createElement('div'); div.className = `p-3 rounded bg-slate-700 border border-slate-600 flex justify-between items-center ${this.masteryPoints > 0 && lvl < m.max ? 'cursor-pointer hover:bg-slate-600' : 'opacity-70'}`; if(this.masteryPoints > 0 && lvl < m.max) div.onclick = () => { this.mastery[m.id] = lvl + 1; this.masteryPoints--; game.save(); this.render(); }; div.innerHTML = `<div><div class="font-bold text-cyan-300">${m.name}</div><div class="text-xs text-slate-400">${m.desc}</div></div><div class="text-right font-mono font-bold">${lvl}/${m.max}</div>`; mGrid.appendChild(div); }); document.getElementById('stat-kills').innerText = formatNumber(this.kills); document.getElementById('stat-bosses').innerText = formatNumber(this.bosses); document.getElementById('stat-gold').innerText = formatNumber(Math.floor(this.totalGold)); document.getElementById('stat-wave').innerText = this.maxWave; const xpPct = (this.xp / this.getNextLevelXp()) * 100; document.getElementById('ui-xp-bar').style.width = `${xpPct}%`; document.getElementById('ui-level').innerText = this.level; document.getElementById('ui-mastery-pts').innerText = this.masteryPoints; 
        
        // Render Codex
        const cGrid = document.getElementById('codex-grid'); cGrid.innerHTML = '';
        for(let key in ENEMY_TYPES) {
            const e = ENEMY_TYPES[key];
            const seen = this.seenEnemies.includes(key);
            const div = document.createElement('div');
            div.className = `p-3 rounded border flex items-center gap-3 ${seen ? 'bg-slate-700 border-blue-500' : 'bg-slate-800 border-slate-700 opacity-50'}`;
            div.innerHTML = seen 
                ? `<div class="w-8 h-8 rounded-full" style="background:${e.color}"></div><div><div class="font-bold text-white">${e.name}</div><div class="text-xs text-slate-300">${e.desc}</div><div class="text-[10px] text-slate-400 mt-1">HP x${e.hpMult} ‚Ä¢ Vit x${e.speedMult}</div></div>`
                : `<div class="w-8 h-8 rounded-full bg-black"></div><div><div class="font-bold text-slate-500">???</div><div class="text-xs text-slate-600">Rencontrez cet ennemi pour le d√©bloquer.</div></div>`;
            cGrid.appendChild(div);
        }
    }
}

class ChallengeManager {
    constructor() { this.challenges = CHALLENGES; this.dmTech = { berserk: 0, siphon: 0, overlord: 0 }; this.darkMatter = 0; }
    startChallenge(id) { if(!window.game) return; game.activeChallenge = this.challenges.find(c => c.id === id); game.restart(false); game.updateChallengeUI(); }
    cancelChallenge() { game.activeChallenge = null; game.restart(false); game.updateChallengeUI(); }
    buyTech(id) { const tech = DARK_MATTER_UPGRADES.find(t => t.id === id); const lvl = this.dmTech[id] || 0; if(lvl < tech.max && this.darkMatter >= tech.cost) { this.darkMatter -= tech.cost; this.dmTech[id] = lvl + 1; game.save(); this.render(); } }
    render() { const list = document.getElementById('challenges-list'); list.innerHTML = ''; this.challenges.forEach(c => { const div = document.createElement('div'); div.className = `bg-slate-700 p-2 rounded border border-red-900 flex justify-between items-center ${game.activeChallenge?.id === c.id ? 'border-yellow-400 bg-red-900/40' : ''}`; div.innerHTML = `<div><div class="font-bold text-red-300">${c.name}</div><div class="text-xs text-slate-400">${c.desc}</div></div><button onclick="game.challenges.startChallenge('${c.id}')" class="px-2 py-1 bg-red-600 text-xs font-bold rounded hover:bg-red-500">GO</button>`; list.appendChild(div); }); document.getElementById('dm-total-display').innerText = this.darkMatter; const shop = document.getElementById('dm-shop-grid'); shop.innerHTML = ''; DARK_MATTER_UPGRADES.forEach(t => { const lvl = this.dmTech[t.id] || 0; const div = document.createElement('div'); div.className = `p-2 rounded bg-purple-900/30 border border-purple-700 ${lvl >= t.max ? 'opacity-50' : 'hover:bg-purple-800/50 cursor-pointer'}`; if(lvl < t.max) div.onclick = () => this.buyTech(t.id); div.innerHTML = `<div class="flex justify-between"><span class="font-bold text-xs text-purple-300">${t.name}</span><span class="text-xs">${lvl}/${t.max}</span></div><div class="text-[10px] text-slate-400">${t.desc}</div>${lvl < t.max ? `<div class="text-right text-xs font-bold mt-1 text-white">${t.cost} üåë</div>` : '<div class="text-right text-xs text-green-400">MAX</div>'}`; shop.appendChild(div); }); const hud = document.getElementById('active-challenge-hud'); const hudName = document.getElementById('challenge-name-hud'); if(game.activeChallenge) { hud.classList.remove('hidden'); hudName.innerText = game.activeChallenge.name; document.getElementById('btn-cancel-challenge').classList.remove('hidden'); } else { hud.classList.add('hidden'); document.getElementById('btn-cancel-challenge').classList.add('hidden'); } }
}

class Game {
    constructor() {
        window.game = this;
        this.canvas = document.getElementById('gameCanvas'); this.ctx = this.canvas.getContext('2d');
        this.lastTime = performance.now(); this.gameTime = 0; this.speedMultiplier = 1;
        this.ether = 0; this.activeTab = 0;
        this.buyMode = '1';
        this.sound = new SoundManager();
        this.metaUpgrades = new MetaUpgradeManager();
        this.skills = new SkillManager();
        this.stats = new StatsManager();
        this.challenges = new ChallengeManager();
        this.tutorial = new TutorialManager();
        this.activeChallenge = null;
        
        this.relics = []; this.relicMults = { damage: 0, gold: 0, speed: 0, critChance: 0, health: 0, cooldown: 0 };
        this.autoRetryEnabled = false; this.autoBuyEnabled = false; this.retryTimeoutId = null;
        this.gold = 0; this.wave = 1; this.lastSaveTime = Date.now();
        this.enemies = []; this.projectiles = []; this.particles = []; this.floatingTexts = []; this.turrets = [];
        this.runes = []; this.activeBuffs = { rage: 0, midas: 0 };
        this.castle = new Castle(); this.upgrades = new UpgradeManager();
        this.drone = null; 
        this.lastShotTime = 0; this.spawnTimer = 0; this.waveInProgress = false; this.enemiesToSpawn = 0;
        this.currentEffects = { ice: false, poison: false }; 
        this.currentProps = { bounce: 0, blast: 0, leech: 0, stasis: 0, orbital: 0 };
        this.settings = { showDamageText: true, showRange: true };
        this.isRushBonus = false;
        this.orbitalTimer = 0;
        this.isPaused = false;
        this.devClickCount = 0;
        
        this.dev = {
            addGold: (amt) => { this.addGold(amt); },
            addEther: (amt) => { this.ether += amt; this.updateEtherUI(); },
            skipWaves: (amt) => { this.wave += amt; this.checkEvolution(); this.save(); },
            resetCooldowns: () => { for(let k in this.skills.skills) this.skills.skills[k].cdTime = 0; }
        };

        this.resize(); window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', (e) => { 
            if (e.key.toLowerCase() === 'q') this.activateSkill('overdrive'); 
            if (e.key.toLowerCase() === 'w') this.activateSkill('nuke');
            if (e.key.toLowerCase() === 'e') this.activateSkill('blackhole');
            if (e.key.toLowerCase() === 'p') this.togglePause();
        });
        
        this.canvas.addEventListener('mousedown', (e) => {
            if(this.isPaused) return;
            const rect = this.canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            this.runes.forEach((r, i) => { if (MathUtils.dist(clickX, clickY, r.x, r.y) < 30) { this.activateRune(r); this.runes.splice(i, 1); } });
        });
        
        const dmgToggle = document.getElementById('toggle-damage');
        if(dmgToggle) {
            dmgToggle.addEventListener('change', (e) => { this.settings.showDamageText = e.target.checked; });
        }
        
        const rangeToggle = document.getElementById('toggle-range');
        if(rangeToggle) {
            rangeToggle.addEventListener('change', (e) => { this.settings.showRange = e.target.checked; });
        }
        
        // Removed explicit dev toggle listener as it is now hidden/secret
        
        document.getElementById('toggle-buy').addEventListener('change', (e) => { this.autoBuyEnabled = e.target.checked; });

        this.load();
        this.recalcRelicBonuses();
        this.updateDroneStatus();
        this.checkOfflineEarnings();
        if (this.wave === 1 && this.gold === 0) this.gold = this.metaUpgrades.getEffectValue('startGold');
        if (this.wave === 1) this.tutorial.check(this.gold);

        this.updateStats(); this.upgrades.render(this.activeTab); this.updateTierUI(); this.updateEtherUI(); this.updateAutomationUI(); this.renderRelicGrid(); this.stats.render(); this.challenges.render();
        
        document.getElementById('toggle-retry').addEventListener('change', (e) => this.autoRetryEnabled = e.target.checked);

        if (!this.waveInProgress && !document.getElementById('game-over-screen').classList.contains('hidden') === false) this.startWave();
        requestAnimationFrame((t) => this.loop(t));
        
        // AUTO BUY CHECKER (Fixed logic: more frequent checks and aggressive buying)
        setInterval(() => {
             if (this.autoBuyEnabled && !this.isPaused && !this.isGameOver && this.metaUpgrades.getEffectValue('unlockAI')) {
                 this.performAutoBuy();
                 document.getElementById('auto-status').classList.remove('hidden');
             } else {
                 document.getElementById('auto-status').classList.add('hidden');
             }
        }, 500); // Check every 0.5s
    }
    
    triggerDevSecret() {
        this.devClickCount++;
        if(this.devClickCount >= 5) {
            this.devClickCount = 0;
            const btn = document.getElementById('btn-dev-menu');
            btn.classList.remove('hidden');
            this.floatingTexts.push(new FloatingText(this.width/2, this.height/2, "DEV MODE ACTIVATED", "#ef4444", 40));
        }
    }
    
    toggleBulk() {
        this.buyMode = this.buyMode === '1' ? 'MAX' : '1';
        this.upgrades.render(this.activeTab);
    }
    
    togglePause() {
        this.isPaused = !this.isPaused;
        const overlay = document.getElementById('pause-overlay');
        const btn = document.getElementById('btn-pause');
        if(this.isPaused) {
            overlay.classList.remove('hidden');
            btn.classList.add('bg-yellow-600');
        } else {
            overlay.classList.add('hidden');
            btn.classList.remove('bg-yellow-600');
            this.lastTime = performance.now(); 
        }
    }

    resize() { const container = document.getElementById('game-container'); if (!container) return; this.canvas.width = container.clientWidth; this.canvas.height = container.clientHeight; this.width = this.canvas.width; this.height = this.canvas.height; }
    toggleSpeed() { this.speedMultiplier = this.speedMultiplier === 1 ? 2 : (this.speedMultiplier === 2 ? 4 : 1); document.getElementById('ui-speed').innerText = 'x' + this.speedMultiplier; }
    activateSkill(id) { this.skills.activate(id); this.tutorial.check(0); }
    addGold(amount) { this.gold += amount; this.stats.registerGold(amount); this.upgrades.render(this.activeTab); this.tutorial.check(this.gold); }
    switchTab(id) { this.activeTab = id; document.querySelectorAll('.tab-btn').forEach((btn, idx) => { if(idx === id) btn.classList.add('active'); else btn.classList.remove('active'); }); this.upgrades.render(this.activeTab); }
    updateChallengeUI() { this.challenges.render(); }
    updateDroneStatus() { if(this.metaUpgrades.getEffectValue('unlockDrone') && !this.drone) { this.drone = new Drone(); this.drone.canCollect = true; } }
    activateRune(rune) { if(rune.type.instant) { if(rune.type.id === 'heal') this.castle.heal(this.castle.maxHp * 0.25); } else { this.activeBuffs[rune.type.id] = rune.type.duration; } this.floatingTexts.push(new FloatingText(rune.x, rune.y - 20, rune.type.name + '!', rune.type.color, 24)); this.sound.play('coin'); }
    checkOfflineEarnings() { const now = Date.now(); const diffMs = now - this.lastSaveTime; const diffSec = diffMs / 1000; if (diffSec > 60) { const earned = Math.floor((this.wave * 5) * (diffSec / 60) * (1 + (this.relicMults.gold || 0))); if (earned > 0) { this.gold += earned; this.stats.registerGold(earned); document.getElementById('offline-gold').innerText = formatNumber(earned); document.getElementById('offline-modal').classList.remove('hidden'); } } }
    tryDropRelic() { if (Math.random() < 0.25) { const uncollected = RELIC_DB.filter(r => !this.relics.includes(r.id)); if (uncollected.length > 0) { const drop = uncollected[Math.floor(Math.random() * uncollected.length)]; this.relics.push(drop.id); this.recalcRelicBonuses(); this.updateStats(); this.renderRelicGrid(); this.showLootPopup(drop); this.save(); this.sound.play('levelup'); } } }
    recalcRelicBonuses() { this.relicMults = { damage: 0, gold: 0, speed: 0, critChance: 0, health: 0, cooldown: 0 }; this.relics.forEach(id => { const r = RELIC_DB.find(db => db.id === id); if (r) r.effect(this); }); }
    showLootPopup(relic) { const div = document.createElement('div'); div.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-500 text-black font-bold p-4 rounded-xl border-4 border-white shadow-2xl z-40 loot-popup'; div.innerHTML = `<div>üèÜ RELIQUE OBTENUE!</div><div class="text-2xl mt-1">${relic.icon} ${relic.name}</div><div class="text-xs font-normal">${relic.desc}</div>`; document.getElementById('loot-container').appendChild(div); setTimeout(() => div.remove(), 2000); }
    renderRelicGrid() { const container = document.getElementById('ui-relic-count'); if(container) container.innerText = this.relics.length; const grid = document.getElementById('relic-grid'); grid.innerHTML = ''; if(this.relics.length === 0) { grid.innerHTML = '<div class="text-slate-500 col-span-3 text-center py-8">Aucune relique trouv√©e. Tuez des Boss !</div>'; return; } this.relics.forEach(id => { const r = RELIC_DB.find(db => db.id === id); if(r) { const div = document.createElement('div'); div.className = 'bg-slate-700 p-2 rounded border border-yellow-700 flex flex-col items-center text-center'; div.innerHTML = `<div class="text-3xl mb-1">${r.icon}</div><div class="font-bold text-sm text-yellow-400 leading-tight">${r.name}</div><div class="text-[10px] text-slate-300 mt-1">${r.desc}</div>`; grid.appendChild(div); } }); }
    updateStats() {
        const tierMult = Math.pow(CONFIG.evolutionMultiplier, Math.min(3, this.castle.tier) - 1 + Math.max(0, this.castle.tier - 3) * 0.5); const metaDmg = this.metaUpgrades.getEffectValue('damageMult') * (1 + this.relicMults.damage); const metaHp = this.metaUpgrades.getEffectValue('healthMult') * (1 + this.relicMults.health);
        const dmgBase = this.upgrades.upgrades.find(u => u.id === 'damage'); this.currentDamage = Math.floor(dmgBase.getValue(dmgBase.level) * tierMult * metaDmg);
        const spdBase = this.upgrades.upgrades.find(u => u.id === 'speed'); this.currentFireRate = spdBase.getValue(spdBase.level) / (1 + this.relicMults.speed);
        const critStat = this.upgrades.upgrades.find(u => u.id === 'crit').getValue(this.upgrades.upgrades.find(u => u.id === 'crit').level); this.critChance = critStat.chance + this.relicMults.critChance; this.critMult = critStat.mult + (this.stats.mastery['crit_dmg'] || 0) * 0.1;
        const hpBase = this.upgrades.upgrades.find(u => u.id === 'health'); const hpMod = this.activeChallenge && this.activeChallenge.id === 'glass' ? 0.1 : 1; this.castle.maxHp = Math.floor(hpBase.getValue(hpBase.level) * tierMult * metaHp * hpMod);
        const regBase = this.upgrades.upgrades.find(u => u.id === 'regen'); this.castle.regen = regBase.getValue(regBase.level) * tierMult; 
        this.currentRange = this.upgrades.upgrades.find(u => u.id === 'range').getValue(this.upgrades.upgrades.find(u => u.id === 'range').level);
        this.multiShotChance = this.upgrades.upgrades.find(u => u.id === 'multishot').getValue(this.upgrades.upgrades.find(u => u.id === 'multishot').level);
        this.currentEffects = { ice: this.upgrades.upgrades.find(u => u.id === 'ice').getValue(this.upgrades.upgrades.find(u => u.id === 'ice').level), poison: this.upgrades.upgrades.find(u => u.id === 'poison').getValue(this.upgrades.upgrades.find(u => u.id === 'poison').level) };
        this.currentProps = { bounce: this.upgrades.upgrades.find(u => u.id === 'bounce').getValue(this.upgrades.upgrades.find(u => u.id === 'bounce').level), blast: this.upgrades.upgrades.find(u => u.id === 'blast').getValue(this.upgrades.upgrades.find(u => u.id === 'blast').level), leech: this.upgrades.upgrades.find(u => u.id === 'leech').getValue(this.upgrades.upgrades.find(u => u.id === 'leech').level), stasis: this.upgrades.upgrades.find(u => u.id === 'stasis').getValue(this.upgrades.upgrades.find(u => u.id === 'stasis').level), orbital: this.upgrades.upgrades.find(u => u.id === 'orbital').getValue(this.upgrades.upgrades.find(u => u.id === 'orbital').level) };
        const shieldUpg = this.upgrades.upgrades.find(u => u.id === 'shield'); this.castle.maxShield = shieldUpg.getValue(shieldUpg.level);
        
        const turretPositions = [{x: -40, y: -60}, {x: 40, y: -60}, {x: -40, y: 60}, {x: 40, y: 60}];
        const turretCount = this.upgrades.upgrades.find(u => u.id === 'turret').level;
        
        const specialTypes = ['artillery', 'rocket', 'tesla'];
        
        this.turrets = [];
        specialTypes.forEach(type => {
            const upg = this.upgrades.upgrades.find(u => u.id === type);
            if(upg && upg.level > 0) {
                 const posIndex = this.turrets.length % turretPositions.length;
                 this.turrets.push(new Turret(this.turrets.length, turretPositions[posIndex], 0, type.toUpperCase()));
            }
        });
        
        for(let i=0; i<turretCount; i++) {
             const posIndex = this.turrets.length % turretPositions.length;
             this.turrets.push(new Turret(this.turrets.length, turretPositions[posIndex], 0, 'NORMAL'));
        }
    }
    checkEvolution() {
        const newTier = 1 + Math.floor((this.wave - 1) / CONFIG.evolutionInterval);
        if (newTier > this.castle.tier) { this.castle.tier = newTier; this.updateStats(); this.upgrades.render(this.activeTab); this.updateTierUI(); const notif = document.getElementById('evo-notification'); notif.classList.remove('hidden'); notif.style.opacity = '1'; setTimeout(() => { notif.style.opacity = '0'; setTimeout(() => notif.classList.add('hidden'), 1000); }, 3000); for(let i=0; i<30; i++) this.particles.push(new Particle(100, this.height/2, '#a855f7')); this.sound.play('levelup'); }
        if(this.castle.tier >= 4) { const hue = (Date.now() / 50) % 360; document.body.style.backgroundColor = `hsl(${hue}, 20%, 10%)`; } else { const colors = ['#0f172a', '#1e1b4b', '#1a2e05', '#270a0a']; document.body.style.backgroundColor = colors[(newTier - 1) % colors.length]; }
    }
    updateTierUI() { const el = document.getElementById('ui-tier'); if(el) el.innerText = this.castle.tier; if(this.castle.tier > 1) document.getElementById('ui-tier-display').classList.remove('hidden'); }
    updateEtherUI() { document.getElementById('ui-ether-hud').innerText = formatNumber(this.ether); document.getElementById('shop-ether-total').innerText = formatNumber(this.ether); }
    updateAutomationUI() { if (this.metaUpgrades.getEffectValue('unlockAuto')) { document.getElementById('auto-controls').classList.remove('hidden'); if (this.metaUpgrades.getEffectValue('unlockAI')) { document.getElementById('auto-buy-container').classList.remove('hidden'); document.getElementById('toggle-buy').disabled = false; document.getElementById('auto-buy-container').classList.remove('opacity-50'); } } }
    rushWave() { if(this.isBossWave) return; this.isRushBonus = true; for(let i=0; i<5; i++) this.spawnEnemy(); this.floatingTexts.push(new FloatingText(game.width/2, game.height/2 - 100, "VAGUE RUSH!", "#ef4444", 40)); this.enemiesToSpawn = 0; this.waveInProgress = false; this.wave++; this.enemiesToSpawn += (5 + Math.floor(this.wave * 3)); this.floatingTexts.push(new FloatingText(game.width/2, game.height/2, `VAGUE ${this.wave}`, '#fff', 40)); this.checkEvolution(); this.save(); }
    startWave() { this.waveInProgress = true; this.stats.registerWave(this.wave); this.isBossWave = (this.wave % 10 === 0); this.isRushBonus = false; this.enemiesToSpawn = this.isBossWave ? 1 : (5 + Math.floor(this.wave * 3)); if(this.activeChallenge && this.activeChallenge.id === 'horde') this.enemiesToSpawn *= 3; if (this.isBossWave) { const notif = document.getElementById('boss-notification'); notif.classList.remove('hidden'); setTimeout(() => notif.classList.add('hidden'), 3000); } this.checkEvolution(); this.floatingTexts.push(new FloatingText(this.width / 2, this.height / 2, this.isBossWave ? `BOSS - VAGUE ${this.wave}` : `VAGUE ${this.wave}`, this.isBossWave ? '#ef4444' : '#fff', 40)); }
    spawnEnemy() { 
        // Spawn from right side, random Y
        const startX = this.width + 50;
        const startY = MathUtils.randomRange(this.height * 0.1, this.height * 0.9);
        
        if (this.isBossWave) this.enemies.push(new Enemy(this.wave, 'BOSS', startX, startY)); 
        else { const rand = Math.random(); let type = 'NORMAL'; if (this.wave > 5 && rand < 0.2) type = 'SPEEDY'; if (this.wave > 15 && rand > 0.8) type = 'TANK'; if (this.wave > 20 && rand > 0.9 && rand < 0.95) type = 'HEALER'; if (this.wave > 25 && rand > 0.95) type = 'SPLITTER'; if (this.wave > 10 && rand > 0.3 && rand < 0.35) type = 'THIEF'; if (this.wave > 30 && rand > 0.4 && rand < 0.45) type = 'PHANTOM'; this.enemies.push(new Enemy(this.wave, type, startX, startY)); } 
    }
    findTarget(sourceX, sourceY, range) { let nearest = null; let minDist = Infinity; for (const enemy of this.enemies) { const d = MathUtils.dist(sourceX, sourceY, enemy.x, enemy.y); if (d < range && d < minDist) { minDist = d; nearest = enemy; } } return nearest; }
    shoot(target) { if (!target) return; let color = '#60a5fa'; if (this.castle.tier === 2) color = '#a855f7'; if (this.castle.tier >= 3) color = '#f43f5e'; let isCrit = false; let isSuperCrit = false; let dmg = this.currentDamage; if (this.critChance > 100) { isCrit = true; if (Math.random() * 100 < (this.critChance - 100)) { isSuperCrit = true; dmg = Math.floor(dmg * this.critMult * 2.5); } else { dmg = Math.floor(dmg * this.critMult); } } else { if (Math.random() * 100 < this.critChance) { isCrit = true; dmg = Math.floor(dmg * this.critMult); } } const finalColor = isSuperCrit ? '#d946ef' : (isCrit ? '#fbbf24' : color); game.projectiles.push(new Projectile(100, this.height/2, target, dmg, 15, finalColor, this.castle.tier, false, isCrit, isSuperCrit, this.currentEffects, this.currentProps)); game.sound.play('shoot'); if (Math.random() * 100 < this.multiShotChance) { setTimeout(() => { if(target && target.hp > 0) this.projectiles.push(new Projectile(100, this.height/2, target, Math.floor(dmg * 0.5), 15, '#fff', this.castle.tier, true, isCrit, isSuperCrit, this.currentEffects, this.currentProps)); }, 100 / this.speedMultiplier); } }
    fireOrbital() { let target = null; let maxHp = -1; this.enemies.forEach(e => { if(e.hp > maxHp) { maxHp = e.hp; target = e; } }); if(target) { const dmg = this.currentDamage * 5; target.takeDamage(dmg, true, true); const div = document.createElement('div'); div.className = 'orbital-laser'; div.style.left = (target.x) + 'px'; div.style.top = '0px'; div.style.height = (target.y) + 'px'; document.getElementById('fx-container').appendChild(div); setTimeout(() => div.remove(), 500); this.floatingTexts.push(new FloatingText(target.x, target.y - 60, "ORBITAL!", "#3b82f6", 36)); } }
    loop(currentTime) { 
        if(!this.isPaused) {
            const dtRaw = currentTime - this.lastTime; this.lastTime = currentTime; const dt = Math.min(dtRaw, 100) * this.speedMultiplier; this.gameTime += dt; this.update(dt); 
        }
        this.draw(); requestAnimationFrame((t) => this.loop(t)); 
    }
    update(dt) { if (this.isGameOver) return; this.skills.update(dt); if (this.drone) this.drone.update(dt, this.gameTime); if (this.currentProps.orbital > 0) { this.orbitalTimer += dt; if(this.orbitalTimer >= this.currentProps.orbital) { this.fireOrbital(); this.orbitalTimer = 0; } } const stars = document.getElementById('stars-bg'); if(stars) { stars.style.backgroundPosition = `${this.gameTime * 0.01}px ${this.gameTime * 0.005}px`; } for(let k in this.activeBuffs) { if(this.activeBuffs[k] > 0) this.activeBuffs[k] -= dt; } const buffContainer = document.getElementById('buff-container'); if(buffContainer) { buffContainer.innerHTML = ''; for(let k in this.activeBuffs) { if(this.activeBuffs[k] > 0) { const runeType = RUNE_TYPES.find(r => r.id === k); if(runeType) { const d = document.createElement('div'); d.className = 'text-xs bg-black/50 px-2 py-1 rounded text-white border'; d.style.borderColor = runeType.color; d.innerText = `${runeType.icon} ${(this.activeBuffs[k]/1000).toFixed(1)}s`; buffContainer.appendChild(d); } } } } if (this.enemiesToSpawn > 0) { if (this.gameTime - this.spawnTimer > CONFIG.enemySpawnRate / (1 + this.wave * 0.05)) { this.spawnEnemy(); this.enemiesToSpawn--; this.spawnTimer = this.gameTime; } } else if (this.enemies.length === 0 && this.waveInProgress) { this.waveInProgress = false; this.wave++; this.save(); setTimeout(() => this.startWave(), 2000 / this.speedMultiplier); } this.castle.update(dt); this.turrets.forEach(t => t.update(dt, this.gameTime)); this.runes.forEach(r => r.update(dt)); this.runes = this.runes.filter(r => r.life > 0); 
    // PARTICLES OPTIMIZATION
    if(this.particles.length > 50) this.particles.shift();
    if(this.floatingTexts.length > 20) this.floatingTexts.shift();
    
    const fireRate = (this.skills.isActive('overdrive') || this.activeBuffs['rage'] > 0) ? this.currentFireRate / 3 : this.currentFireRate; if (this.gameTime - this.lastShotTime > fireRate) { const target = this.findTarget(this.castle.x, this.castle.y, this.currentRange); if (target) { this.shoot(target); this.lastShotTime = this.gameTime; } } this.enemies.forEach(e => e.update(dt)); this.projectiles.forEach(p => p.update(dt)); this.particles.forEach(p => p.update(dt)); this.floatingTexts.forEach(t => t.update(dt)); this.enemies = this.enemies.filter(e => e.hp > 0); this.projectiles = this.projectiles.filter(p => p.active); this.particles = this.particles.filter(p => p.life > 0); this.floatingTexts = this.floatingTexts.filter(t => t.life > 0); const elGold = document.getElementById('ui-gold'); if(elGold) elGold.innerText = formatNumber(this.gold); const elWave = document.getElementById('ui-wave'); if(elWave) elWave.innerText = this.wave; const elEnemies = document.getElementById('ui-enemies'); if(elEnemies) elEnemies.innerText = this.enemies.length + this.enemiesToSpawn; const hpPct = Math.max(0, Math.ceil((this.castle.hp / this.castle.maxHp) * 100)); const elHealthBar = document.getElementById('ui-health-bar'); if(elHealthBar) elHealthBar.style.width = `${hpPct}%`; const elHpText = document.getElementById('ui-hp-text'); if(elHpText) elHpText.innerText = `${formatNumber(Math.ceil(this.castle.hp))}/${formatNumber(this.castle.maxHp)}`; const shPct = Math.max(0, Math.min(100, Math.ceil((this.castle.shield / this.castle.maxShield) * 100))); const elShieldBar = document.getElementById('ui-shield-bar'); if(elShieldBar) elShieldBar.style.width = `${shPct}%`; const dmDisplay = document.getElementById('ui-dm-amount'); if(dmDisplay) { dmDisplay.innerText = this.challenges.darkMatter; if(this.challenges.darkMatter > 0) document.getElementById('ui-dark-matter').classList.remove('hidden'); } this.stats.render(); }
    draw() { this.ctx.fillStyle = document.body.style.backgroundColor || '#0f172a'; this.ctx.fillRect(0, 0, this.width, this.height); this.ctx.fillStyle = '#1e293b'; this.ctx.fillRect(0, 0, 120, this.height); const fx = document.getElementById('fx-container'); if(game.skills.isActive('blackhole')) { fx.innerHTML = `<div class="absolute top-1/2 left-[70%] transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 rounded-full border-4 border-purple-600 shadow-[0_0_50px_#9333ea] opacity-80 black-hole-visual bg-black"></div>`; } else { if(!document.querySelector('.orbital-laser')) fx.innerHTML = ''; } const laserColor = this.castle.tier === 1 ? '#3b82f6' : (this.castle.tier === 2 ? '#a855f7' : (this.castle.tier === 3 ? '#f43f5e' : '#fff')); this.ctx.shadowBlur = 15; this.ctx.shadowColor = laserColor; this.ctx.strokeStyle = laserColor; this.ctx.lineWidth = 4; this.ctx.beginPath(); this.ctx.moveTo(120, 0); this.ctx.lineTo(120, this.height); this.ctx.stroke(); this.ctx.shadowBlur = 0; this.turrets.forEach(t => t.draw(this.ctx)); this.castle.draw(this.ctx, this.width, this.height); if(this.drone) this.drone.draw(this.ctx); this.runes.forEach(r => r.draw(this.ctx)); this.enemies.forEach(e => e.draw(this.ctx)); this.projectiles.forEach(p => p.draw(this.ctx)); this.particles.forEach(p => p.draw(this.ctx)); this.floatingTexts.forEach(t => t.draw(this.ctx)); }
    gameOver() { this.isGameOver = true; const earnedEther = Math.max(1, Math.floor(this.wave / 1.5)) * (1 + (this.stats.mastery['ether_gain'] || 0) * 0.05); this.ether += earnedEther; if(this.activeChallenge) { const rewardDM = Math.floor(this.wave / 5) * this.activeChallenge.diff; this.challenges.darkMatter += rewardDM; document.getElementById('go-dm-gain').innerText = rewardDM; document.getElementById('go-dm-gain-box').classList.remove('hidden'); } else { document.getElementById('go-dm-gain-box').classList.add('hidden'); } this.save(); document.getElementById('game-over-screen').classList.remove('hidden'); document.getElementById('go-wave').innerText = this.wave; document.getElementById('go-ether-gain').innerText = formatNumber(Math.floor(earnedEther)); this.updateEtherUI(); this.metaUpgrades.render(); this.sound.play('gameover'); if (this.autoRetryEnabled && this.metaUpgrades.getEffectValue('unlockAuto')) { document.getElementById('auto-retry-timer').classList.remove('hidden'); let countdown = 3; document.getElementById('retry-countdown').innerText = countdown; if(this.retryTimeoutId) clearInterval(this.retryTimeoutId); this.retryTimeoutId = setInterval(() => { countdown--; document.getElementById('retry-countdown').innerText = countdown; if (countdown <= 0) { clearInterval(this.retryTimeoutId); this.restart(true); } }, 1000); } else document.getElementById('auto-retry-timer').classList.add('hidden'); }
    manualRestart() { if(this.retryTimeoutId) clearInterval(this.retryTimeoutId); this.restart(false); }
    restart(isAuto) { this.isGameOver = false; this.wave = 1; this.castle.hp = this.castle.maxHp; this.castle.tier = 1; this.castle.shield = this.castle.maxShield; this.enemies = []; this.projectiles = []; this.runes = []; this.activeBuffs = { rage: 0, midas: 0 }; this.upgrades.upgrades.forEach(u => u.level = u.id === 'regen' || u.id === 'multishot' || u.id === 'turret' || u.id === 'crit' || u.id === 'ice' || u.id === 'poison' || u.id === 'bounce' || u.id === 'blast' || u.id === 'leech' || u.id === 'shield' || u.id === 'stasis' || u.id === 'orbital' || u.id === 'artillery' || u.id === 'rocket' || u.id === 'tesla' || u.id === 'armor' ? 0 : 1); this.gold = this.metaUpgrades.getEffectValue('startGold'); if (isAuto && this.autoBuyEnabled && this.metaUpgrades.getEffectValue('unlockAI')) { document.getElementById('auto-status').classList.remove('hidden'); } else { document.getElementById('auto-status').classList.add('hidden'); } this.updateStats(); this.upgrades.render(this.activeTab); this.updateTierUI(); this.updateEtherUI(); this.updateChallengeUI(); document.getElementById('game-over-screen').classList.add('hidden'); this.startWave(); this.tutorial.check(this.gold); }
    performAutoBuy() { 
        // Optimized Auto Buy logic: More aggressive
        let bought = false;
        // Cheap upgrades spam
        this.upgrades.upgrades.forEach(u => {
            if (this.upgrades.buy(u.id, true)) bought = true;
        });
        if(bought) this.save();
    }
    
    exportSave() { const str = btoa(localStorage.getItem(CONFIG.saveKey)); document.getElementById('save-string').value = str; navigator.clipboard.writeText(str).then(() => alert('Sauvegarde copi√©e!')); }
    importSave() { const str = prompt("Collez votre sauvegarde:"); if (str) { try { localStorage.setItem(CONFIG.saveKey, atob(str)); location.reload(); } catch(e) { alert("Invalide"); } } }
    save() { const data = { gold: this.gold, wave: this.wave, tier: this.castle.tier, upgrades: this.upgrades.upgrades.map(u => ({id: u.id, level: u.level})), ether: this.ether, metaUpgrades: this.metaUpgrades.upgrades.map(u => ({id: u.id, level: u.level})), relics: this.relics, stats: { kills: this.stats.kills, bosses: this.stats.bosses, totalGold: this.stats.totalGold, maxWave: this.stats.maxWave, achievements: this.stats.unlockedAchievements, xp: this.stats.xp, level: this.stats.level, masteryPoints: this.stats.masteryPoints, mastery: this.stats.mastery, seenEnemies: this.stats.seenEnemies }, autoRetry: this.autoRetryEnabled, autoBuy: this.autoBuyEnabled, lastSaveTime: Date.now(), settings: this.settings, challenges: { dm: this.challenges.darkMatter, tech: this.challenges.dmTech } }; localStorage.setItem(CONFIG.saveKey, JSON.stringify(data)); if(document.getElementById('save-string')) document.getElementById('save-string').value = btoa(JSON.stringify(data)); }
    load() { const saved = localStorage.getItem(CONFIG.saveKey); if (saved) { try { const data = JSON.parse(saved); this.ether = data.ether || 0; this.lastSaveTime = data.lastSaveTime || Date.now(); this.relics = data.relics || []; if (data.metaUpgrades) data.metaUpgrades.forEach(s => { const u = this.metaUpgrades.upgrades.find(m => m.id === s.id); if (u) u.level = s.level; }); this.gold = data.gold || 0; this.wave = data.wave || 1; this.castle.tier = data.tier || 1; if (data.upgrades) data.upgrades.forEach(s => { const u = this.upgrades.upgrades.find(m => m.id === s.id); if (u) u.level = s.level; }); if (data.stats) { this.stats.kills = data.stats.kills || 0; this.stats.bosses = data.stats.bosses || 0; this.stats.totalGold = data.stats.totalGold || 0; this.stats.maxWave = data.stats.maxWave || 0; this.stats.unlockedAchievements = data.stats.achievements || []; this.stats.xp = data.stats.xp || 0; this.stats.level = data.stats.level || 1; this.stats.masteryPoints = data.stats.masteryPoints || 0; this.stats.mastery = data.stats.mastery || {}; this.stats.seenEnemies = data.stats.seenEnemies || []; } if (data.challenges) { this.challenges.darkMatter = data.challenges.dm || 0; this.challenges.dmTech = data.challenges.tech || {}; } this.autoRetryEnabled = data.autoRetry || false; this.autoBuyEnabled = data.autoBuy || false; this.settings = data.settings || { showDamageText: true, showRange: true }; document.getElementById('toggle-retry').checked = this.autoRetryEnabled; document.getElementById('toggle-buy').checked = this.autoBuyEnabled; if(document.getElementById('toggle-damage')) document.getElementById('toggle-damage').checked = this.settings.showDamageText; if(document.getElementById('toggle-range')) document.getElementById('toggle-range').checked = this.settings.showRange; } catch (e) { console.error("Save error", e); } } }
}

window.onload = () => { if (window.game && window.game.animationId) cancelAnimationFrame(window.game.animationId); new Game(); };
</script>
</body>
</html>