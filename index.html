<!DOCTYPE html>
<!--
  Copyright 2025 Julien Bombled

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ether Citadel - Browser-based idle tower defense with deep progression systems">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title data-i18n="game.title">Ether Citadel</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css?v=17">
</head>
<body class="h-screen w-screen flex flex-col md:flex-row">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <div class="text-4xl font-bold text-cyan-400 mb-4">Ether Citadel</div>
        <div class="w-48 h-2 bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full bg-cyan-500 rounded-full animate-loading-bar"></div>
        </div>
        <div class="text-slate-400 mt-4 text-sm">Loading...</div>
    </div>

    <div class="fixed top-0 left-0 w-full h-1 bg-slate-900 z-50 pointer-events-none">
        <div id="ui-xp-bar" class="h-full bg-cyan-500 shadow-[0_0_10px_#06b6d4] transition-all duration-300" style="width: 0%"></div>
    </div>

    <div class="relative flex-grow h-2/3 md:h-full md:w-3/4 bg-slate-900 overflow-hidden" id="game-container">
        <div id="stars-bg" class="absolute inset-0 z-0 opacity-50 pointer-events-none"></div>
        <div id="damage-overlay" class="absolute inset-0 pointer-events-none z-10"></div>
        <div id="fx-container" class="absolute inset-0 pointer-events-none z-10"></div>
        <canvas id="gameCanvas" class="block w-full h-full cursor-crosshair z-10 relative"></canvas>

        <div class="absolute top-4 left-4 flex flex-col gap-1 pointer-events-none select-none z-20">
            <div class="text-xs text-cyan-400 font-bold uppercase tracking-widest">
                <span data-i18n="game.level">Level</span> <span id="ui-level">1</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-4xl font-bold text-yellow-400 drop-shadow-lg">
                    <span data-i18n="game.gold">Gold</span>: <span id="ui-gold">0</span>
                </div>
                <button id="btn-pause" onclick="game.togglePause()" class="pointer-events-auto bg-slate-700/80 hover:bg-slate-600 text-white font-bold py-1 px-3 rounded border border-slate-500 backdrop-blur-sm transition text-sm">‚è∏Ô∏è</button>
                <button id="btn-speed" onclick="game.toggleSpeed()" class="pointer-events-auto bg-blue-600/80 hover:bg-blue-500 text-white font-bold py-1 px-3 rounded border border-blue-400 backdrop-blur-sm transition flex items-center gap-1 text-sm">
                    <span>‚è©</span> <span id="ui-speed">x1</span>
                </button>
                <button id="btn-sound" onclick="game.sound.toggle()" class="pointer-events-auto bg-slate-700/80 hover:bg-slate-600 text-white font-bold py-1 px-2 rounded border border-slate-500 backdrop-blur-sm transition text-sm">üîä</button>
            </div>
            <div class="flex items-center gap-2 text-2xl font-bold drop-shadow-lg">
                <span class="text-blue-400">
                    <span data-i18n="game.wave">Wave</span>: <span id="ui-wave">1</span>
                </span>
                <button onclick="game.rushWave()" class="pointer-events-auto bg-red-600/80 hover:bg-red-500 text-white text-xs font-bold py-1 px-2 rounded border border-red-400 backdrop-blur-sm transition flex items-center gap-1" data-i18n-title="game.rushTooltip">
                    <span>üî•</span> <span data-i18n="game.rush">RUSH</span>
                </button>
                <button id="btn-surrender" onclick="if(game.canSurrender() && confirm(game.t('surrender.confirm'))) game.strategicSurrender()" class="hidden pointer-events-auto bg-amber-600/80 hover:bg-amber-500 text-white text-xs font-bold py-1 px-2 rounded border border-amber-400 backdrop-blur-sm transition flex items-center gap-1">
                    <span>üè≥Ô∏è</span> <span data-i18n="surrender.button">Surrender</span>
                </button>
                <span class="text-purple-400 text-xl flex items-center gap-1 ml-4">
                    <span>üîÆ</span> <span id="ui-ether-hud">0</span>
                </span>
                <span class="text-cyan-400 text-xl flex items-center gap-1 ml-2">
                    <span>üíé</span> <span id="ui-crystals">0</span>
                </span>
            </div>
            <div class="text-xl text-slate-300 font-bold flex items-center gap-2">
                <span data-i18n="game.enemies">Enemies</span>: <span id="ui-enemies">0</span>
                <span id="ui-dark-matter" class="hidden text-base text-purple-300 font-normal ml-2 dark-matter-text">
                    ‚ö´ <span id="ui-dm-amount">0</span>
                </span>
            </div>
            <div id="ui-tier-display" class="hidden text-purple-400 font-bold tracking-widest uppercase text-sm mt-1 animate-pulse">
                <span data-i18n="hud.evolutionTier">Evolution Tier</span> <span id="ui-tier">1</span>
            </div>
            <!-- Menu buttons moved to right side for cleaner UI -->
            <button id="btn-dev-menu" onclick="document.getElementById('dev-modal').classList.remove('hidden')" class="hidden text-red-500 hover:text-red-400 transition bg-black/40 px-2 py-1 rounded border border-red-900 font-bold pointer-events-auto">DEV</button>
            <div id="buff-container" class="flex gap-2 mt-1"></div>
            <div id="active-challenge-hud" class="hidden bg-red-900/60 border border-red-500 text-red-200 text-xs px-2 py-1 rounded mt-2 font-bold animate-pulse">
                <span data-i18n="hud.activeChallenge">ACTIVE CHALLENGE:</span> <span id="challenge-name-hud">NAME</span>
            </div>
        </div>

        <div class="absolute top-4 right-4 flex flex-col items-end gap-2 pointer-events-auto z-20">
            <div class="flex gap-2 mb-2 flex-wrap">
                <button onclick="document.getElementById('relic-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-yellow-500 border border-yellow-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-yellow-400 focus:outline-none"
                    aria-label="Collection de reliques">
                    <span class="text-xl" aria-hidden="true">üéí</span>
                    <span class="text-xs font-bold" id="ui-relic-count">0</span>
                </button>
                <button onclick="document.getElementById('codex-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-blue-400 border border-blue-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-blue-400 focus:outline-none"
                    aria-label="Codex des ennemis">
                    <span class="text-xl" aria-hidden="true">üìñ</span>
                    <span class="text-xs font-bold" data-i18n="game.codex">Codex</span>
                </button>
                <button onclick="game.renderMiningUI(); document.getElementById('mining-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-cyan-400 border border-cyan-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-cyan-400 focus:outline-none"
                    aria-label="Minage de ressources">
                    <span class="text-xl" aria-hidden="true">‚õèÔ∏è</span>
                    <span class="text-xs font-bold" data-i18n="mining.title">Mining</span>
                </button>
                <button onclick="game.renderForgeUI(); document.getElementById('forge-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-yellow-400 border border-yellow-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-yellow-400 focus:outline-none"
                    aria-label="Forge de reliques">
                    <span class="text-xl" aria-hidden="true">üî•</span>
                    <span class="text-xs font-bold" data-i18n="forge.title">Forge</span>
                </button>
                <button onclick="game.renderResearchUI(); document.getElementById('research-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-purple-400 border border-purple-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-purple-400 focus:outline-none"
                    aria-label="Arbre de recherche">
                    <span class="text-xl" aria-hidden="true">üî¨</span>
                    <span class="text-xs font-bold" data-i18n="research.title">Research</span>
                </button>
                <button onclick="document.getElementById('mastery-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-cyan-400 border border-cyan-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-cyan-400 focus:outline-none"
                    aria-label="Points de maitrise">
                    <span class="text-xl" aria-hidden="true">üéì</span>
                    <span class="text-xs font-bold" id="ui-mastery-pts">0</span>
                </button>
                <button onclick="game.updateDreadUI(); document.getElementById('challenges-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-red-500 border border-red-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-red-400 focus:outline-none"
                    aria-label="Defis et mode Dread">
                    <span class="text-xl" aria-hidden="true">üíÄ</span>
                    <span class="text-xs font-bold" data-i18n="game.challenges">Challenges</span>
                </button>
                <button onclick="document.getElementById('achieve-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-green-400 border border-green-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-green-400 focus:outline-none"
                    aria-label="Succes et achievements">
                    <span class="text-xl" aria-hidden="true">üèÜ</span>
                    <span class="text-xs font-bold" data-i18n="game.success">Achievements</span>
                </button>
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-slate-400 border border-slate-600/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-slate-400 focus:outline-none"
                    aria-label="Parametres du jeu">
                    <span class="text-xl" aria-hidden="true">‚öôÔ∏è</span>
                    <span class="text-xs font-bold" data-i18n="game.options">Options</span>
                </button>
            </div>
            <div class="flex gap-2 flex-wrap">
                <button onclick="game.renderProductionUI(); document.getElementById('production-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-orange-400 border border-orange-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-orange-400 focus:outline-none"
                    aria-label="Production passive">
                    <span class="text-xl" aria-hidden="true">üè≠</span>
                    <span class="text-xs font-bold" data-i18n="production.title">Production</span>
                </button>
                <button id="btn-quests" onclick="game.renderDailyQuestsUI(); document.getElementById('quests-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-emerald-400 border border-emerald-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-emerald-400 focus:outline-none relative"
                    aria-label="Quetes quotidiennes">
                    <span class="text-xl" aria-hidden="true">üìã</span>
                    <span class="text-xs font-bold" data-i18n="quests.title">Quests</span>
                    <span id="quest-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs font-bold flex items-center justify-center border-2 border-slate-800">!</span>
                </button>
                <button id="btn-prestige-menu" onclick="game.renderPrestigeUI(); document.getElementById('prestige-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-amber-400 border border-amber-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-amber-400 focus:outline-none"
                    aria-label="Prestige et renaissance">
                    <span class="text-xl" aria-hidden="true">üëë</span>
                    <span class="text-xs font-bold" data-i18n="prestige.title">Prestige</span>
                </button>
                <button onclick="game.renderChipsUI(); document.getElementById('chips-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-pink-400 border border-pink-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-pink-400 focus:outline-none"
                    aria-label="Modules et puces">
                    <span class="text-xl" aria-hidden="true">üîß</span>
                    <span class="text-xs font-bold" data-i18n="chips.title">Chips</span>
                </button>
                <button onclick="game.renderTownUI(); document.getElementById('town-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-teal-400 border border-teal-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-teal-400 focus:outline-none"
                    aria-label="Town level">
                    <span class="text-xl" aria-hidden="true">üè∞</span>
                    <span class="text-xs font-bold" data-i18n="town.title">Town</span>
                </button>
            </div>
            <div class="flex gap-2 flex-wrap">
                <button id="btn-school" onclick="game.renderSchoolUI(); document.getElementById('school-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-indigo-400 border border-indigo-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-indigo-400 focus:outline-none hidden"
                    aria-label="School turrets">
                    <span class="text-xl" aria-hidden="true">üéì</span>
                    <span class="text-xs font-bold" data-i18n="school.title">School</span>
                </button>
                <button id="btn-office" onclick="game.renderOfficeUI(); document.getElementById('office-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-lime-400 border border-lime-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-lime-400 focus:outline-none hidden"
                    aria-label="Office boosts">
                    <span class="text-xl" aria-hidden="true">üè¢</span>
                    <span class="text-xs font-bold" data-i18n="office.title">Office</span>
                </button>
                <button id="btn-awakening" onclick="game.renderAwakeningUI(); document.getElementById('awakening-modal').classList.remove('hidden')"
                    class="menu-btn bg-slate-800/80 hover:bg-slate-700 text-fuchsia-400 border border-fuchsia-700/50 rounded-lg p-2 backdrop-blur-sm transition flex flex-col items-center min-w-[50px] focus:ring-2 focus:ring-fuchsia-400 focus:outline-none hidden"
                    aria-label="Awakening">
                    <span class="text-xl" aria-hidden="true">‚ú®</span>
                    <span class="text-xs font-bold" data-i18n="awakening.title">Awaken</span>
                </button>
            </div>
            <div id="auto-controls" class="hidden bg-slate-900/80 p-3 rounded-lg border border-slate-700 backdrop-blur-sm w-full">
                <div class="flex items-center justify-between gap-3 mb-2">
                    <span class="text-xs font-bold text-slate-400 tracking-wider" data-i18n="hud.autoRetry">AUTO RETRY</span>
                    <div class="relative inline-block w-8 align-middle select-none">
                        <input type="checkbox" name="toggle" id="toggle-retry" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300"/>
                        <label for="toggle-retry" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label>
                    </div>
                </div>
                <div id="auto-buy-container" class="hidden flex items-center justify-between gap-3 opacity-50">
                    <span class="text-xs font-bold text-slate-400 tracking-wider" data-i18n="hud.autoBuy">AUTO BUY</span>
                    <div class="relative inline-block w-8 align-middle select-none">
                        <input type="checkbox" name="toggle" id="toggle-buy" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300" disabled/>
                        <label for="toggle-buy" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-600 cursor-pointer"></label>
                    </div>
                </div>
                <div id="auto-status" class="text-xs text-green-400 font-mono text-center mt-1 hidden" data-i18n="hud.aiActive">AI ACTIVE</div>
            </div>
        </div>

        <div id="tutorial-overlay" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-900/90 border-2 border-blue-400 p-6 rounded-xl text-center shadow-2xl z-50 pointer-events-auto max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-2" id="tuto-title" data-i18n="tutorial.welcome.title">Welcome!</h2>
            <p class="text-blue-100 text-sm mb-4" id="tuto-text" data-i18n="tutorial.welcome.text">Defend the castle against enemy waves.</p>
            <div id="tuto-arrow" class="absolute hidden text-4xl text-yellow-400 tutorial-arrow">‚¨ÖÔ∏è</div>
            <button onclick="game.tutorial.next()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded" data-i18n="tutorial.understood">Got it</button>
        </div>

        <div class="absolute bottom-16 left-1/2 -translate-x-1/2 flex gap-6 pointer-events-auto z-20">
            <div id="skill-overdrive" onclick="game.activateSkill('overdrive')" class="skill-btn relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-blue-500 transition shadow-lg group overflow-hidden" data-skill="overdrive">
                <div class="absolute inset-0 flex items-center justify-center text-3xl">‚ö°</div>
                <div class="absolute top-1 right-1 text-xs font-bold text-slate-500">Q</div>
                <div id="cd-overdrive" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0"></div>
                <div class="skill-tooltip absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-blue-500 pointer-events-none whitespace-nowrap left-1/2 -translate-x-1/2">
                    <strong class="text-blue-400" data-i18n="skills.overdrive.name">Overdrive</strong><br>
                    <span data-i18n="skills.overdrive.desc">Speed x3 for 5s.</span>
                </div>
            </div>
            <div id="skill-nuke" onclick="game.activateSkill('nuke')" class="skill-btn relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-red-500 transition shadow-lg group overflow-hidden" data-skill="nuke">
                <div class="absolute inset-0 flex items-center justify-center text-3xl">‚òÑÔ∏è</div>
                <div class="absolute top-1 right-1 text-xs font-bold text-slate-500">W</div>
                <div id="cd-nuke" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0"></div>
                <div class="skill-tooltip absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-red-500 pointer-events-none whitespace-nowrap left-1/2 -translate-x-1/2">
                    <strong class="text-red-400" data-i18n="skills.nuke.name">Meteor</strong><br>
                    <span data-i18n="skills.nuke.desc">Massive area damage.</span>
                </div>
            </div>
            <div id="skill-blackhole" onclick="game.activateSkill('blackhole')" class="skill-btn relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-purple-500 transition shadow-lg group overflow-hidden" data-skill="blackhole">
                <div class="absolute inset-0 flex items-center justify-center text-3xl">üåÄ</div>
                <div class="absolute top-1 right-1 text-xs font-bold text-slate-500">E</div>
                <div id="cd-blackhole" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0"></div>
                <div class="skill-tooltip absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-purple-500 pointer-events-none whitespace-nowrap left-1/2 -translate-x-1/2">
                    <strong class="text-purple-400" data-i18n="skills.blackhole.name">Black Hole</strong><br>
                    <span data-i18n="skills.blackhole.desc">Pulls and crushes enemies.</span>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-4 right-4 md:left-auto md:right-auto md:w-1/2 md:translate-x-1/2 md:left-1/4 flex flex-col gap-1 pointer-events-none z-20">
            <div class="h-2 bg-slate-800 rounded-full border border-slate-600 overflow-hidden relative">
                <div id="ui-shield-bar" class="h-full bg-blue-400 shadow-[0_0_5px_#60a5fa]" style="width: 0%;"></div>
            </div>
            <div class="h-4 bg-slate-800 rounded-full border border-slate-600 overflow-hidden relative">
                <div id="ui-health-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500" style="width: 100%;"></div>
                <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white drop-shadow">
                    <span data-i18n="game.hp">HP</span>: <span id="ui-hp-text">100/100</span>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="evo-notification" class="hidden absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-purple-900/90 border-2 border-purple-500 p-6 rounded-xl text-center shadow-[0_0_50px_rgba(168,85,247,0.5)] z-30 evolution-notify pointer-events-none">
            <h2 class="text-3xl font-bold text-white mb-2" data-i18n="notifications.evolution">EVOLUTION!</h2>
            <p class="text-purple-200" data-i18n="notifications.evolutionSub">Higher Tier Reached</p>
        </div>
        <div id="boss-notification" class="hidden absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-900/90 border-2 border-red-500 p-6 rounded-xl text-center shadow-[0_0_50px_rgba(220,38,38,0.5)] z-30 animate-pulse pointer-events-none">
            <h2 class="text-4xl font-bold text-red-500 mb-2">‚ö†Ô∏è <span data-i18n="notifications.bossWarning">BOSS</span> ‚ö†Ô∏è</h2>
            <p class="text-red-200" data-i18n="notifications.bossWarningSub">Prepare your defenses!</p>
        </div>
        <div id="loot-container" class="absolute inset-0 pointer-events-none z-30 overflow-hidden" aria-live="polite" aria-atomic="false"></div>

        <!-- MODALS -->
        <!-- Relic Modal -->
        <div id="relic-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="relic-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-yellow-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-yellow-400 font-bold uppercase" data-i18n="modals.collection.title">Collection</h2>
                    <button onclick="document.getElementById('relic-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div id="relic-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Codex Modal -->
        <div id="codex-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-blue-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-blue-400 font-bold uppercase" data-i18n="modals.codex.title">Codex</h2>
                    <button onclick="document.getElementById('codex-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div id="codex-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Mining Modal -->
        <div id="mining-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-cyan-400 font-bold uppercase" data-i18n="mining.title">Mining</h2>
                    <button onclick="document.getElementById('mining-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 bg-cyan-900/30 p-3 rounded border border-cyan-800 text-center">
                        <div class="text-sm text-cyan-300" data-i18n="mining.slots">Miner Slots</div>
                        <div class="text-2xl font-bold text-white"><span id="mining-slots">0/3</span></div>
                    </div>
                    <div id="mining-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Forge Modal -->
        <div id="forge-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-yellow-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-yellow-400 font-bold uppercase" data-i18n="forge.title">Relic Forge</h2>
                    <button onclick="document.getElementById('forge-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="forge.desc">Upgrade, reroll, or fuse your relics using mining resources.</div>
                    <div id="forge-recipes" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Research Modal -->
        <div id="research-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-4xl bg-slate-800 border border-purple-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-purple-400 font-bold uppercase" data-i18n="research.title">Research Tree</h2>
                    <div class="flex items-center gap-4">
                        <span class="text-cyan-400">üíé <span id="research-crystals">0</span></span>
                        <button onclick="document.getElementById('research-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                    </div>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div id="research-branches" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Challenges Modal -->
        <div id="challenges-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-red-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-red-500 font-bold uppercase" data-i18n="modals.challenges.title">Hardcore Mode</h2>
                    <button onclick="document.getElementById('challenges-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <!-- Dread Mode Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-purple-400 mb-2" data-i18n="dread.title">Dread Mode</h3>
                        <div class="dread-selector" id="dread-selector"></div>
                        <div class="dread-info">
                            <div class="dread-info-title" id="dread-info-title"></div>
                            <div class="dread-info-bonus" id="dread-info-bonus"></div>
                            <div class="dread-info-difficulty" id="dread-info-difficulty"></div>
                        </div>
                    </div>

                    <div class="mb-4 bg-purple-900/30 p-3 rounded border border-purple-800 text-center">
                        <div class="text-sm text-purple-300" data-i18n="modals.challenges.darkMatter">Dark Matter</div>
                        <div class="text-2xl font-bold text-white">‚ö´ <span id="dm-total-display">0</span></div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-purple-400 mb-2" data-i18n="modals.challenges.forbiddenResearch">Forbidden Research</h3>
                        <div id="dm-shop-grid" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>
                    <h3 class="text-lg font-bold text-red-400 mb-2" data-i18n="modals.challenges.availableChallenges">Available Challenges</h3>
                    <div id="challenges-list" class="space-y-2"></div>
                    <div class="mt-4 text-center">
                        <button onclick="game.challenges.cancelChallenge()" id="btn-cancel-challenge" class="hidden px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded" data-i18n="modals.challenges.abandon">Abandon challenge</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mastery Modal -->
        <div id="mastery-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-cyan-400 font-bold uppercase" data-i18n="modals.mastery.title">Mastery</h2>
                    <button onclick="document.getElementById('mastery-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4">
                    <div class="text-center mb-4 text-white">
                        <span data-i18n="modals.mastery.points">Points</span>: <span id="mastery-pts-display" class="text-cyan-400 font-bold text-xl">0</span>
                    </div>
                    <div id="mastery-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Achievements Modal -->
        <div id="achieve-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-green-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-green-400 font-bold uppercase" data-i18n="modals.achievements.title">Achievements</h2>
                    <button onclick="document.getElementById('achieve-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="grid grid-cols-2 gap-2 mb-6 text-sm text-slate-300 font-mono bg-black/20 p-2 rounded">
                        <div><span data-i18n="modals.achievements.enemies">Enemies</span>: <span id="stat-kills" class="text-white">0</span></div>
                        <div><span data-i18n="modals.achievements.bosses">Bosses</span>: <span id="stat-bosses" class="text-white">0</span></div>
                        <div><span data-i18n="modals.achievements.gold">Gold</span>: <span id="stat-gold" class="text-white">0</span></div>
                        <div><span data-i18n="modals.achievements.wave">Wave</span>: <span id="stat-wave" class="text-white">0</span></div>
                    </div>
                    <div id="achieve-list" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="bg-slate-800 border border-slate-500 p-8 rounded-2xl max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl text-white font-bold" data-i18n="modals.settings.title">Settings</h2>
                    <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <!-- Language Selector -->
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="modals.settings.language">Language</span>
                        <select id="language-select" onchange="game.changeLanguage(this.value)" class="bg-slate-700 text-white border border-slate-600 rounded px-2 py-1 text-sm">
                            <option value="en">English</option>
                            <option value="fr">Fran√ßais</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="modals.settings.showDamage">Show Damage</span>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" id="toggle-damage" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300"/>
                            <label for="toggle-damage" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="modals.settings.showRange">Show Range</span>
                        <div class="relative inline-block w-10 align-middle select-none">
                            <input type="checkbox" id="toggle-range" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-all duration-300"/>
                            <label for="toggle-range" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1" data-i18n="modals.settings.save">Save</label>
                        <textarea id="save-string" class="w-full h-24 bg-black/50 border border-slate-600 rounded p-2 text-xs text-slate-300 break-all" readonly></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="game.exportSave()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-bold" data-i18n="modals.settings.copy">COPY</button>
                        <button onclick="game.importSave()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded text-sm font-bold" data-i18n="modals.settings.import">IMPORT</button>
                    </div>
                    <hr class="border-slate-700 my-4">
                    <button onclick="game.confirmReset()" class="w-full bg-red-900 hover:bg-red-700 text-red-200 py-2 rounded text-sm font-bold border border-red-700" data-i18n="modals.settings.reset">RESET</button>
                </div>
            </div>
        </div>

        <!-- Production Modal -->
        <div id="production-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-orange-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-orange-400 font-bold uppercase" data-i18n="production.title">Production</h2>
                    <button onclick="document.getElementById('production-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="production.desc">Build passive resource generators to earn resources over time.</div>
                    <div id="production-summary" class="mb-4 bg-orange-900/30 p-3 rounded border border-orange-800 grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm"></div>
                    <div id="production-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Daily Quests Modal -->
        <div id="quests-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-emerald-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-emerald-400 font-bold uppercase" data-i18n="quests.title">Daily Quests</h2>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-slate-400" data-i18n="quests.resetIn">Reset in</span>
                        <span id="quests-timer" class="text-emerald-300 font-mono text-sm">--:--:--</span>
                        <button onclick="document.getElementById('quests-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                    </div>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div id="quests-grid" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Prestige Modal -->
        <div id="prestige-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-3xl bg-slate-800 border border-amber-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-amber-400 font-bold uppercase" data-i18n="prestige.title">Prestige</h2>
                    <button onclick="document.getElementById('prestige-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-6 bg-amber-900/30 p-4 rounded border border-amber-800 text-center">
                        <div class="flex justify-around items-center flex-wrap gap-4">
                            <div>
                                <div class="text-sm text-amber-300" data-i18n="prestige.points">Prestige Points</div>
                                <div class="text-3xl font-bold text-white"><span id="prestige-points">0</span> üëë</div>
                            </div>
                            <div>
                                <div class="text-sm text-amber-300" data-i18n="prestige.potential">Potential Gain</div>
                                <div class="text-2xl font-bold text-amber-400">+<span id="prestige-potential">0</span> üëë</div>
                            </div>
                            <div>
                                <div class="text-sm text-amber-300" data-i18n="prestige.total">Total Prestiges</div>
                                <div class="text-xl font-bold text-slate-300"><span id="prestige-total">0</span></div>
                            </div>
                            <div class="hidden">
                                <div class="text-sm text-cyan-300" data-i18n="prestige.waveSkip">Wave Skip</div>
                                <div class="text-xl font-bold text-cyan-400"><span id="prestige-wave-skip">0</span> üöÄ</div>
                            </div>
                        </div>
                        <button onclick="if(game.prestige.canPrestige() && confirm(game.t('prestige.confirmReset'))) game.prestige.doPrestige()" id="btn-prestige" class="mt-4 px-8 py-3 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold rounded text-lg transition" data-i18n="prestige.doPrestige">
                            PRESTIGE NOW
                        </button>
                        <div class="text-xs text-slate-400 mt-2" data-i18n="prestige.requirement">Requires Wave 25+</div>
                    </div>

                    <!-- Auto-Prestige Controls -->
                    <div class="mb-6 bg-slate-700/50 p-4 rounded border border-slate-600">
                        <h3 class="text-lg font-bold text-cyan-400 mb-3" data-i18n="prestige.autoTitle">Auto-Prestige</h3>
                        <div class="flex items-center justify-between gap-4 flex-wrap">
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-300" data-i18n="prestige.autoEnable">Enable Auto-Prestige</span>
                                <label class="relative inline-block w-12 h-6">
                                    <input type="checkbox" id="toggle-auto-prestige" class="sr-only peer">
                                    <div class="w-12 h-6 bg-slate-600 rounded-full peer peer-checked:bg-cyan-500 transition"></div>
                                    <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-6"></div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-300" data-i18n="prestige.autoWave">Prestige at Wave</span>
                                <input type="number" id="auto-prestige-wave" min="25" max="1000" value="30" class="w-20 px-2 py-1 bg-slate-800 border border-slate-600 rounded text-center text-cyan-400 font-bold">
                            </div>
                        </div>
                        <div class="text-xs text-slate-400 mt-2" data-i18n="prestige.autoDesc">When enabled, prestige will trigger automatically on game over if wave threshold is reached.</div>
                    </div>

                    <h3 class="text-lg font-bold text-amber-400 mb-3" data-i18n="prestige.upgrades">Prestige Upgrades</h3>
                    <div id="prestige-upgrades-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Chips Modal -->
        <div id="chips-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-3xl bg-slate-800 border border-pink-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-pink-400 font-bold uppercase" data-i18n="chips.title">Turret Chips</h2>
                    <button onclick="document.getElementById('chips-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="chips.desc">Equip chips to turrets for bonus effects. Chips drop from bosses.</div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-pink-400 mb-3" data-i18n="chips.inventory">Chip Inventory</h3>
                        <div id="chips-inventory" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-pink-400 mb-3" data-i18n="chips.equipped">Equipped Chips</h3>
                        <div id="chips-equipped" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Town Modal -->
        <div id="town-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-3xl bg-slate-800 border border-teal-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-teal-400 font-bold uppercase" data-i18n="town.title">Town</h2>
                    <button onclick="document.getElementById('town-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-6 bg-teal-900/30 p-4 rounded border border-teal-800 text-center">
                        <div class="flex justify-around items-center flex-wrap gap-4">
                            <div>
                                <div class="text-sm text-teal-300" data-i18n="town.currentLevel">Current Level</div>
                                <div class="text-3xl font-bold text-white"><span id="town-level-icon">üè†</span> <span id="town-level">1</span></div>
                            </div>
                            <div>
                                <div class="text-sm text-teal-300" data-i18n="town.xp">Town XP</div>
                                <div class="text-2xl font-bold text-teal-400"><span id="town-xp">0</span></div>
                            </div>
                            <div>
                                <div class="text-sm text-teal-300" data-i18n="town.nextLevel">Next Level</div>
                                <div class="text-xl font-bold text-slate-300"><span id="town-next-xp">100</span> XP</div>
                            </div>
                        </div>
                        <div class="mt-4 w-full bg-slate-700 rounded-full h-3">
                            <div id="town-progress" class="bg-teal-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-teal-400 mb-3" data-i18n="town.unlocks">Unlocked Features</h3>
                    <div id="town-unlocks-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- School Modal -->
        <div id="school-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-3xl bg-slate-800 border border-indigo-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-indigo-400 font-bold uppercase" data-i18n="school.title">School</h2>
                    <button onclick="document.getElementById('school-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="school.desc">Unlock and upgrade turret types. Costs crystals.</div>
                    <div class="mb-4 text-center">
                        <span class="text-lg text-cyan-400">üíé <span id="school-crystals">0</span></span>
                    </div>
                    <div id="school-turrets-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Office Modal -->
        <div id="office-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-3xl bg-slate-800 border border-lime-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-lime-400 font-bold uppercase" data-i18n="office.title">Office</h2>
                    <button onclick="document.getElementById('office-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="office.desc">Activate temporary boosts using gems.</div>
                    <div class="mb-4 text-center">
                        <span class="text-lg text-pink-400">üí† <span id="office-gems">0</span></span>
                    </div>
                    <h3 class="text-lg font-bold text-lime-400 mb-3" data-i18n="office.active">Active Boosts</h3>
                    <div id="office-active-boosts" class="mb-6 space-y-2"></div>
                    <h3 class="text-lg font-bold text-lime-400 mb-3" data-i18n="office.available">Available Boosts</h3>
                    <div id="office-boosts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Awakening Modal -->
        <div id="awakening-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-3xl bg-slate-800 border border-fuchsia-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-fuchsia-400 font-bold uppercase" data-i18n="awakening.title">Awakening</h2>
                    <button onclick="document.getElementById('awakening-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-6 bg-fuchsia-900/30 p-4 rounded border border-fuchsia-800 text-center">
                        <div id="awakening-status" class="text-xl font-bold text-white mb-2"></div>
                        <div id="awakening-requirement" class="text-sm text-slate-400"></div>
                        <button id="btn-awaken" onclick="game.awakening.awaken(); game.renderAwakeningUI()" class="hidden mt-4 px-8 py-3 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold rounded text-lg transition" data-i18n="awakening.activate">
                            AWAKEN
                        </button>
                    </div>
                    <h3 class="text-lg font-bold text-fuchsia-400 mb-3" data-i18n="awakening.bonuses">Awakening Bonuses</h3>
                    <div id="awakening-bonuses-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Turret Slots Modal -->
        <div id="slots-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 class="text-2xl text-cyan-400 font-bold uppercase" data-i18n="slots.title">Turret Slot</h2>
                    <button onclick="document.getElementById('slots-modal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="slots.desc">Select a turret to place in this slot.</div>
                    <div class="mb-4 bg-slate-700/50 p-3 rounded border border-slate-600">
                        <div class="text-xs text-slate-400 mb-1" data-i18n="slots.current">Current Turret</div>
                        <div id="slots-current-turret" class="flex items-center justify-between"></div>
                    </div>
                    <h3 class="text-lg font-bold text-cyan-400 mb-3" data-i18n="slots.available">Available Turrets</h3>
                    <div id="slots-turrets-grid" class="grid grid-cols-2 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- Dev Modal -->
        <div id="dev-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="bg-red-950 border border-red-600 p-8 rounded-2xl max-w-md text-center shadow-2xl" onclick="event.stopPropagation()">
                <h2 class="text-3xl text-red-500 font-bold mb-4" data-i18n="modals.dev.title">DEVELOPER MODE</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="game.dev.addGold(1000000)" class="px-4 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded shadow" data-i18n="modals.dev.addGold">+1M GOLD üí∞</button>
                    <button onclick="game.dev.addEther(10000)" class="px-4 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded shadow" data-i18n="modals.dev.addEther">+10k ETHER üîÆ</button>
                    <button onclick="game.dev.skipWaves(10)" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow" data-i18n="modals.dev.skipWaves">+10 WAVES ‚è©</button>
                    <button onclick="game.dev.resetCooldowns()" class="px-4 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded shadow" data-i18n="modals.dev.resetCooldowns">CD RESET ‚ö°</button>
                    <button onclick="game.castle.heal(99999999)" class="px-4 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow" data-i18n="modals.dev.heal">HEAL ‚ù§Ô∏è</button>
                    <button onclick="document.getElementById('dev-modal').classList.add('hidden')" class="col-span-2 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded mt-4" data-i18n="modals.dev.close">CLOSE</button>
                </div>
            </div>
        </div>

        <!-- Offline Modal -->
        <div id="offline-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true">
            <div class="bg-slate-800 border border-yellow-500 p-8 rounded-2xl max-w-md text-center shadow-2xl" onclick="event.stopPropagation()">
                <h2 class="text-3xl text-yellow-400 font-bold mb-4" data-i18n="modals.offline.title">Welcome Back</h2>
                <p class="text-slate-300 mb-6" data-i18n="modals.offline.subtitle">Offline Earnings</p>
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-6">
                    <div class="text-4xl font-bold text-white">+<span id="offline-gold">0</span> üí∞</div>
                </div>
                <button onclick="document.getElementById('offline-modal').classList.add('hidden')" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg transition" data-i18n="modals.offline.collect">Collect</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="hidden absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-40 backdrop-blur-md overflow-y-auto py-10">
            <div class="w-full max-w-2xl px-4 flex flex-col items-center">
                <h1 class="text-5xl font-bold text-red-500 mb-2 uppercase" data-i18n="modals.gameOver.title">Defeat</h1>
                <p class="text-xl text-slate-300 mb-4">
                    <span data-i18n="modals.gameOver.wave">Wave</span>: <span id="go-wave" class="text-white font-bold">0</span>
                </p>
                <div id="auto-retry-timer" class="text-yellow-400 font-mono text-lg mb-4 hidden">
                    <span data-i18n="modals.gameOver.autoRetryTimer">Auto-Retry</span>: <span id="retry-countdown">3</span>s...
                </div>
                <div class="flex gap-4 mb-8 w-full justify-center">
                    <div class="bg-purple-900/30 border border-purple-500/50 p-4 rounded-xl flex items-center gap-4 flex-1 justify-center">
                        <span class="text-4xl">üîÆ</span>
                        <div>
                            <div class="text-sm text-purple-300 uppercase" data-i18n="modals.gameOver.ether">Ether</div>
                            <div class="text-3xl font-bold text-white">+<span id="go-ether-gain">0</span></div>
                        </div>
                    </div>
                    <div id="go-dm-gain-box" class="hidden bg-black/60 border border-purple-900 p-4 rounded-xl flex items-center gap-4 flex-1 justify-center">
                        <span class="text-4xl">‚ö´</span>
                        <div>
                            <div class="text-sm text-purple-300 uppercase" data-i18n="modals.gameOver.darkMatter">Matter</div>
                            <div class="text-3xl font-bold text-white">+<span id="go-dm-gain">0</span></div>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-slate-800 rounded-xl border border-slate-700 p-6 shadow-2xl mb-8">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <h2 class="text-2xl font-bold text-purple-400 uppercase" data-i18n="modals.gameOver.ancestralShop">Ancestral Shop</h2>
                        <div class="text-xl font-bold text-white bg-purple-900/50 px-3 py-1 rounded">
                            <span data-i18n="modals.gameOver.etherTotal">Ether</span>: <span id="shop-ether-total">0</span> üîÆ
                        </div>
                    </div>
                    <div id="meta-upgrade-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <button onclick="game.manualRestart()" class="px-12 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow transition text-2xl transform hover:scale-105" data-i18n="modals.gameOver.fight">FIGHT</button>
            </div>
        </div>

        <div class="scanlines"></div>
    </div>

    <!-- Laboratory Panel -->
    <div class="h-1/3 md:h-full md:w-1/4 bg-slate-800 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col shadow-2xl z-20">
        <div class="p-4 bg-slate-900 border-b border-slate-700 shadow-md">
            <h2 class="text-xl font-bold text-blue-400 uppercase tracking-wider text-center mb-2" data-i18n="lab.title">Laboratory</h2>
            <div class="flex gap-1 justify-center">
                <button id="tab-0" onclick="game.switchTab(0)" class="tab-btn active" data-i18n="lab.tabs.attack">Attack</button>
                <button id="tab-1" onclick="game.switchTab(1)" class="tab-btn" data-i18n="lab.tabs.defense">Defense</button>
                <button id="tab-2" onclick="game.switchTab(2)" class="tab-btn" data-i18n="lab.tabs.tech">Tech</button>
            </div>
            <div class="flex justify-end mt-2">
                <button id="btn-bulk-buy" onclick="game.toggleBulk()" class="text-xs font-bold bg-slate-800 px-2 py-1 rounded border border-slate-600 hover:border-white transition">
                    <span data-i18n="lab.bulkBuy">BUY</span>: x1
                </button>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto p-2 space-y-2" id="upgrade-list"></div>
        <div id="lab-footer" onclick="game.triggerDevSecret()" class="p-2 text-center text-xs text-slate-500 bg-slate-900 cursor-pointer select-none" data-i18n="lab.footer">Click on Runes on the ground for bonuses!</div>
    </div>

<script type="module" src="js/main.js?v=17"></script>
</body>
</html>
