<!DOCTYPE html>
<!--
  Copyright 2025 Julien Bombled

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="description" content="Ether Citadel - Browser-based idle tower defense with deep progression systems">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title data-i18n="game.title">Ether Citadel</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/break_infinity.js/break_infinity.min.js"></script>
    <link rel="stylesheet" href="css/modules.css">
    <link rel="stylesheet" href="css/styles.css?v=25">
    <link rel="stylesheet" href="css/game/ascension.css">
    <link rel="stylesheet" href="css/components/cloud.css">
</head>
<body class="h-screen w-screen flex flex-col md:flex-row">

    <!-- Skip Link for Accessibility -->
    <a href="#game-container" class="skip-link" data-i18n="a11y.skipToMain">Skip to main content</a>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <div class="text-4xl font-bold text-cyan-400 mb-6">Ether Citadel</div>
        <div class="loading-spinner mb-4" role="status" aria-label="Loading game"></div>
        <div class="text-slate-400 text-sm" data-i18n="ui.loading">Loading...</div>
    </div>

    <div class="fixed top-0 left-0 w-full h-1 bg-slate-900 z-50 pointer-events-auto cursor-help group touch-tooltip-trigger" tabindex="0" role="button" aria-label="Experience bar" data-i18n-title="hud.tooltips.xp">
        <div id="ui-xp-bar" class="h-full bg-cyan-500 shadow-[0_0_10px_#06b6d4] transition-all duration-300" style="width: 0%"></div>
        <div class="xp-tooltip hidden group-hover:block absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-slate-900/95 border border-cyan-500 rounded px-2 py-1 text-xs text-cyan-400 whitespace-nowrap z-50" role="tooltip">
            <span data-i18n="hud.xpBar">Experience</span> - <span data-i18n="hud.xpBarHint">Level up for Stat Points</span>
        </div>
    </div>

    <div class="relative flex-grow h-2/3 md:h-full md:w-3/4 bg-slate-900 overflow-hidden" id="game-container">
        <div id="stars-bg" class="absolute inset-0 z-0 opacity-50 pointer-events-none"></div>
        <div id="damage-overlay" class="absolute inset-0 pointer-events-none z-10"></div>
        <div id="fx-container" class="absolute inset-0 pointer-events-none z-10"></div>
        <canvas id="gameCanvas" class="block w-full h-full cursor-crosshair z-10 relative" role="img" aria-label="Game canvas - Tower defense gameplay area"></canvas>

        <div class="absolute top-4 left-4 flex flex-col gap-1 pointer-events-none select-none z-20">
            <div class="text-xs text-cyan-400 font-bold uppercase tracking-widest">
                <span data-i18n="game.level">Level</span> <span id="ui-level">1</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="resource-display text-4xl font-bold text-yellow-400 drop-shadow-lg flex items-center gap-2 cursor-help" data-i18n-title="hud.tooltips.gold">
                    <span class="text-3xl">ü™ô</span> <span id="ui-gold">0</span>
                </div>
                <button id="btn-pause" onclick="game.togglePause()" class="pointer-events-auto bg-slate-700/80 hover:bg-slate-600 text-white font-bold py-1 px-3 rounded border border-slate-500 backdrop-blur-sm transition text-sm" aria-label="Toggle pause" data-i18n-title="hud.buttons.pause">‚è∏Ô∏è</button>
                <button id="btn-sound" onclick="game.sound.toggle()" class="pointer-events-auto bg-slate-700/80 hover:bg-slate-600 text-white font-bold py-1 px-2 rounded border border-slate-500 backdrop-blur-sm transition text-sm" aria-label="Toggle sound" data-i18n-title="hud.buttons.sound">üîä</button>
                <div id="speed-controls-hud" class="pointer-events-auto flex gap-1 ml-2">
                    <button onclick="game.setSpeed(1)" class="speed-btn-mini active" data-speed="1" aria-label="Speed 1x">1x</button>
                    <button onclick="game.setSpeed(3)" class="speed-btn-mini" data-speed="3" aria-label="Speed 3x">3x</button>
                    <button onclick="game.setSpeed(6)" class="speed-btn-mini" data-speed="6" aria-label="Speed 6x">6x</button>
                    <button onclick="game.setSpeed(10)" class="speed-btn-mini" data-speed="10" aria-label="Speed 10x">10x</button>
                </div>
            </div>
            <div class="flex items-center gap-2 text-2xl font-bold drop-shadow-lg">
                <span class="text-blue-400 group relative cursor-help touch-tooltip-trigger pointer-events-auto" tabindex="0" role="button" aria-label="Wave info">
                    <span data-i18n="game.wave">Wave</span>: <span id="ui-wave">1</span>
                    <div id="wave-preview" class="wave-tooltip hidden group-hover:block absolute top-full left-0 mt-1 bg-slate-900/95 border border-blue-500 rounded-lg p-2 text-xs text-left whitespace-nowrap z-50 min-w-48" role="tooltip">
                        <div class="text-blue-400 font-bold mb-1" data-i18n="game.nextWave">Next Wave</div>
                        <div id="wave-preview-content" class="text-slate-300 space-y-1"></div>
                    </div>
                </span>
                <button onclick="game.rushWave()" class="pointer-events-auto bg-red-600/80 hover:bg-red-500 text-white text-xs font-bold py-1 px-2 rounded border border-red-400 backdrop-blur-sm transition flex items-center gap-1" data-i18n-title="game.rushTooltip" aria-label="Rush next wave for +25% gold bonus">
                    <span>üî•</span> <span data-i18n="game.rush">RUSH</span>
                </button>
                <button id="btn-surrender" onclick="if(game.canSurrender()) gameConfirm(game.t('surrender.confirm'), () => game.strategicSurrender())" class="hidden pointer-events-auto bg-amber-600/80 hover:bg-amber-500 text-white text-xs font-bold py-1 px-2 rounded border border-amber-400 backdrop-blur-sm transition flex items-center gap-1">
                    <span>üè≥Ô∏è</span> <span data-i18n="surrender.button">Surrender</span>
                </button>
                <span class="resource-display text-purple-400 text-xl flex items-center gap-1 ml-4 cursor-help" data-i18n-title="hud.tooltips.ether">
                    <span class="text-2xl">üîÆ</span> <span id="ui-ether-hud" class="font-bold">0</span>
                </span>
                <span class="resource-display text-cyan-400 text-xl flex items-center gap-1 ml-2 cursor-help" data-i18n-title="hud.tooltips.crystals">
                    <span class="text-2xl">üíé</span> <span id="ui-crystals" class="font-bold">0</span>
                </span>
                <button id="btn-open-ascension" class="hidden pointer-events-auto bg-purple-900/50 hover:bg-purple-800 text-purple-200 text-xl p-1.5 rounded border border-purple-500 ml-2 transition" data-i18n-title="ascension.title" aria-label="Open Ascension Tree">
                    üåå
                </button>
                <button id="btn-cloud" class="pointer-events-auto text-xl p-1.5 rounded ml-2 transition" data-i18n-title="cloud.title" aria-label="Cloud Save">
                    ‚òÅÔ∏è
                </button>
            </div>
            <div class="text-xl text-slate-300 font-bold flex items-center gap-2">
                <span data-i18n="game.enemies">Enemies</span>: <span id="ui-enemies">0</span>
                <span id="ui-dark-matter" class="hidden text-base text-purple-300 font-normal ml-2 dark-matter-text">
                    üåë <span id="ui-dm-amount">0</span>
                </span>
            </div>
            <div id="ui-tier-display" class="hidden text-purple-400 font-bold tracking-widest uppercase text-sm mt-1 animate-pulse">
                <span data-i18n="hud.evolutionTier">Evolution Tier</span> <span id="ui-tier">1</span>
            </div>
            <div id="ui-dread-display" class="hidden text-red-400 font-bold tracking-widest uppercase text-sm mt-1">
                <span data-i18n="hud.dreadLevel">Dread</span> <span id="dread-level">0</span>
            </div>
            <!-- Menu buttons moved to right side for cleaner UI -->
            <button id="btn-dev-menu" onclick="document.getElementById('dev-modal').classList.remove('hidden')" class="hidden text-red-500 hover:text-red-400 transition bg-black/40 px-2 py-1 rounded border border-red-900 font-bold pointer-events-auto">DEV</button>
            <div id="buff-container" class="flex gap-2 mt-1"></div>
            <div id="active-challenge-hud" class="hidden bg-red-900/60 border border-red-500 text-red-200 text-xs px-2 py-1 rounded mt-2 font-bold animate-pulse">
                <span data-i18n="hud.activeChallenge">ACTIVE CHALLENGE:</span> <span id="challenge-name-hud">NAME</span>
            </div>
            <!-- Active Synergies Indicator -->
            <div id="synergies-hud" class="hidden mt-2">
                <div class="text-xs text-slate-400 uppercase tracking-wider mb-1" data-i18n="synergy.active">Active Synergies</div>
                <div id="synergies-list" class="flex flex-wrap gap-1"></div>
            </div>
        </div>

        <!-- Seasonal Event Banner -->
        <div id="seasonal-banner" class="hidden absolute top-12 left-1/2 -translate-x-1/2 z-30 pointer-events-none">
            <div class="bg-gradient-to-r from-transparent via-purple-900/80 to-transparent px-8 py-2 text-center">
                <span id="seasonal-icon" class="text-2xl mr-2"></span>
                <span id="seasonal-name" class="text-white font-bold"></span>
                <span id="seasonal-bonus" class="text-yellow-300 text-sm ml-2"></span>
            </div>
        </div>

        <!-- Suggested Action Banner -->
        <div id="suggested-action" class="hidden absolute top-4 left-1/2 -translate-x-1/2 z-30 pointer-events-auto">
            <button type="button" class="bg-gradient-to-r from-amber-900/90 to-orange-900/90 border border-amber-500 rounded-lg px-3 py-2 flex items-center gap-2 backdrop-blur-sm cursor-pointer hover:border-amber-400 transition max-w-[200px]" onclick="game.executeSuggestedAction()" aria-label="Execute suggested action">
                <span class="text-amber-400 text-lg animate-pulse" aria-hidden="true">üí°</span>
                <div class="flex-1 min-w-0">
                    <div id="suggested-action-text" class="text-white font-bold text-xs truncate"></div>
                </div>
                <span class="text-amber-400 text-sm" aria-hidden="true">‚Üí</span>
            </button>
        </div>

        <div class="fixed top-4 right-4 flex flex-col items-end gap-2 pointer-events-auto z-30" id="menu-container">
            <!-- Quick Access Bar -->
            <div class="flex gap-2 items-center">
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="menu-btn-sm" aria-label="Settings">‚öôÔ∏è</button>
                <button onclick="document.getElementById('achieve-modal').classList.remove('hidden')" class="menu-btn-sm" aria-label="Achievements">üèÜ</button>
                <button id="btn-quests" onclick="game.renderDailyQuestsUI(); document.getElementById('quests-modal').classList.remove('hidden')" class="menu-btn-sm relative" aria-label="Quests">
                    üìã<span id="quest-badge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white text-xs font-bold flex items-center justify-center">!</span>
                </button>
                <div class="w-px h-6 bg-slate-600"></div>
                <button onclick="game.toggleMenuGroup('all')" class="menu-btn-sm text-cyan-400" aria-label="Toggle Menu" id="btn-toggle-menu">‚ò∞</button>
            </div>

            <!-- Grouped Menu System -->
            <div id="menu-groups" class="flex flex-col gap-2 transition-all duration-300">
                <!-- Combat Group -->
                <div class="menu-group" data-group="combat">
                    <button onclick="game.toggleMenuGroup('combat')" class="menu-group-header bg-red-900/80 border-red-700 text-red-400" aria-expanded="false">
                        <span>‚öîÔ∏è</span><span data-i18n="ux.menu.combat">Combat</span><span class="menu-arrow">‚ñº</span>
                    </button>
                    <div class="menu-group-content hidden" id="menu-combat">
                        <button onclick="game.renderChipsUI(); document.getElementById('chips-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üîß</span> <span data-i18n="chips.title">Chips</span> <span id="ui-chips-count" class="menu-count ml-auto">0</span></button>
                        <button onclick="game.renderPresetsUI(); document.getElementById('presets-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üíæ</span> <span data-i18n="presets.title">Presets</span></button>
                    </div>
                </div>

                <!-- Economy Group -->
                <div class="menu-group" data-group="economy">
                    <button onclick="game.toggleMenuGroup('economy')" class="menu-group-header bg-amber-900/80 border-amber-700 text-amber-400" aria-expanded="false">
                        <span>üí∞</span><span data-i18n="ux.menu.economy">Economy</span><span class="menu-arrow">‚ñº</span>
                    </button>
                    <div class="menu-group-content hidden" id="menu-economy">
                        <button onclick="game.renderMiningUI(); document.getElementById('mining-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">‚õèÔ∏è</span> <span data-i18n="mining.title">Mining</span></button>
                        <button onclick="game.renderForgeUI(); document.getElementById('forge-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üî•</span> <span data-i18n="forge.title">Forge</span></button>
                        <button onclick="game.renderProductionUI(); document.getElementById('production-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üè≠</span> <span data-i18n="production.title">Production</span></button>
                        <button id="btn-office" onclick="game.renderOfficeUI(); document.getElementById('office-modal').classList.remove('hidden')" class="menu-item menu-locked" data-unlock="office" data-i18n-title="unlock.office.tooltip"><span aria-hidden="true">üè¢</span> <span data-i18n="office.title">Office</span> <span class="unlock-req text-amber-400 text-xs ml-auto" data-i18n="unlock.office.req">Town Lv.4</span></button>
                    </div>
                </div>

                <!-- Progression Group -->
                <div class="menu-group" data-group="progression">
                    <button onclick="game.toggleMenuGroup('progression')" class="menu-group-header bg-purple-900/80 border-purple-700 text-purple-400" aria-expanded="false">
                        <span>üìà</span><span data-i18n="ux.menu.progression">Progression</span><span class="menu-arrow">‚ñº</span>
                    </button>
                    <div class="menu-group-content hidden" id="menu-progression">
                        <button id="btn-school" onclick="game.renderSchoolUI(); document.getElementById('school-modal').classList.remove('hidden')" class="menu-item menu-locked" data-unlock="school" data-i18n-title="unlock.school.tooltip"><span aria-hidden="true">üéì</span> <span data-i18n="school.title">School</span> <span class="unlock-req text-amber-400 text-xs ml-auto" data-i18n="unlock.school.req">Town Lv.3</span></button>
                        <button onclick="game.renderResearchUI(); document.getElementById('research-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üî¨</span> <span data-i18n="research.title">Research</span></button>
                        <button id="btn-prestige-menu" onclick="game.renderPrestigeUI(); document.getElementById('prestige-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üëë</span> <span data-i18n="prestige.title">Prestige</span></button>
                        <button onclick="game.renderTownUI(); document.getElementById('town-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üè∞</span> <span data-i18n="town.title">Town</span></button>
                        <button onclick="document.getElementById('mastery-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">‚≠ê</span> <span data-i18n="modals.mastery.title">Mastery</span> <span id="ui-mastery-pts" class="text-cyan-400 ml-1">0</span></button>
                        <button id="btn-awakening" onclick="game.renderAwakeningUI(); document.getElementById('awakening-modal').classList.remove('hidden')" class="menu-item menu-locked" data-unlock="awakening" data-i18n-title="unlock.awakening.tooltip"><span aria-hidden="true">‚ú®</span> <span data-i18n="awakening.title">Awaken</span> <span class="unlock-req text-amber-400 text-xs ml-auto" data-i18n="unlock.awakening.req">Dread 6</span></button>
                    </div>
                </div>

                <!-- Meta/Modes Group -->
                <div class="menu-group" data-group="meta">
                    <button onclick="game.toggleMenuGroup('meta')" class="menu-group-header bg-violet-900/80 border-violet-700 text-violet-400" aria-expanded="false">
                        <span>üéÆ</span><span data-i18n="ux.menu.meta">Modes</span><span class="menu-arrow">‚ñº</span>
                    </button>
                    <div class="menu-group-content hidden" id="menu-meta">
                        <button onclick="game.renderGameModesUI(); document.getElementById('modes-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üéÆ</span> <span data-i18n="modes.title">Game Modes</span></button>
                        <button onclick="game.renderCampaignUI(); document.getElementById('campaign-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üìú</span> <span data-i18n="campaign.title">Campaign</span></button>
                        <button onclick="game.updateDreadUI(); document.getElementById('challenges-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üíÄ</span> <span data-i18n="game.challenges">Challenges</span></button>
                        <button onclick="game.renderLeaderboardUI(); document.getElementById('leaderboard-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üèÖ</span> <span data-i18n="leaderboard.title">Leaderboard</span></button>
                    </div>
                </div>

                <!-- Info Group -->
                <div class="menu-group" data-group="info">
                    <button onclick="game.toggleMenuGroup('info')" class="menu-group-header bg-slate-700/80 border-slate-600 text-slate-300" aria-expanded="false">
                        <span>üìö</span><span data-i18n="ux.menu.info">Info</span><span class="menu-arrow">‚ñº</span>
                    </button>
                    <div class="menu-group-content hidden" id="menu-info">
                        <button onclick="game.renderQuestsUI && game.renderQuestsUI(); document.getElementById('quests-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üìã</span> <span data-i18n="quests.title">Quests</span> <span id="ui-quests-count" class="menu-count ml-auto">0</span></button>
                        <button onclick="game.stats.render(); document.getElementById('achieve-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üèÜ</span> <span data-i18n="game.success">Achievements</span></button>
                        <button onclick="document.getElementById('relic-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üéí</span> <span data-i18n="modals.collection.title">Collection</span> <span id="ui-relic-count" class="text-yellow-400 ml-1">0</span></button>
                        <button onclick="document.getElementById('codex-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üìñ</span> <span data-i18n="game.codex">Codex</span> <span id="ui-codex-count" class="menu-count ml-auto">0</span></button>
                        <button onclick="game.renderStatisticsUI(); document.getElementById('statistics-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">üìä</span> <span data-i18n="statistics.title">Statistics</span></button>
                        <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="menu-item"><span aria-hidden="true">‚öôÔ∏è</span> <span data-i18n="game.options">Options</span></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tutorial-overlay" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-900/90 border-2 border-blue-400 p-6 rounded-xl text-center shadow-2xl z-50 pointer-events-auto max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-2" id="tuto-title" data-i18n="tutorial.welcome.title">Welcome!</h2>
            <p class="text-blue-100 text-sm mb-4" id="tuto-text" data-i18n="tutorial.welcome.text">Defend the castle against enemy waves.</p>
            <div id="tuto-arrow" class="absolute hidden text-4xl text-yellow-400 tutorial-arrow">‚¨ÖÔ∏è</div>
            <button onclick="game.tutorial.next()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded" data-i18n="tutorial.understood">Got it</button>
        </div>

        <div class="absolute bottom-16 left-1/2 -translate-x-1/2 flex gap-6 pointer-events-auto z-20">
            <button id="skill-overdrive" class="skill-btn relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-blue-500 transition shadow-lg group overflow-hidden" data-skill="overdrive" aria-label="Overdrive skill (Press Q) - Speed x3 for 5 seconds" role="button">
                <div class="absolute inset-0 flex items-center justify-center text-3xl" aria-hidden="true">‚ö°</div>
                <div class="skill-hotkey absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-br-lg" aria-hidden="true">Q</div>
                <div id="cd-overdrive" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0" aria-hidden="true"></div>
                <div class="skill-tooltip absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-blue-500 pointer-events-none whitespace-nowrap left-1/2 -translate-x-1/2" role="tooltip">
                    <strong class="text-blue-400" data-i18n="skills.overdrive.name">Overdrive</strong> <span class="text-slate-400">[Q]</span><br>
                    <span data-i18n="skills.overdrive.desc">Speed x3 for 5s.</span>
                </div>
            </button>
            <button id="skill-nuke" class="skill-btn relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-red-500 transition shadow-lg group overflow-hidden" data-skill="nuke" aria-label="Meteor skill (Press W) - Massive area damage" role="button">
                <div class="absolute inset-0 flex items-center justify-center text-3xl" aria-hidden="true">‚òÑÔ∏è</div>
                <div class="skill-hotkey absolute top-0 left-0 bg-red-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-br-lg" aria-hidden="true">W</div>
                <div id="cd-nuke" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0" aria-hidden="true"></div>
                <div class="skill-tooltip absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-red-500 pointer-events-none whitespace-nowrap left-1/2 -translate-x-1/2" role="tooltip">
                    <strong class="text-red-400" data-i18n="skills.nuke.name">Meteor</strong> <span class="text-slate-400">[W]</span><br>
                    <span data-i18n="skills.nuke.desc">Massive area damage.</span>
                </div>
            </button>
            <button id="skill-blackhole" class="skill-btn relative w-16 h-16 bg-slate-900/90 border-2 border-slate-600 rounded-xl cursor-pointer hover:border-purple-500 transition shadow-lg group overflow-hidden" data-skill="blackhole" aria-label="Black Hole skill (Press E) - Pulls and crushes enemies" role="button">
                <div class="absolute inset-0 flex items-center justify-center text-3xl" aria-hidden="true">üåÄ</div>
                <div class="skill-hotkey absolute top-0 left-0 bg-purple-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-br-lg" aria-hidden="true">E</div>
                <div id="cd-blackhole" class="cooldown-overlay absolute bottom-0 left-0 w-full bg-black/80 h-0" aria-hidden="true"></div>
                <div class="skill-tooltip absolute bottom-full mb-2 hidden group-hover:block w-48 bg-black/90 text-xs p-2 rounded border border-purple-500 pointer-events-none whitespace-nowrap left-1/2 -translate-x-1/2" role="tooltip">
                    <strong class="text-purple-400" data-i18n="skills.blackhole.name">Black Hole</strong> <span class="text-slate-400">[E]</span><br>
                    <span data-i18n="skills.blackhole.desc">Pulls and crushes enemies.</span>
                </div>
            </button>
        </div>

        <div class="absolute bottom-4 left-4 right-4 md:left-auto md:right-auto md:w-1/2 md:translate-x-1/2 md:left-1/4 flex flex-col gap-1 pointer-events-none z-20">
            <div class="h-2 bg-slate-800 rounded-full border border-slate-600 overflow-hidden relative">
                <div id="ui-shield-bar" class="h-full bg-blue-400 shadow-[0_0_5px_#60a5fa]" style="width: 0%;"></div>
            </div>
            <div class="h-6 bg-slate-800 rounded-full border-2 border-slate-600 overflow-hidden relative shadow-lg">
                <div id="ui-health-bar" class="h-full bg-gradient-to-r from-red-600 to-red-500 transition-all duration-300" style="width: 100%;"></div>
                <div class="absolute inset-0 flex items-center justify-center text-sm font-bold text-white drop-shadow-lg">
                    <span data-i18n="game.hp">HP</span>: <span id="ui-hp-text">100/100</span>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="evo-notification" class="hidden absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-purple-900/90 border-2 border-purple-500 p-6 rounded-xl text-center shadow-[0_0_50px_rgba(168,85,247,0.5)] z-30 evolution-notify pointer-events-none">
            <h2 class="text-3xl font-bold text-white mb-2" data-i18n="notifications.evolution">EVOLUTION!</h2>
            <p class="text-purple-200" data-i18n="notifications.evolutionSub">Higher Tier Reached</p>
        </div>
        <div id="boss-notification" class="hidden absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-900/90 border-2 border-red-500 p-6 rounded-xl text-center shadow-[0_0_50px_rgba(220,38,38,0.5)] z-30 animate-pulse pointer-events-none">
            <h2 class="text-4xl font-bold text-red-500 mb-2">‚ö†Ô∏è <span data-i18n="notifications.bossWarning">BOSS</span> ‚ö†Ô∏è</h2>
            <p class="text-red-200" data-i18n="notifications.bossWarningSub">Prepare your defenses!</p>
        </div>
        <div id="loot-container" class="absolute inset-0 pointer-events-none z-30 overflow-hidden" aria-live="polite" aria-atomic="false"></div>

        <!-- MODALS -->
        <!-- Relic Modal -->
        <div id="relic-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="relic-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-yellow-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="relic-modal-title" class="text-2xl text-yellow-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="modals.collection.title">Collection</span>
                        <button type="button" class="help-icon" data-help="collection" aria-label="Help for Collection">?</button>
                    </h2>
                    <button onclick="document.getElementById('relic-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div id="relic-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto">
                    <div class="empty-state col-span-full text-center py-8 text-slate-400">
                        <div class="text-4xl mb-3">üèÜ</div>
                        <div class="text-lg font-medium" data-i18n="emptyStates.relics.title">No relics yet</div>
                        <div class="text-sm mt-1" data-i18n="emptyStates.relics.hint">Defeat bosses to collect powerful relics!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Codex Modal -->
        <div id="codex-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="codex-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-blue-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="codex-modal-title" class="text-2xl text-blue-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="modals.codex.title">Codex</span>
                        <button type="button" class="help-icon" data-help="codex" aria-label="Help for Codex">?</button>
                    </h2>
                    <button onclick="document.getElementById('codex-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div id="codex-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto">
                    <div class="empty-state col-span-full text-center py-8 text-slate-400">
                        <div class="text-4xl mb-3">üìñ</div>
                        <div class="text-lg font-medium" data-i18n="emptyStates.codex.title">No enemies encountered</div>
                        <div class="text-sm mt-1" data-i18n="emptyStates.codex.hint">Start fighting to fill your codex!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Modal -->
        <div id="statistics-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="statistics-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-emerald-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="statistics-modal-title" class="text-2xl text-emerald-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="statistics.title">Statistics</span>
                        <button type="button" class="help-icon" data-help="statistics" aria-label="Help for Statistics">?</button>
                    </h2>
                    <button onclick="document.getElementById('statistics-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div id="statistics-grid" class="p-4 grid grid-cols-1 gap-2 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Mining Modal -->
        <div id="mining-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="mining-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="mining-modal-title" class="text-2xl text-cyan-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="mining.title">Mining</span>
                        <button type="button" class="help-icon" data-help="mining" aria-label="Help for Mining">?</button>
                    </h2>
                    <button onclick="document.getElementById('mining-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 bg-cyan-900/30 p-3 rounded border border-cyan-800 text-center">
                        <div class="text-sm text-cyan-300" data-i18n="mining.slots">Miner Slots</div>
                        <div class="text-2xl font-bold text-white"><span id="mining-slots">0/3</span></div>
                    </div>
                    <div id="mining-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Forge Modal -->
        <div id="forge-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="forge-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-yellow-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="forge-modal-title" class="text-2xl text-yellow-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="forge.title">Relic Forge</span>
                        <button type="button" class="help-icon" data-help="forge" aria-label="Help for Forge">?</button>
                    </h2>
                    <button onclick="document.getElementById('forge-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="forge.desc">Upgrade, reroll, or fuse your relics using mining resources.</div>
                    <div id="forge-recipes" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Research Modal -->
        <div id="research-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="research-modal-title">
            <div class="w-full max-w-4xl bg-slate-800 border border-purple-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="research-modal-title" class="text-2xl text-purple-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="research.title">Research Tree</span>
                        <button type="button" class="help-icon" data-help="research" aria-label="Help for Research">?</button>
                    </h2>
                    <div class="flex items-center gap-4">
                        <span class="text-cyan-400">üíé <span id="research-crystals">0</span></span>
                        <button onclick="document.getElementById('research-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                    </div>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="research.desc">Research permanent upgrades for your turrets and defenses.</div>
                    <div class="mb-4 bg-slate-700/50 p-2 rounded border border-slate-600 text-xs text-slate-400 text-center">
                        <span class="text-purple-400">üí°</span> <span data-i18n="research.tip">Each branch has prerequisites. Complete lower tiers to unlock higher ones!</span>
                    </div>
                    <div id="research-branches" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Challenges Modal -->
        <div id="challenges-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="challenges-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-red-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="challenges-modal-title" class="text-2xl text-red-500 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="modals.challenges.title">Hardcore Mode</span>
                        <button type="button" class="help-icon" data-help="challenges" aria-label="Help for Challenges">?</button>
                    </h2>
                    <button onclick="document.getElementById('challenges-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <!-- Dread Mode Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-purple-400 mb-2" data-i18n="dread.title">Dread Mode</h3>
                        <div class="mb-3 text-xs text-slate-400 text-center" data-i18n="dread.desc">Higher Dread = harder enemies, but more rewards! Select a level below.</div>
                        <div class="dread-selector" id="dread-selector"></div>
                        <div class="dread-info">
                            <div class="dread-info-title" id="dread-info-title"></div>
                            <div class="dread-info-bonus" id="dread-info-bonus"></div>
                            <div class="dread-info-difficulty" id="dread-info-difficulty"></div>
                        </div>
                    </div>

                    <div class="mb-4 bg-purple-900/30 p-3 rounded border border-purple-800 text-center">
                        <div class="text-sm text-purple-300" data-i18n="modals.challenges.darkMatter">Dark Matter</div>
                        <div class="text-2xl font-bold text-white">üåë <span id="dm-total-display">0</span></div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-purple-400 mb-2" data-i18n="modals.challenges.forbiddenResearch">Forbidden Research</h3>
                        <div id="dm-shop-grid" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>
                    <h3 class="text-lg font-bold text-red-400 mb-2" data-i18n="modals.challenges.availableChallenges">Available Challenges</h3>
                    <div id="challenges-list" class="space-y-2"></div>
                    <div class="mt-4 text-center">
                        <button onclick="game.challenges.cancelChallenge()" id="btn-cancel-challenge" class="hidden px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded" data-i18n="modals.challenges.abandon">Abandon challenge</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mastery Modal -->
        <div id="mastery-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="mastery-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="mastery-modal-title" class="text-2xl text-cyan-400 font-bold uppercase" data-i18n="modals.mastery.title">Mastery</h2>
                    <button onclick="document.getElementById('mastery-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4">
                    <div class="text-center mb-4 text-white">
                        <span data-i18n="modals.mastery.points">Points</span>: <span id="mastery-pts-display" class="text-cyan-400 font-bold text-xl">0</span>
                    </div>
                    <div id="mastery-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Achievements Modal -->
        <div id="achieve-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="achieve-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-green-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="achieve-modal-title" class="text-2xl text-green-400 font-bold uppercase" data-i18n="modals.achievements.title">Achievements</h2>
                    <button onclick="document.getElementById('achieve-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="grid grid-cols-2 gap-2 mb-6 text-sm text-slate-300 font-mono bg-black/20 p-2 rounded">
                        <div><span data-i18n="modals.achievements.enemies">Enemies</span>: <span id="stat-kills" class="text-white">0</span></div>
                        <div><span data-i18n="modals.achievements.bosses">Bosses</span>: <span id="stat-bosses" class="text-white">0</span></div>
                        <div><span data-i18n="modals.achievements.gold">Gold</span>: <span id="stat-gold" class="text-white">0</span></div>
                        <div><span data-i18n="modals.achievements.wave">Wave</span>: <span id="stat-wave" class="text-white">0</span></div>
                    </div>
                    <div id="achieve-list" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
            <div class="bg-slate-800 border border-slate-500 p-8 rounded-2xl max-w-md w-full shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="settings-modal-title" class="text-2xl text-white font-bold" data-i18n="modals.settings.title">Settings</h2>
                    <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="space-y-4">
                    <!-- Language Selector -->
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="modals.settings.language">Language</span>
                        <select id="language-select" onchange="game.changeLanguage(this.value)" class="bg-slate-700 text-white border border-slate-600 rounded px-2 py-1 text-sm" aria-label="Language selector">
                            <option value="en">English</option>
                            <option value="fr">Fran√ßais</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="modals.settings.showDamage">Show Damage</span>
                        <label class="relative inline-block w-12 h-6">
                            <input type="checkbox" id="toggle-damage" class="sr-only peer" aria-label="Show damage numbers">
                            <div class="w-12 h-6 bg-slate-600 rounded-full peer peer-checked:bg-cyan-500 transition"></div>
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-6"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="modals.settings.showRange">Show Range</span>
                        <label class="relative inline-block w-12 h-6">
                            <input type="checkbox" id="toggle-range" class="sr-only peer" aria-label="Show turret range">
                            <div class="w-12 h-6 bg-slate-600 rounded-full peer peer-checked:bg-cyan-500 transition"></div>
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-6"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded">
                        <span class="text-sm font-bold text-slate-300" data-i18n="settings.notation.title">Number Notation</span>
                        <select id="setting-notation" class="bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-1.5 focus:ring-cyan-500 focus:border-cyan-500" aria-label="Number notation format">
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1" data-i18n="modals.settings.save">Save</label>
                        <textarea id="save-string" class="w-full h-24 bg-black/50 border border-slate-600 rounded p-2 text-xs text-slate-300 break-all" readonly aria-readonly="true" aria-label="Save data"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="game.exportSave()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-bold" data-i18n="modals.settings.copy">COPY</button>
                        <button onclick="game.importSave()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded text-sm font-bold" data-i18n="modals.settings.import">IMPORT</button>
                    </div>
                    <hr class="border-slate-700 my-4">
                    <button onclick="game.confirmReset()" class="w-full bg-red-900 hover:bg-red-700 text-red-200 py-2 rounded text-sm font-bold border border-red-700" data-i18n="modals.settings.reset">RESET</button>
                    <!-- Keyboard Shortcuts Section -->
                    <hr class="border-slate-700 my-4">
                    <div class="bg-slate-900 p-3 rounded">
                        <h3 class="text-sm font-bold text-slate-300 mb-3" data-i18n="modals.settings.shortcuts.title">Keyboard Shortcuts</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex items-center gap-2">
                                <kbd class="kbd-key">Q</kbd>
                                <span class="text-slate-400" data-i18n="modals.settings.shortcuts.overdrive">Overdrive</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <kbd class="kbd-key">W</kbd>
                                <span class="text-slate-400" data-i18n="modals.settings.shortcuts.nuke">Nuke</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <kbd class="kbd-key">E</kbd>
                                <span class="text-slate-400" data-i18n="modals.settings.shortcuts.blackhole">Black Hole</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <kbd class="kbd-key">P</kbd>
                                <span class="text-slate-400" data-i18n="modals.settings.shortcuts.pause">Pause</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <kbd class="kbd-key">Esc</kbd>
                                <span class="text-slate-400" data-i18n="modals.settings.shortcuts.closeModal">Close Modal</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <kbd class="kbd-key">1-6</kbd>
                                <span class="text-slate-400" data-i18n="modals.settings.shortcuts.speed">Game Speed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Production Modal -->
        <div id="production-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="production-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-orange-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="production-modal-title" class="text-2xl text-orange-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="production.title">Production</span>
                        <button type="button" class="help-icon" data-help="production" aria-label="Help for Production">?</button>
                    </h2>
                    <button onclick="document.getElementById('production-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="production.desc">Build passive resource generators to earn resources over time.</div>
                    <div class="mb-4 bg-slate-700/50 p-2 rounded border border-slate-600 text-xs text-slate-400 text-center">
                        <span class="text-orange-400">üí°</span> <span data-i18n="production.tip">Buildings produce resources even when offline. Upgrade for higher output!</span>
                    </div>
                    <div id="production-summary" class="mb-4 bg-orange-900/30 p-3 rounded border border-orange-800 grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm"></div>
                    <div id="production-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Daily Quests Modal -->
        <div id="quests-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="quests-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-emerald-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="quests-modal-title" class="text-2xl text-emerald-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="quests.title">Daily Quests</span>
                        <button type="button" class="help-icon" data-help="quests" aria-label="Help for Quests">?</button>
                    </h2>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-slate-400" data-i18n="quests.resetIn">Reset in</span>
                        <span id="quests-timer" class="text-emerald-300 font-mono text-sm">--:--:--</span>
                        <button onclick="document.getElementById('quests-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                    </div>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div id="quests-grid" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Prestige Modal -->
        <div id="prestige-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="prestige-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-amber-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="prestige-modal-title" class="text-2xl text-amber-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="prestige.title">Prestige</span>
                        <button type="button" class="help-icon" data-help="prestige" aria-label="Help for Prestige">?</button>
                    </h2>
                    <button onclick="document.getElementById('prestige-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-6 bg-amber-900/30 p-4 rounded border border-amber-800 text-center">
                        <div class="flex justify-around items-center flex-wrap gap-4">
                            <div>
                                <div class="text-sm text-amber-300" data-i18n="prestige.points">Prestige Points</div>
                                <div class="text-3xl font-bold text-white"><span id="prestige-points">0</span> üëë</div>
                            </div>
                            <div>
                                <div class="text-sm text-amber-300" data-i18n="prestige.potential">Potential Gain</div>
                                <div class="text-2xl font-bold text-amber-400">+<span id="prestige-potential">0</span> üëë</div>
                            </div>
                            <div>
                                <div class="text-sm text-amber-300" data-i18n="prestige.total">Total Prestiges</div>
                                <div class="text-xl font-bold text-slate-300"><span id="prestige-total">0</span></div>
                            </div>
                            <div id="wave-skip-display" class="hidden">
                                <div class="text-sm text-cyan-300" data-i18n="prestige.waveSkip">Wave Skip</div>
                                <div class="text-xl font-bold text-cyan-400"><span id="prestige-wave-skip">0</span> üöÄ</div>
                            </div>
                        </div>
                        <button onclick="if(game.prestige.canPrestige()) gameConfirm(game.t('prestige.confirmReset'), () => game.prestige.doPrestige())" id="btn-prestige" class="mt-4 px-8 py-3 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold rounded text-lg transition" data-i18n="prestige.doPrestige">
                            PRESTIGE NOW
                        </button>
                        <div class="text-xs text-slate-400 mt-2" data-i18n="prestige.requirement">Requires Wave 25+</div>
                    </div>

                    <!-- Auto-Prestige Controls -->
                    <div class="mb-6 bg-slate-700/50 p-4 rounded border border-slate-600">
                        <h3 class="text-lg font-bold text-cyan-400 mb-3" data-i18n="prestige.autoTitle">Auto-Prestige</h3>
                        <div class="flex items-center justify-between gap-4 flex-wrap">
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-300" data-i18n="prestige.autoEnable">Enable Auto-Prestige</span>
                                <label class="relative inline-block w-12 h-6">
                                    <input type="checkbox" id="toggle-auto-prestige" class="sr-only peer" aria-label="Enable auto-prestige">
                                    <div class="w-12 h-6 bg-slate-600 rounded-full peer peer-checked:bg-cyan-500 transition"></div>
                                    <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-6"></div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-300" data-i18n="prestige.autoWave">Prestige at Wave</span>
                                <input type="number" id="auto-prestige-wave" min="25" max="1000" value="30" class="w-20 px-2 py-1 bg-slate-800 border border-slate-600 rounded text-center text-cyan-400 font-bold" aria-label="Auto-prestige wave threshold">
                            </div>
                        </div>
                        <div class="text-xs text-slate-400 mt-2" data-i18n="prestige.autoDesc">When enabled, prestige will trigger automatically on game over if wave threshold is reached.</div>
                    </div>

                    <h3 class="text-lg font-bold text-amber-400 mb-3" data-i18n="prestige.upgrades">Prestige Upgrades</h3>
                    <div id="prestige-upgrades-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Chips Modal -->
        <div id="chips-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="chips-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-pink-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="chips-modal-title" class="text-2xl text-pink-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="chips.title">Turret Chips</span>
                        <button type="button" class="help-icon" data-help="chips" aria-label="Help for Chips">?</button>
                    </h2>
                    <button onclick="document.getElementById('chips-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="chips.desc">Equip chips to turrets for bonus effects. Chips drop from bosses.</div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-pink-400 mb-3" data-i18n="chips.inventory">Chip Inventory</h3>
                        <div id="chips-inventory" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div class="empty-state col-span-full text-center py-8 text-slate-400">
                                <div class="text-4xl mb-3">üíé</div>
                                <div class="text-lg font-medium" data-i18n="emptyStates.chips.title">No chips yet</div>
                                <div class="text-sm mt-1" data-i18n="emptyStates.chips.inventory">Chips drop from bosses</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-pink-400 mb-3" data-i18n="chips.equipped">Equipped Chips</h3>
                        <div id="chips-equipped" class="space-y-3">
                            <div class="empty-state col-span-full text-center py-8 text-slate-400">
                                <div class="text-4xl mb-3">üîß</div>
                                <div class="text-lg font-medium" data-i18n="emptyStates.chips.equippedTitle">No chips equipped</div>
                                <div class="text-sm mt-1" data-i18n="emptyStates.chips.equipped">Select a chip from inventory to equip</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Town Modal -->
        <div id="town-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="town-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-teal-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="town-modal-title" class="text-2xl text-teal-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="town.title">Town</span>
                        <button type="button" class="help-icon" data-help="town" aria-label="Help for Town">?</button>
                    </h2>
                    <button onclick="document.getElementById('town-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-6 bg-teal-900/30 p-4 rounded border border-teal-800 text-center">
                        <div class="flex justify-around items-center flex-wrap gap-4">
                            <div>
                                <div class="text-sm text-teal-300" data-i18n="town.currentLevel">Current Level</div>
                                <div class="text-3xl font-bold text-white"><span id="town-level-icon">üè†</span> <span id="town-level">1</span></div>
                            </div>
                            <div>
                                <div class="text-sm text-teal-300" data-i18n="town.xp">Town XP</div>
                                <div class="text-2xl font-bold text-teal-400"><span id="town-xp">0</span></div>
                            </div>
                            <div>
                                <div class="text-sm text-teal-300" data-i18n="town.nextLevel">Next Level</div>
                                <div class="text-xl font-bold text-slate-300"><span id="town-next-xp">100</span> XP</div>
                            </div>
                        </div>
                        <div class="mt-4 w-full bg-slate-700 rounded-full h-3">
                            <div id="town-progress" class="bg-teal-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-teal-400 mb-3" data-i18n="town.unlocks">Unlocked Features</h3>
                    <div id="town-unlocks-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="empty-state col-span-full text-center py-8 text-slate-400">
                            <div class="text-4xl mb-3">üèòÔ∏è</div>
                            <div class="text-lg font-medium" data-i18n="emptyStates.town.title">No features unlocked</div>
                            <div class="text-sm mt-1" data-i18n="emptyStates.town.hint">Level up your town to unlock features!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- School Modal -->
        <div id="school-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="school-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-indigo-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="school-modal-title" class="text-2xl text-indigo-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="school.title">School</span>
                        <button type="button" class="help-icon" data-help="school" aria-label="Help for School">?</button>
                    </h2>
                    <button onclick="document.getElementById('school-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="school.desc">Unlock and upgrade turret types. Costs crystals.</div>
                    <div class="mb-4 text-center">
                        <span class="text-lg text-cyan-400">üíé <span id="school-crystals">0</span></span>
                    </div>
                    <div id="school-turrets-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Office Modal -->
        <div id="office-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="office-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-lime-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="office-modal-title" class="text-2xl text-lime-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="office.title">Office</span>
                        <button type="button" class="help-icon" data-help="office" aria-label="Help for Office">?</button>
                    </h2>
                    <button onclick="document.getElementById('office-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="office.desc">Activate temporary boosts using gems.</div>
                    <div class="mb-3 bg-slate-700/50 p-2 rounded border border-slate-600 text-xs text-slate-400 text-center">
                        <span class="text-lime-400">üí°</span> <span data-i18n="office.tip">Gems are earned from bosses and quests. Boosts stack and persist through runs!</span>
                    </div>
                    <div class="mb-4 text-center">
                        <span class="text-lg text-pink-400">üí† <span id="office-gems">0</span></span>
                    </div>
                    <h3 class="text-lg font-bold text-lime-400 mb-3" data-i18n="office.active">Active Boosts</h3>
                    <div id="office-active-boosts" class="mb-6 space-y-2"></div>
                    <h3 class="text-lg font-bold text-lime-400 mb-3" data-i18n="office.available">Available Boosts</h3>
                    <div id="office-boosts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Awakening Modal -->
        <div id="awakening-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="awakening-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-fuchsia-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="awakening-modal-title" class="text-2xl text-fuchsia-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="awakening.title">Awakening</span>
                        <button type="button" class="help-icon" data-help="awakening" aria-label="Help for Awakening">?</button>
                    </h2>
                    <button onclick="document.getElementById('awakening-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 bg-slate-700/50 p-2 rounded border border-slate-600 text-xs text-slate-400 text-center">
                        <span class="text-fuchsia-400">üí°</span> <span data-i18n="awakening.tip">Awakening permanently boosts your power. Choose bonuses wisely - they persist forever!</span>
                    </div>
                    <div class="mb-6 bg-fuchsia-900/30 p-4 rounded border border-fuchsia-800 text-center">
                        <div id="awakening-status" class="text-xl font-bold text-white mb-2"></div>
                        <div id="awakening-requirement" class="text-sm text-slate-400"></div>
                        <button id="btn-awaken" onclick="game.awakening.awaken(); game.renderAwakeningUI()" class="hidden mt-4 px-8 py-3 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold rounded text-lg transition" data-i18n="awakening.activate">
                            AWAKEN
                        </button>
                    </div>
                    <h3 class="text-lg font-bold text-fuchsia-400 mb-3" data-i18n="awakening.bonuses">Awakening Bonuses</h3>
                    <div id="awakening-bonuses-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Turret Slots Modal -->
        <div id="slots-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="slots-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="slots-modal-title" class="text-2xl text-cyan-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="slots.title">Turret Slot</span>
                        <button type="button" class="help-icon" data-help="turrets" aria-label="Help for Turrets">?</button>
                    </h2>
                    <button onclick="document.getElementById('slots-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="slots.desc">Select a turret to place in this slot.</div>
                    <div class="mb-4 bg-slate-700/50 p-3 rounded border border-slate-600">
                        <div class="text-xs text-slate-400 mb-1" data-i18n="slots.current">Current Turret</div>
                        <div id="slots-current-turret" class="flex items-center justify-between"></div>
                    </div>
                    <h3 class="text-lg font-bold text-cyan-400 mb-3" data-i18n="slots.available">Available Turrets</h3>
                    <div id="slots-turrets-grid" class="grid grid-cols-2 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- Game Modes Modal -->
        <div id="modes-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="modes-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-violet-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="modes-modal-title" class="text-2xl text-violet-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="modes.title">Game Modes</span>
                        <button type="button" class="help-icon" data-help="modes" aria-label="Help for Game Modes">?</button>
                    </h2>
                    <button onclick="document.getElementById('modes-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 bg-violet-900/30 p-3 rounded border border-violet-800 text-center">
                        <div class="text-sm text-violet-300" data-i18n="modes.current">Current Mode</div>
                        <div class="text-2xl font-bold text-white" id="current-mode-display">Standard</div>
                    </div>
                    <div id="modes-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- Campaign Modal -->
        <div id="campaign-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="campaign-modal-title">
            <div class="w-full max-w-3xl bg-slate-800 border border-rose-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="campaign-modal-title" class="text-2xl text-rose-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="campaign.title">Campaign</span>
                        <button type="button" class="help-icon" data-help="campaign" aria-label="Help for Campaign">?</button>
                    </h2>
                    <button onclick="document.getElementById('campaign-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div id="campaign-chapters" class="space-y-6">
                        <div class="empty-state text-center py-8 text-slate-400">
                            <div class="text-4xl mb-3">üó∫Ô∏è</div>
                            <div class="text-lg font-medium" data-i18n="emptyStates.campaign.title">Campaign loading...</div>
                            <div class="text-sm mt-1" data-i18n="emptyStates.campaign.hint">Explore different worlds and challenges!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Modal -->
        <div id="leaderboard-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="leaderboard-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-sky-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="leaderboard-modal-title" class="text-2xl text-sky-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="leaderboard.title">Leaderboards</span>
                        <button type="button" class="help-icon" data-help="leaderboard" aria-label="Help for Leaderboards">?</button>
                    </h2>
                    <button onclick="document.getElementById('leaderboard-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="flex gap-2 mb-4 flex-wrap justify-center">
                        <select id="leaderboard-category" onchange="game.renderLeaderboardUI()" class="bg-slate-700 text-white border border-slate-600 rounded px-3 py-2 text-sm" aria-label="Leaderboard category"></select>
                    </div>
                    <div id="leaderboard-list" class="space-y-2">
                        <div class="empty-state text-center py-8 text-slate-400">
                            <div class="text-4xl mb-3">üèÖ</div>
                            <div class="text-lg font-medium" data-i18n="emptyStates.leaderboard.title">No data available</div>
                            <div class="text-sm mt-1" data-i18n="emptyStates.leaderboard.hint">Play to appear on the leaderboard!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Presets Modal -->
        <div id="presets-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 backdrop-blur-sm p-4 modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="presets-modal-title">
            <div class="w-full max-w-2xl bg-slate-800 border border-stone-600 rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 rounded-t-2xl">
                    <h2 id="presets-modal-title" class="text-2xl text-stone-400 font-bold uppercase flex items-center gap-1">
                        <span data-i18n="presets.title">Build Presets</span>
                    </h2>
                    <button onclick="document.getElementById('presets-modal').classList.add('hidden')" class="modal-close-btn" aria-label="Close">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto">
                    <div class="mb-4 text-sm text-slate-300 text-center" data-i18n="presets.desc">Save and load your turret configurations.</div>
                    <div id="presets-grid" class="space-y-3">
                        <div class="empty-state text-center py-8 text-slate-400">
                            <div class="text-4xl mb-3">üíæ</div>
                            <div class="text-lg font-medium" data-i18n="emptyStates.presets.title">No presets saved</div>
                            <div class="text-sm mt-1" data-i18n="emptyStates.presets.hint">Save your turret configuration for quick loading!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Confirm Modal -->
        <div id="confirm-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-[60] backdrop-blur-sm" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-message">
            <div class="bg-slate-800 border-2 border-amber-500 p-6 rounded-2xl max-w-sm w-full mx-4 shadow-2xl">
                <h2 id="confirm-title" class="text-xl text-amber-400 font-bold mb-3 text-center" data-i18n="confirm.title">Confirm Action</h2>
                <p id="confirm-message" class="text-slate-300 text-center mb-6"></p>
                <div class="flex gap-3">
                    <button id="confirm-cancel" class="flex-1 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded border border-slate-500 transition" data-i18n="confirm.cancel">Cancel</button>
                    <button id="confirm-ok" class="flex-1 py-2 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded border border-amber-400 transition" data-i18n="confirm.ok">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Ascension Modal -->
        <div id="ascension-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="ascension-modal-title">
            <div class="w-[90%] h-[85%] max-w-5xl bg-slate-900 rounded-lg shadow-2xl border border-purple-700 overflow-hidden flex flex-col">
                <div class="ascension-header">
                    <div>
                        <h2 id="ascension-modal-title" class="text-xl font-bold text-white" data-i18n="ascension.title">Ascension</h2>
                        <div class="ascension-currency">
                            <span data-i18n="ascension.currency">Ascension Points</span>: <span id="ascension-points-display">0</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('ascension-modal').classList.add('hidden')" class="modal-close-btn text-slate-400 hover:text-white text-2xl" aria-label="Close">&times;</button>
                </div>
                <div id="ascension-tree" class="ascension-tree-container">
                    <!-- Perk cards generated by JS -->
                </div>
            </div>
        </div>

        <!-- Cloud Save Modal -->
        <div id="modal-cloud" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="cloud-modal-title">
            <div class="cloud-modal-content">
                <div class="cloud-modal-header">
                    <h2 id="cloud-modal-title" class="cloud-modal-title">
                        <span>‚òÅÔ∏è</span>
                        <span data-i18n="cloud.title">Cloud Save</span>
                    </h2>
                    <button onclick="document.getElementById('modal-cloud').classList.add('hidden')" class="modal-close-btn text-slate-400 hover:text-white text-2xl" aria-label="Close">&times;</button>
                </div>

                <!-- Login View -->
                <div id="cloud-login-view" class="cloud-login-view">
                    <div id="cloud-login-error" class="cloud-error hidden"></div>
                    <div class="cloud-input-group">
                        <label for="cloud-username" data-i18n="cloud.username">Username</label>
                        <input type="text" id="cloud-username" autocomplete="username" placeholder="username">
                    </div>
                    <div class="cloud-input-group">
                        <label for="cloud-password" data-i18n="cloud.password">Password</label>
                        <input type="password" id="cloud-password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="cloud-login-actions">
                        <button id="cloud-btn-login" class="cloud-btn-login" data-i18n="cloud.login">Login</button>
                        <div class="cloud-register-link">
                            <span data-i18n="cloud.register">No account? Register</span>
                        </div>
                    </div>
                </div>

                <!-- Dashboard View (hidden by default) -->
                <div id="cloud-dashboard-view" class="cloud-dashboard-view hidden">
                    <div class="cloud-user-info">
                        <span id="cloud-status" class="cloud-status-online">
                            <span id="cloud-status-text" data-i18n="cloud.status.online">Connected as {name}</span>
                        </span>
                    </div>
                    <div class="cloud-sync-info">
                        <span class="cloud-sync-label" data-i18n="cloud.lastSync">Last Cloud Save</span>
                        <span id="cloud-last-sync" class="cloud-sync-time">--</span>
                    </div>
                    <div id="cloud-message" class="cloud-success hidden"></div>
                    <div class="cloud-actions">
                        <button id="cloud-btn-save" class="cloud-btn-action cloud-btn-upload">
                            <span>‚¨ÜÔ∏è</span>
                            <span data-i18n="cloud.actions.forceSave">Force Upload</span>
                        </button>
                        <button id="cloud-btn-load" class="cloud-btn-action cloud-btn-download">
                            <span>‚¨áÔ∏è</span>
                            <span data-i18n="cloud.actions.forceLoad">Force Download</span>
                        </button>
                    </div>
                    <button id="cloud-btn-logout" class="cloud-btn-logout" data-i18n="cloud.logout">Logout</button>
                </div>
            </div>
        </div>

        <!-- Dev Modal -->
        <div id="dev-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="dev-modal-title">
            <div class="bg-red-950 border border-red-600 p-8 rounded-2xl max-w-md text-center shadow-2xl">
                <h2 id="dev-modal-title" class="text-3xl text-red-500 font-bold mb-4" data-i18n="modals.dev.title">DEVELOPER MODE</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="game.dev.addGold(1000000)" class="px-4 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded shadow" data-i18n="modals.dev.addGold">+1M GOLD üí∞</button>
                    <button onclick="game.dev.addEther(10000)" class="px-4 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded shadow" data-i18n="modals.dev.addEther">+10k ETHER üîÆ</button>
                    <button onclick="game.dev.skipWaves(10)" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow" data-i18n="modals.dev.skipWaves">+10 WAVES ‚è©</button>
                    <button onclick="game.dev.resetCooldowns()" class="px-4 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded shadow" data-i18n="modals.dev.resetCooldowns">CD RESET ‚ö°</button>
                    <button onclick="game.castle.heal(99999999)" class="px-4 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow" data-i18n="modals.dev.heal">HEAL ‚ù§Ô∏è</button>
                    <button onclick="document.getElementById('dev-modal').classList.add('hidden')" class="col-span-2 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded mt-4" data-i18n="modals.dev.close">CLOSE</button>
                </div>
            </div>
        </div>

        <!-- Offline Modal -->
        <div id="offline-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) this.classList.add('hidden')" role="dialog" aria-modal="true" aria-labelledby="offline-modal-title">
            <div class="bg-slate-800 border border-yellow-500 p-8 rounded-2xl max-w-md text-center shadow-2xl">
                <h2 id="offline-modal-title" class="text-3xl text-yellow-400 font-bold mb-4" data-i18n="modals.offline.title">Welcome Back</h2>
                <p class="text-slate-300 mb-2" data-i18n="modals.offline.subtitle">Offline Earnings</p>
                <p class="text-slate-400 text-sm mb-4"><span data-i18n="modals.offline.timeAway">Time away</span>: <span id="offline-time" class="text-white">0m</span></p>
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-4">
                    <div class="text-4xl font-bold text-yellow-400">+<span id="offline-gold">0</span> üí∞</div>
                    <div class="text-sm text-slate-400 mt-2">(<span id="offline-rate">0</span>/min)</div>
                </div>
                <div id="offline-bonus" class="hidden bg-purple-900/30 p-3 rounded-lg border border-purple-500/50 mb-4">
                    <div class="text-sm text-purple-300"><span data-i18n="modals.offline.bonusApplied">Bonus applied</span>: <span id="offline-bonus-value" class="text-white font-bold">+0%</span></div>
                    <div class="text-xs text-slate-400 mt-1" data-i18n="modals.offline.bonusSource">From relics, production buildings, and upgrades</div>
                </div>
                <button onclick="document.getElementById('offline-modal').classList.add('hidden')" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg transition" data-i18n="modals.offline.collect">Collect</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="hidden absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-40 backdrop-blur-md overflow-y-auto py-10">
            <div class="w-full max-w-2xl px-4 flex flex-col items-center">
                <h1 class="text-5xl font-bold text-red-500 mb-2 uppercase" data-i18n="modals.gameOver.title">Defeat</h1>
                <p class="text-xl text-slate-300 mb-4">
                    <span data-i18n="modals.gameOver.wave">Wave</span>: <span id="go-wave" class="text-white font-bold">0</span>
                </p>
                <div id="auto-retry-timer" class="text-yellow-400 font-mono text-lg mb-4 hidden">
                    <span data-i18n="modals.gameOver.autoRetryTimer">Auto-Retry</span>: <span id="retry-countdown">3</span>s...
                </div>
                <div class="flex gap-4 mb-8 w-full justify-center">
                    <div class="bg-purple-900/30 border border-purple-500/50 p-4 rounded-xl flex items-center gap-4 flex-1 justify-center">
                        <span class="text-4xl">üîÆ</span>
                        <div>
                            <div class="text-sm text-purple-300 uppercase" data-i18n="modals.gameOver.ether">Ether</div>
                            <div class="text-3xl font-bold text-white">+<span id="go-ether-gain">0</span></div>
                        </div>
                    </div>
                    <div id="go-dm-gain-box" class="hidden bg-black/60 border border-purple-900 p-4 rounded-xl flex items-center gap-4 flex-1 justify-center">
                        <span class="text-4xl">üåë</span>
                        <div>
                            <div class="text-sm text-purple-300 uppercase" data-i18n="modals.gameOver.darkMatter">Matter</div>
                            <div class="text-3xl font-bold text-white">+<span id="go-dm-gain">0</span></div>
                        </div>
                    </div>
                </div>
                <div class="w-full bg-slate-800 rounded-xl border border-slate-700 p-6 shadow-2xl mb-8">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                        <h2 class="text-2xl font-bold text-purple-400 uppercase" data-i18n="modals.gameOver.ancestralShop">Ancestral Shop</h2>
                        <div class="text-xl font-bold text-white bg-purple-900/50 px-3 py-1 rounded">
                            <span data-i18n="modals.gameOver.etherTotal">Ether</span>: <span id="shop-ether-total">0</span> üîÆ
                        </div>
                    </div>
                    <div id="meta-upgrade-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <button onclick="game.manualRestart()" class="px-12 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow transition text-2xl transform hover:scale-105" data-i18n="modals.gameOver.fight">FIGHT</button>
            </div>
        </div>

        <div class="scanlines"></div>
    </div>

    <!-- Laboratory Panel -->
    <div class="h-1/3 md:h-full md:w-1/4 bg-slate-800 border-t md:border-t-0 md:border-l border-slate-700 flex flex-col shadow-2xl z-20" id="lab-panel">
        <!-- Speed & Auto Controls -->
        <div class="p-2 bg-slate-900 border-b border-slate-700 flex items-center justify-between gap-2">
            <div class="flex gap-1" id="lab-speed-controls">
                <button onclick="game.setSpeed(1)" class="speed-btn-lab active" data-speed="1">1x</button>
                <button onclick="game.setSpeed(3)" class="speed-btn-lab" data-speed="3">3x</button>
                <button onclick="game.setSpeed(6)" class="speed-btn-lab" data-speed="6">6x</button>
                <button onclick="game.setSpeed(10)" class="speed-btn-lab" data-speed="10">10x</button>
            </div>
            <div class="flex gap-3 text-xs">
                <label class="flex items-center gap-1 text-slate-400 hover:text-white cursor-pointer" data-i18n-title="hud.tooltips.autoAdvance">
                    <input type="checkbox" id="lab-auto-advance" class="w-3 h-3 accent-cyan-500" onchange="game.toggleAutoAdvance && game.toggleAutoAdvance()" aria-label="Auto-advance to next wave">
                    <span data-i18n="hud.autoAdvance">Auto</span>
                </label>
                <label class="flex items-center gap-1 text-slate-400 hover:text-white cursor-pointer" data-i18n-title="hud.tooltips.autoRetry">
                    <input type="checkbox" id="lab-auto-retry" class="w-3 h-3 accent-cyan-500" onchange="game.toggleAutoRetry && game.toggleAutoRetry()" aria-label="Auto-retry after defeat">
                    <span data-i18n="hud.autoRetry">Retry</span>
                </label>
            </div>
        </div>

        <!-- PRIMARY TAB BAR -->
        <div class="flex border-b border-slate-700 bg-slate-900/50">
            <button onclick="game.switchLabTab('upgrades')" class="lab-primary-tab active" data-tab="upgrades">
                <span aria-hidden="true">‚öîÔ∏è</span> <span data-i18n="lab.primaryTabs.upgrades">Upgrades</span>
            </button>
            <button onclick="game.switchLabTab('stats')" class="lab-primary-tab" data-tab="stats">
                <span aria-hidden="true">üìä</span> <span data-i18n="lab.primaryTabs.stats">Stats</span>
            </button>
            <button onclick="game.switchLabTab('passives')" class="lab-primary-tab" data-tab="passives">
                <span aria-hidden="true">‚≠ê</span> <span data-i18n="lab.primaryTabs.passives">Passives</span>
            </button>
            <button onclick="game.switchLabTab('tech')" class="lab-primary-tab" data-tab="tech">
                <span aria-hidden="true">üî¨</span> <span data-i18n="lab.primaryTabs.tech">Tech</span>
            </button>
        </div>

        <!-- UPGRADES CONTENT (default) -->
        <div id="lab-content-upgrades" class="lab-content flex-grow flex flex-col overflow-hidden">
            <div class="p-2 bg-slate-900/30 border-b border-slate-700">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex gap-1">
                        <button id="tab-0" onclick="game.switchTab(0)" class="tab-btn active" data-i18n="lab.tabs.attack">Attack</button>
                        <button id="tab-1" onclick="game.switchTab(1)" class="tab-btn" data-i18n="lab.tabs.defense">Defense</button>
                        <button id="tab-2" onclick="game.switchTab(2)" class="tab-btn" data-i18n="lab.tabs.tech">Tech</button>
                    </div>
                    <button id="btn-bulk-buy" onclick="game.toggleBulk()" class="text-xs font-bold bg-slate-700 px-2 py-1 rounded border border-slate-600 hover:border-cyan-400 transition">
                        <span data-i18n="lab.bulkBuy">BUY</span>: x1
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto p-3 space-y-3" id="upgrade-list"></div>
        </div>

        <!-- STATS CONTENT -->
        <div id="lab-content-stats" class="lab-content hidden flex-grow flex flex-col overflow-hidden">
            <div class="p-2 bg-amber-900/30 border-b border-amber-800 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-amber-300 font-bold text-sm">SP: <span id="lab-stats-sp" class="text-white">0</span></span>
                </div>
                <span class="text-amber-400 text-xs font-bold">TIER <span id="lab-stats-tier">1</span></span>
            </div>
            <div class="flex-grow overflow-y-auto p-3">
                <div id="lab-stats-grid" class="lab-stats-grid"></div>
                <div class="mt-3 p-3 bg-black/30 rounded-lg border border-amber-800">
                    <div class="text-amber-400 font-bold text-xs uppercase mb-2" data-i18n="stats.summary">Summary</div>
                    <div id="lab-stats-summary" class="grid grid-cols-2 gap-2 text-xs"></div>
                </div>
            </div>
        </div>

        <!-- PASSIVES CONTENT -->
        <div id="lab-content-passives" class="lab-content hidden flex-grow flex flex-col overflow-hidden">
            <div class="lab-passives-header">
                <div class="flex items-center gap-2">
                    <span class="text-cyan-400 font-bold text-sm">üíé <span id="lab-passives-crystals" class="text-white">0</span></span>
                </div>
                <button onclick="game.passives?.refundAll(); game.renderLabPassivesUI();" class="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded border border-slate-600" data-i18n="passives.refund">REFUND</button>
            </div>
            <div class="lab-passives-tabs">
                <button onclick="game.switchLabPassiveTab('offense')" class="lab-passive-tab active" data-tab="offense" data-i18n-title="passives.offense">‚öîÔ∏è</button>
                <button onclick="game.switchLabPassiveTab('defense')" class="lab-passive-tab" data-tab="defense" data-i18n-title="passives.defense">üõ°Ô∏è</button>
                <button onclick="game.switchLabPassiveTab('utility')" class="lab-passive-tab" data-tab="utility" data-i18n-title="passives.utility">‚ö°</button>
                <button onclick="game.switchLabPassiveTab('resources')" class="lab-passive-tab" data-tab="resources" data-i18n-title="passives.resources">üí∞</button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <div id="lab-passives-grid" class="lab-passives-grid"></div>
            </div>
        </div>

        <!-- TECH CONTENT -->
        <div id="lab-content-tech" class="lab-content hidden flex-grow flex flex-col overflow-hidden">
            <div class="p-2 bg-slate-900/50 border-b border-slate-700 flex flex-wrap gap-1 justify-center">
                <button id="lab-tech-sentry" onclick="game.selectTechSpecial('sentry')" class="text-xs px-2 py-1 bg-cyan-900/50 border border-cyan-700 rounded text-cyan-400 hover:bg-cyan-800/50" data-i18n-title="tech.sentry.tooltip">üî´ SENTRY</button>
                <button id="lab-tech-rocket" onclick="game.selectTechSpecial('rocket')" class="text-xs px-2 py-1 bg-slate-700/50 border border-slate-600 rounded text-slate-500 opacity-60 cursor-not-allowed" data-i18n-title="tech.unlockHint">üîí ROCKET</button>
                <button id="lab-tech-laser" onclick="game.selectTechSpecial('laser')" class="text-xs px-2 py-1 bg-slate-700/50 border border-slate-600 rounded text-slate-500 opacity-60 cursor-not-allowed" data-i18n-title="tech.unlockHint">üîí LASER</button>
                <button id="lab-tech-hallow" onclick="game.selectTechSpecial('hallow')" class="text-xs px-2 py-1 bg-slate-700/50 border border-slate-600 rounded text-slate-500 opacity-60 cursor-not-allowed" data-i18n-title="tech.unlockHint">üîí HALLOW</button>
            </div>
            <div class="flex-grow overflow-y-auto p-3">
                <div id="lab-tech-tree" class="lab-tech-tree"></div>
                <div class="mt-3 text-center text-slate-500 text-xs" data-i18n="tech.hint">Max mastery to unlock specials</div>
            </div>
        </div>

        <!-- Lab Footer -->
        <div class="p-2 bg-slate-900 border-t border-slate-700">
            <div id="lab-footer" onclick="game.triggerDevSecret()" class="text-center text-xs text-slate-500 cursor-pointer select-none" data-i18n="lab.footer">Click on Runes for bonuses!</div>
        </div>
    </div>

<!-- Toast Notification Container -->
        <div id="toast-container" class="fixed bottom-20 left-1/2 -translate-x-1/2 flex flex-col gap-2 z-50 pointer-events-none"></div>

        <!-- Feature Introduction Modal -->
        <div id="feature-intro-modal" class="hidden absolute inset-0 bg-black/90 flex items-center justify-center z-50 backdrop-blur-sm modal-backdrop" onclick="if(event.target === this) game.closeFeatureIntro()">
            <div class="w-full max-w-md bg-slate-800 border border-cyan-600 rounded-2xl shadow-2xl p-6 text-center">
                <div id="feature-intro-icon" class="text-6xl mb-4"></div>
                <h2 id="feature-intro-title" class="text-2xl text-cyan-400 font-bold mb-2"></h2>
                <p id="feature-intro-desc" class="text-slate-300 mb-4"></p>
                <div id="feature-intro-tips" class="bg-slate-900 rounded p-3 text-sm text-slate-400 mb-4 text-left"></div>
                <button onclick="game.closeFeatureIntro()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded" data-i18n="tutorial.understood">Got it!</button>
            </div>
        </div>

<script type="module" src="js/main.js?v=46"></script>
</body>
</html>
